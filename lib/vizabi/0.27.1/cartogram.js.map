{"version":3,"sources":["webpack:///cartogram.js","webpack:///webpack/bootstrap 06dd11ae678ab6abc844","webpack:///./src/index.js","webpack:///./src/component.js","webpack:///./src/helpers/cartogram.js","webpack:///./src/template.html"],"names":["modules","__webpack_require__","moduleId","installedModules","exports","module","i","l","call","m","c","value","d","name","getter","o","Object","defineProperty","configurable","enumerable","get","n","__esModule","object","property","prototype","hasOwnProperty","p","s","_component","_component2","obj","default","VERSION_INFO","version","build","Cartogram","Vizabi","Tool","extend","init","placeholder","external_model","this","components","component","model","Component","_super","default_model","state","ui","chart","labels","dragging","lockNonSelected","lockActive","sizeSelectorActive","datawarning","doubtDomain","doubtRange","presentation","versionInfo","_Vizabi","utils","_globals","_Vizabi$helpers","helpers","Labels","d3GeoProjection","topojson","DynamicBackground","_Vizabi$iconset","iconset","iconWarn","warn","iconQuestion","question","CartogramComponent","config","context","template","isMobile","isMobileOrTablet","model_expects","type","_this","model_binds","change:time.value","evt","_readyOnce","calculationQueue","push","time","toString","marker","getFrame","frame","index","indexOf","splice","frameChanged","change:marker.size.extent","path","updateMarkerSizeLimits","updateEntities","change:marker.color.scaleType","updateIndicators","updateEntitityColor","change:marker.size.use","size","use","change:marker.color.palette","change:ui.chart.lockNonSelected","change:marker.select","updateLandOpacity","change:marker.highlight","change:marker.opacitySelectDim","change:marker.opacityRegular","COLOR_LAND_DEFAULT","mapLands","features","topo_features","borderArcs","defaultWidth","defaultHeight","updateEntitiesQueue","cached","projection","capitalize","map","zeroProjection","d3","scale","translate","mapPath","geoPath","cartogram","properties","_labels","CSS_PREFIX","LABELS_CONTAINER_CLASS","LINES_CONTAINER_CLASS","afterPreload","world","geometries","_getKey","topology","geoIdProperty","mapKeys","id","readyOnce","_this2","element","select","graph","mapSvg","labelsContainerCrop","labelsContainer","sTitleEl","cTitleEl","sInfoEl","cInfoEl","dataWarningEl","entityBubbles","tooltip","yearEl","year","setConditions","xAlign","yAlign","bottomOffset","mapGraph","attr","html","showAreas","KEY","entities","getDimension","TIMEDIM","updateUIStrings","on","updateSize","wScale","scaleLinear","domain","range","values","updateTime","updateTitleNumbers","duration","ready","keys","hook_map","reduce","key","iterations","redrawInProgress","shapes","then","response","selectAll","data","enter","append","isTouchDevice","_interact","_mouseover","_mouseout","_click","each","stitchArcs","borders","datum","sScale","getScale","cScale","color","extent","minRadius","Math","max","maxRadius","scaleType","rangePoints","_redrawEntities","length","setTimeout","parse","lockedFrame","size1","size2","geo","area","pow","start","Date","getTime","end","transition","ease","easeLinear","interrupt","style","translator","locale","getTFunction","conceptPropsS","getConceptprops","conceptPropsC","strings","title","S","C","text","parent","findChildByName","markerID","alignX","isRTL","alignY","updateView","toggle","setIcon","updateDoubtOpacity","pin","rect","getBBox","coord","makeAbsoluteContext","farthestViewportElement","x","y","height","toolRect","root","getBoundingClientRect","chartRect","node","setHook","show","setPos","left","hide","opacity","getUTCFullYear","someSelected","time_1","playing","delayAnimations","setText","formatDate","profiles","small","margin","top","right","bottom","infoElHeight","medium","large","presentationProfileChanges","activeProfile","getActiveProfile","parseInt","width","scaleDelta","mapTopOffset","mapLeftOffset","currentNW","bounds","west","north","currentSE","east","south","canvas","preserveAspectRatio","scaleX","abs","scaleY","resize","precision","widthRatio","cTitleBB","classed","warnBB","titleBBox","fitSizeOfTitles","cTitleText","sTitleText","sTitleBB","font","highlightMarker","hovered","isSelected","_setTooltip","clearHighlighted","selectMarker","mobile","formatterC","getTickFormatter","unitC","which","valueC","formatterS","unitS","valueS","tooltipText","label","MN_NAME","mouse","xPos","yPos","xSign","ySign","xOffset","yOffset","offset","contentBBox","OPACITY_REGULAR","opacityRegular","OPACITY_SELECT_DIM","opacitySelectDim","someHighlighted","highlight","isHighlighted","someSelectedAndOpacityZero","someSelectedAndOpacityZero_1","preload","shape_path","assetsPath","_loadShapes","objects","boundaries","mapFeature","feature","mapBounds","mesh","a","b","meshArcs","Promise","resolve","reject","json","error","console","cosArctan","dx","dy","div","sqrt","sinArctan","copy","Array","copyObject","k","arc","points","pop","arcs","log","reverse","line","polygon","geometry","create","coordinates","geometryType","LineString","MultiLineString","Polygon","MultiPolygon","array","t","j","carto","totalValue","calculateObjectsMeta","areas","totalArea","sum","sizeErrorsTot","sizeErrorsNum","calculateMeta","cb","v","desired","radius","PI","mass","sizeError","min","centroid","meta","calculateMetaSequence","defer","len1","i1","out1","tf","transformer","transform","len2","projectedArcs","projectedArcsDeferResolver","projectedArcsDefer","generateTopologySegment","segmentIndex","segmentLength","generateTopologyArcs","totalLength","segment","geom","iterationsDeferResolver","iterationsDefer","resizeSegments","forceReductionFactor","updatePoint","i2","delta","len3","i3","rSquared","distSquared","dist","Fij","updatePointSequence","geoAlbers","arguments","functor","filter","geomsByArc","g","forEach","geoms","ends","p1","p0","dp","flush","fragmentByEnd","fragmentByStart","f","stitchedArcs","fragments","emptyIndex","e","fg","concat","unshift","gf","topo","props","kx","ky","invert"],"mappings":"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","file":"cartogram.js","sourcesContent":["/******/ (function(modules) { // webpackBootstrap\n/******/ \t// The module cache\n/******/ \tvar installedModules = {};\n/******/\n/******/ \t// The require function\n/******/ \tfunction __webpack_require__(moduleId) {\n/******/\n/******/ \t\t// Check if module is in cache\n/******/ \t\tif(installedModules[moduleId]) {\n/******/ \t\t\treturn installedModules[moduleId].exports;\n/******/ \t\t}\n/******/ \t\t// Create a new module (and put it into the cache)\n/******/ \t\tvar module = installedModules[moduleId] = {\n/******/ \t\t\ti: moduleId,\n/******/ \t\t\tl: false,\n/******/ \t\t\texports: {}\n/******/ \t\t};\n/******/\n/******/ \t\t// Execute the module function\n/******/ \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n/******/\n/******/ \t\t// Flag the module as loaded\n/******/ \t\tmodule.l = true;\n/******/\n/******/ \t\t// Return the exports of the module\n/******/ \t\treturn module.exports;\n/******/ \t}\n/******/\n/******/\n/******/ \t// expose the modules object (__webpack_modules__)\n/******/ \t__webpack_require__.m = modules;\n/******/\n/******/ \t// expose the module cache\n/******/ \t__webpack_require__.c = installedModules;\n/******/\n/******/ \t// identity function for calling harmony imports with the correct context\n/******/ \t__webpack_require__.i = function(value) { return value; };\n/******/\n/******/ \t// define getter function for harmony exports\n/******/ \t__webpack_require__.d = function(exports, name, getter) {\n/******/ \t\tif(!__webpack_require__.o(exports, name)) {\n/******/ \t\t\tObject.defineProperty(exports, name, {\n/******/ \t\t\t\tconfigurable: false,\n/******/ \t\t\t\tenumerable: true,\n/******/ \t\t\t\tget: getter\n/******/ \t\t\t});\n/******/ \t\t}\n/******/ \t};\n/******/\n/******/ \t// getDefaultExport function for compatibility with non-harmony modules\n/******/ \t__webpack_require__.n = function(module) {\n/******/ \t\tvar getter = module && module.__esModule ?\n/******/ \t\t\tfunction getDefault() { return module['default']; } :\n/******/ \t\t\tfunction getModuleExports() { return module; };\n/******/ \t\t__webpack_require__.d(getter, 'a', getter);\n/******/ \t\treturn getter;\n/******/ \t};\n/******/\n/******/ \t// Object.prototype.hasOwnProperty.call\n/******/ \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n/******/\n/******/ \t// __webpack_public_path__\n/******/ \t__webpack_require__.p = \"\";\n/******/\n/******/ \t// Load entry module and return exports\n/******/ \treturn __webpack_require__(__webpack_require__.s = 5);\n/******/ })\n/************************************************************************/\n/******/ ([\n/* 0 */\n/***/ (function(module, exports, __webpack_require__) {\n\n\"use strict\";\n\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\n__webpack_require__(3);\n\nvar _component = __webpack_require__(1);\n\nvar _component2 = _interopRequireDefault(_component);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nvar VERSION_INFO = { version: \"1.1.10\", build: 1510227828521 };\n\n//CARTOGRAM TOOL\nvar Cartogram = Vizabi.Tool.extend(\"Cartogram\", {\n\n  /**\n   * Initialized the tool\n   * @param {Object} placeholder Placeholder element for the tool\n   * @param {Object} external_model Model as given by the external page\n   */\n  init: function init(placeholder, external_model) {\n\n    this.name = \"cartogram\";\n\n    //specifying components\n    this.components = [{\n      component: _component2.default,\n      placeholder: \".vzb-tool-viz\",\n      model: [\"state.time\", \"state.entities\", \"state.marker\", \"locale\", \"ui\"] //pass models to component\n    }, {\n      component: Vizabi.Component.get(\"timeslider\"),\n      placeholder: \".vzb-tool-timeslider\",\n      model: [\"state.time\", \"state.entities\", \"state.marker\", \"ui\"]\n    }, {\n      component: Vizabi.Component.get(\"dialogs\"),\n      placeholder: \".vzb-tool-dialogs\",\n      model: [\"state\", \"ui\", \"locale\"]\n    }, {\n      component: Vizabi.Component.get(\"buttonlist\"),\n      placeholder: \".vzb-tool-buttonlist\",\n      model: [\"state\", \"ui\", \"locale\"]\n    }, {\n      component: Vizabi.Component.get(\"treemenu\"),\n      placeholder: \".vzb-tool-treemenu\",\n      model: [\"state.marker\", \"state.marker_tags\", \"state.time\", \"locale\"]\n    }, {\n      component: Vizabi.Component.get(\"datawarning\"),\n      placeholder: \".vzb-tool-datawarning\",\n      model: [\"locale\"]\n    }, {\n      component: Vizabi.Component.get(\"datanotes\"),\n      placeholder: \".vzb-tool-datanotes\",\n      model: [\"state.marker\", \"locale\"]\n    }];\n\n    //constructor is the same as any tool\n    this._super(placeholder, external_model);\n  },\n\n\n  default_model: {\n    state: {},\n    ui: {\n      chart: {\n        labels: {\n          dragging: true\n        },\n        lockNonSelected: 0,\n        lockActive: 0,\n        sizeSelectorActive: 0\n      },\n      datawarning: {\n        doubtDomain: [],\n        doubtRange: []\n      },\n      presentation: false\n    }\n  },\n\n  versionInfo: VERSION_INFO\n});\n\nexports.default = Cartogram;\n\n/***/ }),\n/* 1 */\n/***/ (function(module, exports, __webpack_require__) {\n\n\"use strict\";\n\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\n__webpack_require__(2);\n\nvar _Vizabi = Vizabi,\n    globals = _Vizabi._globals,\n    utils = _Vizabi.utils,\n    _Vizabi$helpers = _Vizabi.helpers,\n    Labels = _Vizabi$helpers.labels,\n    d3GeoProjection = _Vizabi$helpers[\"d3.geoProjection\"],\n    topojson = _Vizabi$helpers.topojson,\n    DynamicBackground = _Vizabi$helpers[\"d3.dynamicBackground\"],\n    _Vizabi$iconset = _Vizabi.iconset,\n    iconWarn = _Vizabi$iconset.warn,\n    iconQuestion = _Vizabi$iconset.question;\n\n// BUBBLE MAP CHART COMPONENT\n\nvar CartogramComponent = Vizabi.Component.extend(\"cartogram\", {\n  /**\n   * Initializes the component (Bubble Map Chart).\n   * Executed once before any template is rendered.\n   * @param {Object} config The config passed to the component\n   * @param {Object} context The component's parent\n   */\n  init: function init(config, context) {\n    this.name = \"cartogram\";\n    this.template = __webpack_require__(4);\n\n    this.isMobile = utils.isMobileOrTablet();\n\n    //define expected models for this component\n    this.model_expects = [{\n      name: \"time\",\n      type: \"time\"\n    }, {\n      name: \"entities\",\n      type: \"entities\"\n    }, {\n      name: \"marker\",\n      type: \"marker\"\n    }, {\n      name: \"locale\",\n      type: \"locale\"\n    }, {\n      name: \"ui\",\n      type: \"ui\"\n    }];\n\n    var _this = this;\n    this.model_binds = {\n      \"change:time.value\": function changeTimeValue(evt) {\n        if (!_this._readyOnce) return;\n        if (!_this.calculationQueue) {\n          // collect timestamp that we request\n          _this.calculationQueue = [_this.model.time.value.toString()];\n        } else {\n          _this.calculationQueue.push(_this.model.time.value.toString());\n        }\n        (function (time) {\n          // isolate timestamp\n          _this.model.marker.getFrame(time, function (frame, time) {\n            var index = _this.calculationQueue.indexOf(time.toString()); //\n            if (index == -1) {\n              // we was receive more recent frame before so we pass this frame\n              return;\n            }\n            _this.calculationQueue.splice(0, index + 1); // remove timestamps that added to queue before current timestamp\n            _this.frameChanged(frame, time);\n          });\n        })(_this.model.time.value);\n      },\n      \"change:marker.size.extent\": function changeMarkerSizeExtent(evt, path) {\n        //console.log(\"EVENT change:marker:size:max\");\n        if (!_this._readyOnce) return;\n        _this.updateMarkerSizeLimits();\n        _this.updateEntities();\n      },\n      \"change:marker.color.scaleType\": function changeMarkerColorScaleType(evt, path) {\n        _this.updateIndicators();\n        _this.updateEntitityColor();\n      },\n\n      \"change:marker.size.use\": function changeMarkerSizeUse(evt, path) {\n        _this.model.ui.chart.lockActive = _this.model.marker.size.use != \"constant\";\n      },\n      \"change:marker.color.palette\": function changeMarkerColorPalette(evt, path) {\n        _this.updateEntitityColor();\n      },\n      \"change:ui.chart.lockNonSelected\": function changeUiChartLockNonSelected(evt) {\n        _this.updateEntities(900);\n      },\n      \"change:marker.select\": function changeMarkerSelect() {\n        if (!_this._readyOnce) return;\n        _this.updateLandOpacity();\n      },\n      \"change:marker.highlight\": function changeMarkerHighlight() {\n        if (!_this._readyOnce) return;\n        //console.log(\"EVENT change:entities:highlight\");\n        _this.updateLandOpacity();\n      },\n      \"change:marker.opacitySelectDim\": function changeMarkerOpacitySelectDim() {\n        _this.updateLandOpacity();\n      },\n      \"change:marker.opacityRegular\": function changeMarkerOpacityRegular() {\n        _this.updateLandOpacity();\n      }\n    };\n    //this._selectlist = new Selectlist(this);\n\n    //contructor is the same as any component\n    this._super(config, context);\n\n    _this.COLOR_LAND_DEFAULT = \"#fdfdfd\";\n\n    this.mapLands = null;\n    this.features = null;\n    this.topo_features = null;\n    this.borderArcs = null;\n    this.defaultWidth = 700;\n    this.defaultHeight = 550;\n    this.updateEntitiesQueue = [];\n    d3GeoProjection();\n    this.cached = [];\n\n    var projection = \"geo\" + utils.capitalize(this.model.ui.map.projection);\n\n    this.zeroProjection = d3[projection]().scale(1).translate([0, 0]);\n\n    this.projection = d3[projection]().scale(1).translate([0, 0]);\n\n    this.mapPath = d3.geoPath().projection(this.projection);\n\n    this.cartogram = d3.cartogram().projection(this.projection).properties(function (d) {\n      return d.properties;\n    });\n\n    this._labels = new Labels(this);\n    this._labels.config({\n      CSS_PREFIX: \"vzb-ct\",\n      LABELS_CONTAINER_CLASS: \"vzb-ct-labels\",\n      LINES_CONTAINER_CLASS: \"vzb-ct-lines\"\n    });\n  },\n  afterPreload: function afterPreload() {\n    var _this = this;\n    if (!this.world) utils.warn(\"cartogram afterPreload: missing country shapes \" + this.world);\n    if (!this.geometries) utils.warn(\"cartogram afterPreload: missing country shapes \" + this.geometries);\n  },\n  _getKey: function _getKey(d) {\n    return d.properties[this.model.ui.map.topology.geoIdProperty] && this.mapKeys[d.properties[this.model.ui.map.topology.geoIdProperty]] ? this.mapKeys[d.properties[this.model.ui.map.topology.geoIdProperty]].toString() : d.id.toString();\n  },\n\n  /**\n   * DOM is ready\n   */\n  readyOnce: function readyOnce() {\n    var _this2 = this;\n\n    var _this = this;\n    this.element = d3.select(this.element);\n\n    this.graph = this.element.select(\".vzb-ct-graph\");\n    this.mapSvg = this.element.select(\".vzb-ct-map-background\");\n\n    this.labelsContainerCrop = this.graph.select(\".vzb-ct-labels-crop\");\n    this.labelsContainer = this.graph.select(\".vzb-ct-labels\");\n\n    this.sTitleEl = this.graph.select(\".vzb-ct-axis-s-title\");\n    this.cTitleEl = this.graph.select(\".vzb-ct-axis-c-title\");\n\n    this.sInfoEl = this.graph.select(\".vzb-ct-axis-s-info\");\n    this.cInfoEl = this.graph.select(\".vzb-ct-axis-c-info\");\n\n    this.dataWarningEl = this.graph.select(\".vzb-data-warning\");\n    this.entityBubbles = null;\n    this.tooltip = this.element.select(\".vzb-ct-tooltip\");\n\n    // year background\n    this.yearEl = this.graph.select(\".vzb-ct-year\");\n    this.year = new DynamicBackground(this.yearEl);\n    this.year.setConditions({ xAlign: \"left\", yAlign: \"bottom\", bottomOffset: 5 });\n\n    this.mapGraph = this.element.select(\".vzb-ct-map-graph\").attr(\"width\", this.defaultWidth).attr(\"height\", this.defaultHeight);\n    this.mapGraph.html(\"\");\n\n    this.showAreas();\n    this.KEY = this.model.entities.getDimension();\n    this.TIMEDIM = this.model.time.getDimension();\n\n    this.updateUIStrings();\n    this.on(\"resize\", function () {\n      return _this2.updateSize();\n    });\n    this.wScale = d3.scaleLinear().domain(this.model.ui.datawarning.doubtDomain).range(this.model.ui.datawarning.doubtRange);\n\n    /*\n    */\n  },\n  frameChanged: function frameChanged(frame, time) {\n    if (time.toString() != this.model.time.value.toString()) return; // frame is outdated\n    if (!frame) return;\n    this.values = frame;\n    this.updateTime();\n    this.updateTitleNumbers();\n    this.updateEntities(this.duration);\n  },\n\n\n  /*\n   * Both model and DOM are ready\n   */\n  ready: function ready() {\n    var _this = this;\n    this.cached = [];\n    this.updateIndicators();\n    this.updateUIStrings();\n    this.updateMarkerSizeLimits();\n    this.updateSize();\n    this.model.marker.getFrame(_this.model.time.value, function (frame, time) {\n      _this.mapKeys = Object.keys(frame.hook_map).reduce(function (obj, key) {\n        obj[frame.hook_map[key]] = key;\n        return obj;\n      }, {});\n      _this.frameChanged(frame, time);\n    });\n  },\n  showAreas: function showAreas() {\n    var _this = this;\n    this.cartogram.iterations(0);\n    this.redrawInProgress = true;\n\n    this.cartogram(this.shapes, this.geometries).then(function (response) {\n      _this.redrawInProgress = false;\n\n      _this.features = _this.topo_features = response.features;\n      _this.mapLands = _this.mapGraph.selectAll(\".land\").data(_this.topo_features).enter().append(\"path\").attr(\"class\", function (d) {\n        return \"land \" + (d.properties[_this.model.ui.map.topology.geoIdProperty] ? d.properties[_this.model.ui.map.topology.geoIdProperty] : d.id);\n      }).attr(\"d\", _this.cartogram.path).on(\"mouseover\", function (d, i) {\n        if (utils.isTouchDevice()) return;\n        _this._interact()._mouseover(d, i);\n      }).on(\"mouseout\", function (d, i) {\n        if (utils.isTouchDevice()) return;\n        _this._interact()._mouseout(d, i);\n      }).on(\"click\", function (d, i) {\n        if (utils.isTouchDevice()) return;\n        _this._interact()._click(d, i);\n      }).each(function (d) {\n        d[_this.KEY] = _this._getKey(d);\n      });\n      if (_this.borderArcs) {\n        var data = _this.cartogram.stitchArcs(response, _this.borderArcs);\n        _this.borders = _this.mapGraph.append(\"path\").datum(data).attr(\"class\", \"boundary\").attr(\"d\", _this.cartogram.path);\n      }\n    });\n  },\n\n\n  /**\n   * Changes labels for indicators\n   */\n  updateIndicators: function updateIndicators() {\n    this.sScale = this.model.marker.size.getScale();\n    this.cScale = this.model.marker.color.getScale();\n  },\n  updateMarkerSizeLimits: function updateMarkerSizeLimits() {\n    var _this = this;\n    var extent = this.model.marker.size.extent || [0, 1];\n    this.minRadius = Math.max(100 * extent[0], 0);\n    this.maxRadius = Math.max(100 * extent[1], 0);\n\n    this.sScale.domain([0, this.sScale.domain()[1]]);\n    if (this.model.marker.size.scaleType !== \"ordinal\") {\n      this.sScale.range([this.minRadius, this.maxRadius]);\n    } else {\n      this.sScale.rangePoints([this.minRadius, this.maxRadius], 0).range();\n    }\n  },\n  _redrawEntities: function _redrawEntities() {\n    var _this = this;\n    if (this.updateEntitiesQueue.length == 0) return;\n    if (this.redrawInProgress) {\n      setTimeout(function () {\n        _this._redrawEntities();\n      }, 100);\n      return;\n    }\n    this.redrawInProgress = true;\n    var time = this.updateEntitiesQueue[this.updateEntitiesQueue.length - 1].time;\n    var duration = this.updateEntitiesQueue[this.updateEntitiesQueue.length - 1].duration;\n    this.updateEntitiesQueue = [];\n    if (this.model.ui.chart.lockNonSelected) {\n      time = this.model.time.parse(\"\" + this.model.ui.chart.lockNonSelected);\n    }\n    this.model.marker.getFrame(time, function (lockedFrame) {\n      var totValue = null;\n      if (_this.model.marker.size.use == \"constant\") {\n        _this.cartogram.iterations(0);\n      } else {\n        _this.cartogram.iterations(8);\n        //var areas = _this.topo_features.map(d3.geo.path().projection(null).area);\n        _this.cartogram.value(function (d) {\n          if (_this.model.ui.chart.lockNonSelected) {\n            var size1 = _this.sScale(lockedFrame.size[_this._getKey(d)]);\n            var size2 = _this.sScale(_this.values.size[_this._getKey(d)]);\n            return d3.geo.path().projection(null).area(d) * Math.pow(size2 / size1, 2);\n          }\n          return _this.sScale(_this.values.size[_this._getKey(d)]);\n        });\n      }\n      var start = new Date().getTime();\n      _this.cartogram(_this.shapes, _this.geometries, totValue).then(function (response) {\n        var end = new Date().getTime();\n        if (duration) {\n          // increale duration for prevent gaps between frames\n          duration = Math.max(duration, end - start);\n        }\n        _this.features = response.features;\n        if (_this.borderArcs) {\n          var data = _this.cartogram.stitchArcs(response, _this.borderArcs);\n          _this.borders.datum(data).transition().duration(duration).ease(d3.easeLinear).attr(\"d\", _this.cartogram.path);\n        }\n        _this.mapLands.data(_this.features).each(function (d) {\n          d[_this.KEY] = _this._getKey(d);\n        });\n        if (duration) {\n          _this.mapLands.interrupt().transition().duration(duration).ease(d3.easeLinear).style(\"fill\", function (d) {\n            return _this.values.color[_this._getKey(d)] != null ? _this.cScale(_this.values.color[_this._getKey(d)]) : _this.COLOR_LAND_DEFAULT;\n          }).attr(\"d\", _this.cartogram.path);\n          if (_this.borderArcs) {\n            _this.borders.interrupt().transition().duration(duration).ease(d3.easeLinear).attr(\"d\", _this.cartogram.path);\n          }\n        } else {\n          _this.borders.attr(\"d\", _this.cartogram.path);\n\n          _this.mapLands.style(\"fill\", function (d) {\n            return _this.values.color[_this._getKey(d)] != null ? _this.cScale(_this.values.color[_this._getKey(d)]) : _this.COLOR_LAND_DEFAULT;\n          }).attr(\"d\", _this.cartogram.path);\n        }\n        _this.updateLandOpacity();\n        _this.redrawInProgress = false;\n        _this._redrawEntities();\n      });\n    });\n  },\n  updateEntities: function updateEntities(duration) {\n    var time = this.model.time.value;\n\n    this.updateEntitiesQueue.push({ time: time, duration: duration });\n    this._redrawEntities();\n  },\n  updateEntitityColor: function updateEntitityColor() {\n    var _this = this;\n    this.mapLands.transition().duration(_this.duration).ease(d3.easeLinear).style(\"fill\", function (d) {\n      return _this.values.color[_this._getKey(d)] != null ? _this.cScale(_this.values.color[_this._getKey(d)]) : _this.COLOR_LAND_DEFAULT;\n    });\n  },\n  updateUIStrings: function updateUIStrings() {\n    var _this = this;\n\n    this.translator = this.model.locale.getTFunction();\n\n    var conceptPropsS = _this.model.marker.size.getConceptprops();\n    var conceptPropsC = _this.model.marker.color.getConceptprops();\n\n    this.strings = {\n      title: {\n        S: conceptPropsS.name,\n        C: conceptPropsC.name\n      }\n    };\n\n    this.sTitleEl.select(\"text\").text(this.translator(\"buttons/size\") + \": \" + this.strings.title.S).on(\"click\", function () {\n      _this.parent.findChildByName(\"gapminder-treemenu\").markerID(\"size\").alignX(_this.model.locale.isRTL() ? \"right\" : \"left\").alignY(\"top\").updateView().toggle();\n    });\n\n    this.cTitleEl.select(\"text\").text(this.translator(\"buttons/color\") + \": \" + this.strings.title.C).on(\"click\", function () {\n      _this.parent.findChildByName(\"gapminder-treemenu\").markerID(\"color\").alignX(_this.model.locale.isRTL() ? \"right\" : \"left\").alignY(\"top\").updateView().toggle();\n    });\n\n    utils.setIcon(this.dataWarningEl, iconWarn).select(\"svg\").attr(\"width\", \"0px\").attr(\"height\", \"0px\");\n    this.dataWarningEl.append(\"text\").attr(\"text-anchor\", \"end\").text(this.translator(\"hints/dataWarning\"));\n\n    this.dataWarningEl.on(\"click\", function () {\n      _this.parent.findChildByName(\"gapminder-datawarning\").toggle();\n    }).on(\"mouseover\", function () {\n      _this.updateDoubtOpacity(1);\n    }).on(\"mouseout\", function () {\n      _this.updateDoubtOpacity();\n    });\n\n    this.sInfoEl.html(iconQuestion).select(\"svg\").attr(\"width\", \"0px\").attr(\"height\", \"0px\");\n\n    //TODO: move away from UI strings, maybe to ready or ready once\n    this.sInfoEl.on(\"click\", function () {\n      _this.parent.findChildByName(\"gapminder-datanotes\").pin();\n    });\n    this.sInfoEl.on(\"mouseover\", function () {\n      var rect = this.getBBox();\n      var coord = utils.makeAbsoluteContext(this, this.farthestViewportElement)(rect.x - 10, rect.y + rect.height + 10);\n      var toolRect = _this.root.element.getBoundingClientRect();\n      var chartRect = _this.element.node().getBoundingClientRect();\n      _this.parent.findChildByName(\"gapminder-datanotes\").setHook(\"size\").show().setPos(coord.x + chartRect.left - toolRect.left, coord.y);\n    });\n    this.sInfoEl.on(\"mouseout\", function () {\n      _this.parent.findChildByName(\"gapminder-datanotes\").hide();\n    });\n\n    this.cInfoEl.html(iconQuestion).select(\"svg\").attr(\"width\", \"0px\").attr(\"height\", \"0px\");\n\n    //TODO: move away from UI strings, maybe to ready or ready once\n    this.cInfoEl.on(\"click\", function () {\n      _this.parent.findChildByName(\"gapminder-datanotes\").pin();\n    });\n    this.cInfoEl.on(\"mouseover\", function () {\n      var rect = this.getBBox();\n      var coord = utils.makeAbsoluteContext(this, this.farthestViewportElement)(rect.x - 10, rect.y + rect.height + 10);\n      var toolRect = _this.root.element.getBoundingClientRect();\n      var chartRect = _this.element.node().getBoundingClientRect();\n      _this.parent.findChildByName(\"gapminder-datanotes\").setHook(\"color\").show().setPos(coord.x + chartRect.left - toolRect.left, coord.y);\n    });\n    this.cInfoEl.on(\"mouseout\", function () {\n      _this.parent.findChildByName(\"gapminder-datanotes\").hide();\n    });\n  },\n  updateDoubtOpacity: function updateDoubtOpacity(opacity) {\n    if (opacity == null) opacity = this.wScale(+this.time.getUTCFullYear().toString());\n    if (this.someSelected) opacity = 1;\n    this.dataWarningEl.style(\"opacity\", opacity);\n  },\n\n\n  /*\n   * UPDATE TIME:\n   * Ideally should only update when time or data changes\n   */\n  updateTime: function updateTime() {\n    var _this = this;\n    this.time_1 = this.time == null ? this.model.time.value : this.time;\n    this.time = this.model.time.value;\n    this.duration = this.model.time.playing && this.time - this.time_1 > 0 ? this.model.time.delayAnimations : 0;\n    this.year.setText(this.model.time.formatDate(this.time), this.duration);\n  },\n\n\n  /**\n   * Executes everytime the container or vizabi is resized\n   * Ideally,it contains only operations related to size\n   */\n  updateSize: function updateSize() {\n    var profiles = {\n      small: {\n        margin: { top: 10, right: 10, left: 10, bottom: 0 },\n        infoElHeight: 16\n      },\n      medium: {\n        margin: { top: 20, right: 20, left: 20, bottom: 30 },\n        infoElHeight: 20\n      },\n      large: {\n        margin: { top: 30, right: 30, left: 30, bottom: 35 },\n        infoElHeight: 22\n      }\n    };\n\n    var presentationProfileChanges = {\n      medium: {\n        infoElHeight: 26\n      },\n      large: {\n        infoElHeight: 32\n      }\n    };\n\n    this.activeProfile = this.getActiveProfile(profiles, presentationProfileChanges);\n    var margin = this.activeProfile.margin;\n    var infoElHeight = this.activeProfile.infoElHeight;\n\n    //stage\n\n    var height = this.height = parseInt(this.element.style(\"height\"), 10) - margin.top - margin.bottom || 0;\n    var width = this.width = parseInt(this.element.style(\"width\"), 10) - margin.left - margin.right || 0;\n\n    if (this.height <= 0 || this.width <= 0) return utils.warn(\"Bubble map updateSize() abort: vizabi container is too little or has display:none\");\n\n    var scaleDelta = 1,\n        mapTopOffset = 0,\n        mapLeftOffset = 0;\n    var currentNW = this.zeroProjection([this.model.ui.map.bounds.west, this.model.ui.map.bounds.north]);\n    var currentSE = this.zeroProjection([this.model.ui.map.bounds.east, this.model.ui.map.bounds.south]);\n    var canvas = [[0, 0], [width, height]];\n    if (this.model.ui.map.preserveAspectRatio) {\n      mapTopOffset = margin.top;\n      mapLeftOffset = margin.left;\n      var scaleX = Math.abs((canvas[1][0] - canvas[0][0]) / (currentSE[0] - currentNW[0]));\n      var scaleY = Math.abs((canvas[1][1] - canvas[0][1]) / (currentSE[1] - currentNW[1]));\n      if (scaleX != scaleY) {\n        if (scaleX > scaleY) {\n          scaleDelta = scaleY;\n          mapLeftOffset += (Math.abs(canvas[1][0] - canvas[0][0]) - Math.abs(scaleDelta * (currentNW[1] - currentSE[1]))) / 2;\n        } else {\n          scaleDelta = scaleX;\n          mapTopOffset += (Math.abs(canvas[1][1] - canvas[0][1]) - Math.abs(scaleDelta * (currentNW[0] - currentSE[0]))) / 2;\n        }\n      }\n    } else {\n      scaleDelta = Math.abs((canvas[1][0] - canvas[0][0]) / (currentSE[0] - currentNW[0]));\n    }\n\n    this.graph.attr(\"transform\", \"translate(\" + margin.left + \",\" + margin.top + \")\");\n\n    this.year.resize(this.width, this.height);\n\n    this.mapSvg.attr(\"width\", width).attr(\"height\", height).attr(\"preserveAspectRatio\", \"xMidYMid\").attr(\"x\", margin.left).attr(\"y\", margin.top).style(\"transform\", \"translate3d(\" + margin.left + \"px,\" + margin.top + \"px,0)\");\n\n    this.projection.translate([canvas[0][0] - currentNW[0] * scaleDelta + mapLeftOffset - margin.left, canvas[0][1] - currentNW[1] * scaleDelta + mapTopOffset - margin.top]).scale(scaleDelta).precision(0.1);\n    this.cartogram.projection(this.projection);\n    this.updateEntities();\n\n    this.year.setConditions({\n      widthRatio: 2 / 10\n    });\n    this.year.resize(this.width, this.height);\n\n    this.cTitleEl.style(\"font-size\", infoElHeight).attr(\"transform\", \"translate(0,\" + margin.top + \")\");\n\n    var cTitleBB = this.cTitleEl.select(\"text\").node().getBBox();\n\n    this.sTitleEl.attr(\"transform\", \"translate(\" + 0 + \",\" + (margin.top + cTitleBB.height) + \")\").classed(\"vzb-hidden\", this.model.marker.size.use == \"constant\");\n\n    var warnBB = this.dataWarningEl.select(\"text\").node().getBBox();\n    this.dataWarningEl.select(\"svg\").attr(\"width\", warnBB.height * 0.75).attr(\"height\", warnBB.height * 0.75).attr(\"x\", -warnBB.width - warnBB.height * 1.2).attr(\"y\", -warnBB.height * 0.65);\n\n    this.dataWarningEl.attr(\"transform\", \"translate(\" + this.width + \",\" + (this.height - warnBB.height * 0.5) + \")\").select(\"text\");\n\n    if (this.sInfoEl.select(\"svg\").node()) {\n      var titleBBox = this.sTitleEl.node().getBBox();\n      var translate = [0, 0]; //d3.transform(this.yTitleEl.attr(\"transform\")).translate;\n\n      this.sInfoEl.select(\"svg\").attr(\"width\", infoElHeight).attr(\"height\", infoElHeight);\n      this.sInfoEl.attr(\"transform\", \"translate(\" + (titleBBox.x + translate[0] + titleBBox.width + infoElHeight * 0.4) + \",\" + (translate[1] - infoElHeight * 0.8) + \")\");\n    }\n\n    this.cInfoEl.classed(\"vzb-hidden\", this.cTitleEl.classed(\"vzb-hidden\"));\n\n    if (!this.cInfoEl.classed(\"vzb-hidden\") && this.cInfoEl.select(\"svg\").node()) {\n      var _titleBBox = this.cTitleEl.node().getBBox();\n      var _translate = [0, 0]; //d3.transform(this.sTitleEl.attr(\"transform\")).translate;\n\n      this.cInfoEl.select(\"svg\").attr(\"width\", infoElHeight).attr(\"height\", infoElHeight);\n      this.cInfoEl.attr(\"transform\", \"translate(\" + (_titleBBox.x + _translate[0] + _titleBBox.width + infoElHeight * 0.4) + \",\" + (_translate[1] - infoElHeight * 0.8) + \")\");\n    }\n  },\n  fitSizeOfTitles: function fitSizeOfTitles() {\n\n    //reset font sizes first to make the measurement consistent\n    var cTitleText = this.cTitleEl.select(\"text\").style(\"font-size\", null);\n    var sTitleText = this.sTitleEl.select(\"text\").style(\"font-size\", null);\n\n    var cTitleBB = cTitleText.node().getBBox();\n    var sTitleBB = this.sTitleEl.classed(\"vzb-hidden\") ? cTitleBB : sTitleText.node().getBBox();\n\n    var font = Math.max(parseInt(cTitleText.style(\"font-size\")), parseInt(sTitleText.style(\"font-size\"))) * this.width / Math.max(cTitleBB.width, sTitleBB.width);\n\n    if (Math.max(cTitleBB.width, sTitleBB.width) > this.width) {\n      cTitleText.style(\"font-size\", font + \"px\");\n      sTitleText.style(\"font-size\", font + \"px\");\n    } else {\n      // Else - reset the font size to default so it won't get stuck\n      cTitleText.style(\"font-size\", null);\n      sTitleText.style(\"font-size\", null);\n    }\n  },\n  _interact: function _interact() {\n    var _this = this;\n\n    return {\n      _mouseover: function _mouseover(d, i) {\n        if (_this.model.time.dragging) return;\n\n        _this.model.marker.highlightMarker(d);\n\n        _this.hovered = d;\n        //put the exact value in the size title\n        _this.updateTitleNumbers();\n        _this.fitSizeOfTitles();\n\n        if (_this.model.marker.isSelected(d)) {\n          // if selected, not show hover tooltip\n          _this._setTooltip();\n        } else {\n          //position tooltip\n          _this._setTooltip(d);\n        }\n      },\n      _mouseout: function _mouseout(d, i) {\n        if (_this.model.time.dragging) return;\n        _this._setTooltip();\n        _this.hovered = null;\n        _this.updateTitleNumbers();\n        _this.fitSizeOfTitles();\n        _this.model.marker.clearHighlighted();\n      },\n      _click: function _click(d, i) {\n        _this.model.marker.selectMarker(d);\n      }\n    };\n  },\n\n\n  // show size number on title when hovered on a bubble\n  updateTitleNumbers: function updateTitleNumbers() {\n    var _this = this;\n\n    var mobile = void 0; // if is mobile device and only one bubble is selected, update the ytitle for the bubble\n    if (_this.isMobile && _this.model.marker.select && _this.model.marker.select.length === 1) {\n      mobile = _this.model.marker.select[0];\n    }\n\n    if (_this.hovered || mobile) {\n      var hovered = _this.hovered || mobile;\n      var formatterC = _this.model.marker.color.getTickFormatter();\n\n      var unitC = _this.translator(\"unit/\" + _this.model.marker.color.which);\n      //suppress unit strings that found no translation (returns same thing as requested)\n      if (unitC === \"unit/\" + _this.model.marker.color.which) unitC = \"\";\n\n      var valueC = _this.values.color[_this._getKey(hovered)];\n      _this.cTitleEl.select(\"text\").text(this.strings.title.C + \": \" + (valueC || valueC === 0 ? formatterC(valueC) + \" \" + unitC : _this.translator(\"hints/nodata\")));\n\n      if (this.model.marker.size.use !== \"constant\") {\n        var formatterS = _this.model.marker.size.getTickFormatter();\n\n        var unitS = _this.translator(\"unit/\" + _this.model.marker.size.which);\n        //suppress unit strings that found no translation (returns same thing as requested)\n        if (unitS === \"unit/\" + _this.model.marker.size.which) unitS = \"\";\n\n        var valueS = _this.values.size[_this._getKey(hovered)];\n        _this.sTitleEl.select(\"text\").text(this.strings.title.S + \": \" + formatterS(valueS) + \" \" + unitS);\n      }\n\n      this.cInfoEl.classed(\"vzb-hidden\", true);\n      this.sInfoEl.classed(\"vzb-hidden\", true);\n    } else {\n      this.cTitleEl.select(\"text\").text(this.strings.title.C);\n      this.sTitleEl.select(\"text\").text(this.strings.title.S);\n\n      this.cInfoEl.classed(\"vzb-hidden\", false);\n      this.sInfoEl.classed(\"vzb-hidden\", false);\n    }\n  },\n  _setTooltip: function _setTooltip(d) {\n    var _this = this;\n    if (d) {\n      var tooltipText = this.values.label[this._getKey(d)] ? this.values.label[this._getKey(d)] : d.properties.MN_NAME;\n      var offset = 10;\n      var mouse = d3.mouse(this.graph.node()).map(function (d) {\n        return parseInt(d);\n      });\n      var x = mouse[0];\n      var y = mouse[1];\n      var xPos = void 0,\n          yPos = void 0,\n          xSign = -1,\n          ySign = -1,\n          xOffset = 0,\n          yOffset = 0;\n\n      if (offset) {\n        xOffset = offset * 0.71; // .71 - sin and cos for 315\n        yOffset = offset * 0.71;\n      }\n      //position tooltip\n      this.tooltip.classed(\"vzb-hidden\", false)\n      //.attr(\"style\", \"left:\" + (mouse[0] + 50) + \"px;top:\" + (mouse[1] + 50) + \"px\")\n      .selectAll(\"text\").text(tooltipText);\n\n      var contentBBox = this.tooltip.select(\"text\").node().getBBox();\n      if (x - xOffset - contentBBox.width < 0) {\n        xSign = 1;\n        x += contentBBox.width + 5; // corrective to the block Radius and text padding\n      } else {\n        x -= 5; // corrective to the block Radius and text padding\n      }\n      if (y - yOffset - contentBBox.height < 0) {\n        ySign = 1;\n        y += contentBBox.height;\n      } else {\n        y -= 11; // corrective to the block Radius and text padding\n      }\n      if (offset) {\n        xPos = x + xOffset * xSign;\n        yPos = y + yOffset * ySign; // 5 and 11 - corrective to the block Radius and text padding\n      } else {\n        xPos = x + xOffset * xSign; // .71 - sin and cos for 315\n        yPos = y + yOffset * ySign; // 5 and 11 - corrective to the block Radius and text padding\n      }\n      this.tooltip.attr(\"transform\", \"translate(\" + (xPos ? xPos : mouse[0]) + \",\" + (yPos ? yPos : mouse[1]) + \")\");\n\n      this.tooltip.select(\"rect\").attr(\"width\", contentBBox.width + 8).attr(\"height\", contentBBox.height * 1.2).attr(\"x\", -contentBBox.width - 4).attr(\"y\", -contentBBox.height * 0.85).attr(\"rx\", contentBBox.height * 0.2).attr(\"ry\", contentBBox.height * 0.2);\n    } else {\n\n      this.tooltip.classed(\"vzb-hidden\", true);\n    }\n  },\n  updateLandOpacity: function updateLandOpacity() {\n    var _this = this;\n    //if(!duration)duration = 0;\n\n    var OPACITY_HIGHLT = 0.8;\n    var OPACITY_HIGHLT_DIM = 0.3;\n    var OPACITY_SELECT = 1.0;\n    var OPACITY_REGULAR = this.model.marker.opacityRegular;\n    var OPACITY_SELECT_DIM = this.model.marker.opacitySelectDim;\n    this.someHighlighted = this.model.marker.highlight.length > 0;\n    this.someSelected = this.model.marker.select.length > 0;\n    this.mapLands.style(\"opacity\", function (d) {\n\n      if (_this.someHighlighted) {\n        //highlight or non-highlight\n        if (_this.model.marker.isHighlighted(d)) return OPACITY_HIGHLT;\n      }\n\n      if (_this.someSelected) {\n        //selected or non-selected\n        return _this.model.marker.isSelected(d) ? OPACITY_SELECT : OPACITY_SELECT_DIM;\n      }\n\n      if (_this.someHighlighted) return OPACITY_HIGHLT_DIM;\n\n      return OPACITY_REGULAR;\n    });\n\n    var someSelectedAndOpacityZero = _this.someSelected && _this.model.marker.opacitySelectDim < 0.01;\n\n    // when pointer events need update...\n    if (someSelectedAndOpacityZero != this.someSelectedAndOpacityZero_1) {\n      this.mapLands.style(\"pointer-events\", function (d) {\n        return !someSelectedAndOpacityZero || _this.model.marker.isSelected(d) ? \"visible\" : \"none\";\n      });\n    }\n\n    this.someSelectedAndOpacityZero_1 = _this.someSelected && _this.model.marker.opacitySelectDim < 0.01;\n  },\n  preload: function preload() {\n    var _this = this;\n    var shape_path = this.model.ui.map.topology.path || this.model.data.assetsPath + \"world-50m.json\";\n\n    var projection = \"geo\" + utils.capitalize(this.model.ui.map.projection);\n\n    this.zeroProjection = d3[projection]();\n    this.zeroProjection.scale(1).translate([0, 0]);\n\n    this.projection = d3[projection]();\n    this.projection.scale(1).translate([0, 0]);\n\n    this.mapPath = d3.geoPath().projection(this.projection);\n\n    this.model.ui.map.scale = 1;\n    return this._loadShapes(shape_path).then(function (shapes) {\n      _this.shapes = shapes;\n      _this.geometries = _this.shapes.objects[_this.model.ui.map.topology.objects.boundaries].geometries;\n      _this.mapFeature = topojson.feature(_this.shapes, _this.shapes.objects[_this.model.ui.map.topology.objects.geo]);\n      _this.mapBounds = _this.mapPath.bounds(_this.mapFeature);\n      _this.boundaries = topojson.mesh(_this.shapes, _this.shapes.objects[_this.model.ui.map.topology.objects.boundaries], function (a, b) {\n        return a !== b;\n      });\n      _this.borderArcs = _this.cartogram.meshArcs(_this.shapes, _this.shapes.objects[_this.model.ui.map.topology.objects.boundaries], function (a, b) {\n        a.properties[_this.model.ui.map.topology.geoIdProperty] && a.properties[_this.model.ui.map.topology.geoIdProperty] !== b.properties[_this.model.ui.map.topology.geoIdProperty];\n      });\n    });\n  },\n  _loadShapes: function _loadShapes(shape_path) {\n    return new Promise(function (resolve, reject) {\n      d3.json(shape_path, function (error, json) {\n        if (error) return console.warn(\"Failed loading json \" + shape_path + \". \" + error);\n        resolve(json);\n      });\n    });\n  }\n});\n\nexports.default = CartogramComponent;\n\n/***/ }),\n/* 2 */\n/***/ (function(module, exports, __webpack_require__) {\n\n\"use strict\";\n\n\nvar _Vizabi = Vizabi,\n    utils = _Vizabi.utils,\n    topojson = _Vizabi.helpers.topojson;\n\n/*\n * d3.cartogram is a d3-friendly implementation of An Algorithm to Construct\n * Continuous Area Cartograms:\n *\n * <http://chrisman.scg.ulaval.ca/G360/dougenik.pdf>\n *\n * It requires topojson to decode TopoJSON-encoded topologies:\n *\n * <http://github.com/mbostock/topojson/>\n *\n * Usage:\n *\n * var cartogram = d3.cartogram()\n *  .projection(d3.geo.albersUsa())\n *  .value(function(d) {\n *    return Math.random() * 100;\n *  });\n * d3.json(\"path/to/topology.json\", function(topology) {\n *  var features = cartogram(topology, topology.objects.OBJECTNAME.geometries);\n *  d3.select(\"svg\").selectAll(\"path\")\n *    .data(features)\n *    .enter()\n *    .append(\"path\")\n *      .attr(\"d\", cartogram.path);\n * });\n */\n\nd3.cartogram = function () {\n\n  function carto(topology, geometries, totalValue) {\n\n    var calculateObjectsMeta = function calculateObjectsMeta(objects, values, path) {\n      return new Promise(function (resolve, reject) {\n        var areas = objects.map(path.area);\n        var totalArea = d3.sum(areas),\n            sizeErrorsTot = 0,\n            sizeErrorsNum = 0;\n\n        var calculateMeta = function calculateMeta(index, cb) {\n          var area = Math.abs(areas[index]),\n              // XXX: why do we have negative areas?\n          v = +values[index],\n              desired = totalArea * v / totalValue,\n              radius = Math.sqrt(area / Math.PI),\n              mass = Math.sqrt(desired / Math.PI) - radius,\n              sizeError = Math.max(area, desired) / Math.min(area, desired);\n          // console.log(o.id, \"@\", j, \"area:\", area, \"value:\", v, \"->\", desired, radius, mass, sizeError);\n          cb({\n            id: objects[index].id,\n            area: area,\n            centroid: path.centroid(objects[index]),\n            value: v,\n            desired: desired,\n            radius: radius,\n            mass: mass,\n            sizeError: sizeError\n          });\n        };\n        var calculateMetaSequence = function calculateMetaSequence(index) {\n          if (index >= objects.length) {\n            return resolve({ meta: meta, sizeError: sizeErrorsTot / sizeErrorsNum });\n          }\n          calculateMeta(index, function (response) {\n            meta.push(response);\n            sizeErrorsTot += response.sizeError;\n            sizeErrorsNum++;\n            if (index % 400 == 0) {\n              utils.defer(function () {\n                calculateMetaSequence(++index);\n              });\n            } else {\n              calculateMetaSequence(++index);\n            }\n          });\n        };\n        var meta = [];\n        calculateMetaSequence(0);\n      });\n    };\n    // copy it first\n    return new Promise(function (resolve, reject) {\n      topology = copy(topology);\n\n      // objects are projected into screen coordinates\n\n      // project the arcs into screen space\n      var tf = transformer(topology.transform),\n          x,\n          y,\n          len1,\n          i1,\n          out1,\n          len2 = topology.arcs.length,\n          i2 = 0,\n          projectedArcs = new Array(len2);\n      var projectedArcsDeferResolver = void 0;\n      var projectedArcsDefer = new Promise(function (resolve, reject) {\n        projectedArcsDeferResolver = resolve;\n      });\n      var generateTopologySegment = function generateTopologySegment(segmentIndex, segmentLength) {\n        return new Promise(function (resolve, reject) {\n          i1 = 0;\n          while (i1 < segmentLength) {\n            topology.arcs[segmentIndex][i1][0] = x += topology.arcs[segmentIndex][i1][0];\n            topology.arcs[segmentIndex][i1][1] = y += topology.arcs[segmentIndex][i1][1];\n            out1[i1] = projection === null ? tf(topology.arcs[segmentIndex][i1]) : projection(tf(topology.arcs[segmentIndex][i1]));\n            i1++;\n          }\n          resolve(out1);\n        });\n      };\n      var generateTopologyArcs = function generateTopologyArcs(index, totalLength) {\n        if (index >= totalLength) {\n          return projectedArcsDeferResolver(projectedArcs);\n        }\n        x = 0;\n        y = 0;\n        len1 = topology.arcs[index].length;\n        i1 = 0;\n        out1 = new Array(len1);\n\n        generateTopologySegment(index, len1).then(function (segment) {\n          projectedArcs[index++] = segment;\n          if (index % 400 == 0) {\n            utils.defer(function () {\n              generateTopologyArcs(index, totalLength);\n            });\n          } else {\n            generateTopologyArcs(index, totalLength);\n          }\n        });\n      };\n      generateTopologyArcs(0, len2);\n\n      projectedArcsDefer.then(function (projectedArcs) {\n        // path with identity projection\n        var path = d3.geoPath().projection(null);\n        var objects = object(projectedArcs, { type: \"GeometryCollection\", geometries: geometries }).geometries.map(function (geom) {\n          return {\n            type: \"Feature\",\n            id: geom.id,\n            properties: properties.call(null, geom, topology),\n            geometry: geom\n          };\n        });\n        var values = objects.map(value);\n        if (!totalValue) {\n          totalValue = d3.sum(values);\n        }\n        // no iterations; just return the features\n        if (iterations <= 0) {\n          resolve({\n            features: objects,\n            arcs: projectedArcs\n          });\n        }\n        var i = 0;\n        var resizeSegments = function resizeSegments(index, iterations) {\n          if (index >= iterations) {\n            return iterationsDeferResolver();\n          }\n          calculateObjectsMeta(objects, values, path).then(function (response) {\n            var forceReductionFactor = 1 / (1 + response.sizeError);\n\n            // console.log(\"meta:\", meta);\n            // console.log(\"  total area:\", totalArea);\n            // console.log(\"  force reduction factor:\", forceReductionFactor, \"mean error:\", sizeError);\n            var delta, centroid, mass, radius, rSquared, dx, dy, distSquared, dist, Fij;\n            var updatePoint = function updatePoint(i2, len2) {\n              var len1, i1, delta, len3, i3, centroid, mass, radius, rSquared, dx, dy, distSquared, dist, Fij;\n              while (i2 < len2) {\n                len1 = projectedArcs[i2].length;\n                i1 = 0;\n                while (i1 < len1) {\n                  // create an array of vectors: [x, y]\n                  delta = [0, 0];\n                  len3 = response.meta.length;\n                  i3 = 0;\n                  while (i3 < len3) {\n                    centroid = response.meta[i3].centroid;\n                    mass = response.meta[i3].mass;\n                    radius = response.meta[i3].radius;\n                    rSquared = radius * radius;\n                    dx = projectedArcs[i2][i1][0] - centroid[0];\n                    dy = projectedArcs[i2][i1][1] - centroid[1];\n                    distSquared = dx * dx + dy * dy;\n                    dist = Math.sqrt(distSquared);\n                    Fij = dist > radius ? mass * radius / dist : mass * (distSquared / rSquared) * (4 - 3 * dist / radius);\n                    delta[0] += Fij * cosArctan(dy, dx);\n                    delta[1] += Fij * sinArctan(dy, dx);\n                    i3++;\n                  }\n                  projectedArcs[i2][i1][0] += delta[0] * forceReductionFactor;\n                  projectedArcs[i2][i1][1] += delta[1] * forceReductionFactor;\n                  i1++;\n                }\n                i2++;\n              }\n            };\n            var updatePointSequence = function updatePointSequence(start) {\n              if (start >= projectedArcs.length) {\n                if (response.sizeError <= 1) {\n                  resizeSegments(iterations, iterations);\n                  return;\n                }\n                utils.defer(function () {\n                  resizeSegments(++index, iterations);\n                });\n                return;\n              }\n              var end = Math.min(start + 400, projectedArcs.length);\n              updatePoint(start, end);\n              utils.defer(function () {\n                updatePointSequence(end);\n              });\n            };\n            updatePointSequence(0);\n            // break if we hit the target size error\n          });\n        };\n        var iterationsDeferResolver = void 0;\n        var iterationsDefer = new Promise(function (resolve, reject) {\n          iterationsDeferResolver = resolve;\n        });\n        resizeSegments(0, iterations);\n        iterationsDefer.then(function () {\n          resolve({\n            features: objects,\n            arcs: projectedArcs\n          });\n        });\n      });\n\n      /*\n       while(i2<len2){\n       x = 0;\n       y = 0;\n       len1 = topology.arcs[i2].length;\n       i1 = 0;\n       out1 = new Array(len1);\n       while(i1<len1){\n       topology.arcs[i2][i1][0] = (x += topology.arcs[i2][i1][0]);\n       topology.arcs[i2][i1][1] = (y += topology.arcs[i2][i1][1]);\n       out1[i1] = projection === null ? tf(topology.arcs[i2][i1]) : projection(tf(topology.arcs[i2][i1]));\n       i1++;\n       }\n       projectedArcs[i2++]=out1;\n        }\n       */\n    });\n  }\n\n  var iterations = 8,\n      projection = d3.geoAlbers(),\n      properties = function properties(id) {\n    return {};\n  },\n      value = function value(d) {\n    return 1;\n  };\n\n  // for convenience\n  carto.path = d3.geoPath().projection(null);\n\n  carto.iterations = function (i) {\n    if (arguments.length) {\n      iterations = i;\n      return carto;\n    } else {\n      return iterations;\n    }\n  };\n\n  carto.value = function (v) {\n    if (arguments.length) {\n      value = d3.functor(v);\n      return carto;\n    } else {\n      return value;\n    }\n  };\n\n  carto.projection = function (p) {\n    if (arguments.length) {\n      projection = p;\n      return carto;\n    } else {\n      return projection;\n    }\n  };\n\n  carto.feature = function (topology, geom) {\n    return {\n      type: \"Feature\",\n      id: geom.id,\n      properties: properties.call(null, geom, topology),\n      geometry: {\n        type: geom.type,\n        coordinates: topojson.feature(topology, geom).geometry.coordinates\n      }\n    };\n  };\n\n  carto.meshArcs = function (topology, o, filter) {\n    var arcs = [];\n\n    function arc(i) {\n      var j = i < 0 ? ~i : i;\n      (geomsByArc[j] || (geomsByArc[j] = [])).push({\n        i: i,\n        g: geom\n      });\n    }\n\n    function line(arcs) {\n      arcs.forEach(arc);\n    }\n\n    function polygon(arcs) {\n      arcs.forEach(line);\n    }\n\n    function geometry(o) {\n      if (o.type === \"GeometryCollection\") o.geometries.forEach(geometry);else if (o.type in geometryType) geom = o, geometryType[o.type](o.arcs);\n    }\n\n    if (arguments.length > 1) {\n      var geomsByArc = [],\n          geom;\n\n      var geometryType = {\n        LineString: line,\n        MultiLineString: polygon,\n        Polygon: polygon,\n        MultiPolygon: function MultiPolygon(arcs) {\n          arcs.forEach(polygon);\n        }\n      };\n\n      geometry(o);\n\n      geomsByArc.forEach(arguments.length < 3 ? function (geoms) {\n        arcs.push(geoms[0].i);\n      } : function (geoms) {\n        if (filter(geoms[0].g, geoms[geoms.length - 1].g)) arcs.push(geoms[0].i);\n      });\n    } else {\n      for (var i = 0, n = topology.arcs.length; i < n; ++i) {\n        arcs.push(i);\n      }\n    }\n\n    return arcs;\n  };\n\n  carto.stitchArcs = function (topology, arcs) {\n    var stitchedArcs = {},\n        fragmentByStart = {},\n        fragmentByEnd = {},\n        fragments = [],\n        emptyIndex = -1;\n\n    // Stitch empty arcs first, since they may be subsumed by other arcs.\n    arcs.forEach(function (i, j) {\n      var arc = topology.arcs[i < 0 ? ~i : i],\n          t;\n      if (arc.length < 3 && !arc[1][0] && !arc[1][1]) {\n        t = arcs[++emptyIndex], arcs[emptyIndex] = i, arcs[j] = t;\n      }\n    });\n\n    arcs.forEach(function (i) {\n      var e = ends(i),\n          start = e[0],\n          end = e[1],\n          f,\n          g;\n\n      if (f = fragmentByEnd[start]) {\n        delete fragmentByEnd[f.end];\n        f.push(i);\n        f.end = end;\n        if (g = fragmentByStart[end]) {\n          delete fragmentByStart[g.start];\n          var fg = g === f ? f : f.concat(g);\n          fragmentByStart[fg.start = f.start] = fragmentByEnd[fg.end = g.end] = fg;\n        } else {\n          fragmentByStart[f.start] = fragmentByEnd[f.end] = f;\n        }\n      } else if (f = fragmentByStart[end]) {\n        delete fragmentByStart[f.start];\n        f.unshift(i);\n        f.start = start;\n        if (g = fragmentByEnd[start]) {\n          delete fragmentByEnd[g.end];\n          var gf = g === f ? f : g.concat(f);\n          fragmentByStart[gf.start = g.start] = fragmentByEnd[gf.end = f.end] = gf;\n        } else {\n          fragmentByStart[f.start] = fragmentByEnd[f.end] = f;\n        }\n      } else {\n        f = [i];\n        fragmentByStart[f.start = start] = fragmentByEnd[f.end = end] = f;\n      }\n    });\n\n    function ends(i) {\n      var arc = topology.arcs[i < 0 ? ~i : i],\n          p0 = arc[0],\n          p1;\n      if (topology.transform) p1 = [0, 0], arc.forEach(function (dp) {\n        p1[0] += dp[0], p1[1] += dp[1];\n      });else p1 = arc[arc.length - 1];\n      return i < 0 ? [p1, p0] : [p0, p1];\n    }\n\n    function flush(fragmentByEnd, fragmentByStart) {\n      for (var k in fragmentByEnd) {\n        var f = fragmentByEnd[k];\n        delete fragmentByStart[f.start];\n        delete f.start;\n        delete f.end;\n        f.forEach(function (i) {\n          stitchedArcs[i < 0 ? ~i : i] = 1;\n        });\n        fragments.push(f);\n      }\n    }\n\n    flush(fragmentByEnd, fragmentByStart);\n    flush(fragmentByStart, fragmentByEnd);\n    arcs.forEach(function (i) {\n      if (!stitchedArcs[i < 0 ? ~i : i]) fragments.push([i]);\n    });\n\n    return object(topology, {\n      type: \"MultiLineString\",\n      arcs: fragments\n    });\n  };\n\n  carto.features = function (topo, geometries) {\n    return geometries.map(function (f) {\n      return carto.feature(topo, f);\n    });\n  };\n\n  carto.properties = function (props) {\n    if (arguments.length) {\n      properties = d3.functor(props);\n      return carto;\n    } else {\n      return properties;\n    }\n  };\n\n  return carto;\n};\n\nvar transformer = d3.cartogram.transformer = function (tf) {\n  var kx = tf.scale[0],\n      ky = tf.scale[1],\n      dx = tf.translate[0],\n      dy = tf.translate[1];\n\n  function transform(c) {\n    return [c[0] * kx + dx, c[1] * ky + dy];\n  }\n\n  transform.invert = function (c) {\n    return [(c[0] - dx) / kx, (c[1] - dy) / ky];\n  };\n\n  return transform;\n};\n\nfunction angle(a, b) {\n  return Math.atan2(b[1] - a[1], b[0] - a[0]);\n}\n\nfunction distance(a, b) {\n  var dx = b[0] - a[0],\n      dy = b[1] - a[1];\n  return Math.sqrt(dx * dx + dy * dy);\n}\n\nfunction projector(proj) {\n  var types = {\n    Point: proj,\n    LineString: function LineString(coords) {\n      return coords.map(proj);\n    },\n    MultiLineString: function MultiLineString(arcs) {\n      return arcs.map(types.LineString);\n    },\n    Polygon: function Polygon(rings) {\n      return rings.map(types.LineString);\n    },\n    MultiPolygon: function MultiPolygon(rings) {\n      return rings.map(types.Polygon);\n    }\n  };\n  return function (geom) {\n    return types[geom.type](geom.coordinates);\n  };\n}\nfunction cosArctan(dx, dy) {\n  if (dy === 0) return 0;\n  var div = dx / dy;\n  return dy > 0 ? 1 / Math.sqrt(1 + div * div) : -1 / Math.sqrt(1 + div * div);\n}\nfunction sinArctan(dx, dy) {\n  if (dy === 0) return 1;\n  var div = dx / dy;\n  return dy > 0 ? div / Math.sqrt(1 + div * div) : -div / Math.sqrt(1 + div * div);\n}\nfunction copy(o) {\n  return o instanceof Array ? o.map(copy) : typeof o === \"string\" || typeof o === \"number\" ? o : copyObject(o);\n}\n\nfunction copyObject(o) {\n  var obj = {};\n  for (var k in o) {\n    obj[k] = copy(o[k]);\n  }return obj;\n}\n\nfunction object(topology, o) {\n  var arcs = topology.arcs ? topology.arcs : topology;\n  function arc(i, points) {\n    if (points.length) points.pop();\n    if (!arcs[i < 0 ? ~i : i]) {\n      console.log(\"fail\");\n    }\n    for (var a = arcs[i < 0 ? ~i : i], k = 0, n = a.length; k < n; ++k) {\n      points.push(a[k]);\n    }\n    if (i < 0) reverse(points, n);\n  }\n\n  function line(arcs) {\n    var points = [];\n    for (var i = 0, n = arcs.length; i < n; ++i) {\n      arc(arcs[i], points);\n    }return points;\n  }\n\n  function polygon(arcs) {\n    return arcs.map(line);\n  }\n\n  function geometry(o) {\n    o = Object.create(o);\n    o.coordinates = geometryType[o.type](o.arcs);\n    return o;\n  }\n  var geometryType = {\n    LineString: line,\n    MultiLineString: polygon,\n    Polygon: polygon,\n    MultiPolygon: function MultiPolygon(arcs) {\n      return arcs.map(polygon);\n    }\n  };\n\n  return o.type === \"GeometryCollection\" ? (o = Object.create(o), o.geometries = o.geometries.map(geometry), o) : geometry(o);\n}\n\nfunction reverse(array, n) {\n  var t,\n      j = array.length,\n      i = j - n;while (i < --j) {\n    t = array[i], array[i++] = array[j], array[j] = t;\n  }\n}\n\n/***/ }),\n/* 3 */\n/***/ (function(module, exports) {\n\n// removed by extract-text-webpack-plugin\n\n/***/ }),\n/* 4 */\n/***/ (function(module, exports) {\n\nmodule.exports = \"<!--  Component -->\\n<div class=\\\"vzb-cartogram\\\">\\n\\n    <svg class=\\\"vzb-cartogram-svg\\\">\\n        <g class=\\\"vzb-ct-graph\\\">\\n            <g class=\\\"vzb-ct-year\\\"></g>\\n            <svg class=\\\"vzb-ct-map-background vzb-export\\\">\\n                <g class=\\\"vzb-ct-map-graph\\\"></g>\\n            </svg>\\n            <svg class=\\\"vzb-ct-labels-crop\\\">\\n                <g class=\\\"vzb-ct-labels\\\">\\n                    <line class=\\\"vzb-ct-vertical-now\\\"></line>\\n                </g>\\n            </svg>\\n\\n            <g class=\\\"vzb-ct-axis-c-title\\\"><text></text></g>\\n            <g class=\\\"vzb-ct-axis-s-title\\\"><text></text></g>\\n            <g class=\\\"vzb-ct-axis-c-info\\\"></g>\\n            <g class=\\\"vzb-ct-axis-s-info\\\"></g>\\n            <g class=\\\"vzb-ct-tooltip vzb-hidden\\\">\\n                <rect class=\\\"vzb-tooltip-border\\\"></rect>\\n                <text class=\\\"vzb-tooltip-text\\\"></text>\\n\\n            </g>\\n\\n            <g class=\\\"vzb-data-warning vzb-noexport\\\">\\n                <svg></svg>\\n                <text></text>\\n            </g>\\n        </g>\\n    </svg>\\n</div>\\n\";\n\n/***/ }),\n/* 5 */\n/***/ (function(module, exports, __webpack_require__) {\n\nmodule.exports = __webpack_require__(0);\n\n\n/***/ })\n/******/ ]);\n\n\n// WEBPACK FOOTER //\n// cartogram.js"," \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// identity function for calling harmony imports with the correct context\n \t__webpack_require__.i = function(value) { return value; };\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 5);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap 06dd11ae678ab6abc844","import \"./styles.scss\";\nimport component from \"./component\";\n\nconst VERSION_INFO = { version: __VERSION, build: __BUILD };\n\n//CARTOGRAM TOOL\nconst Cartogram = Vizabi.Tool.extend(\"Cartogram\", {\n\n  /**\n   * Initialized the tool\n   * @param {Object} placeholder Placeholder element for the tool\n   * @param {Object} external_model Model as given by the external page\n   */\n  init(placeholder, external_model) {\n\n    this.name = \"cartogram\";\n\n    //specifying components\n    this.components = [{\n      component,\n      placeholder: \".vzb-tool-viz\",\n      model: [\"state.time\", \"state.entities\", \"state.marker\", \"locale\", \"ui\"] //pass models to component\n    }, {\n      component: Vizabi.Component.get(\"timeslider\"),\n      placeholder: \".vzb-tool-timeslider\",\n      model: [\"state.time\", \"state.entities\", \"state.marker\", \"ui\"]\n    }, {\n      component: Vizabi.Component.get(\"dialogs\"),\n      placeholder: \".vzb-tool-dialogs\",\n      model: [\"state\", \"ui\", \"locale\"]\n    }, {\n      component: Vizabi.Component.get(\"buttonlist\"),\n      placeholder: \".vzb-tool-buttonlist\",\n      model: [\"state\", \"ui\", \"locale\"]\n    }, {\n      component: Vizabi.Component.get(\"treemenu\"),\n      placeholder: \".vzb-tool-treemenu\",\n      model: [\"state.marker\", \"state.marker_tags\", \"state.time\", \"locale\"]\n    }, {\n      component: Vizabi.Component.get(\"datawarning\"),\n      placeholder: \".vzb-tool-datawarning\",\n      model: [\"locale\"]\n    }, {\n      component: Vizabi.Component.get(\"datanotes\"),\n      placeholder: \".vzb-tool-datanotes\",\n      model: [\"state.marker\", \"locale\"]\n    }\n    ];\n\n    //constructor is the same as any tool\n    this._super(placeholder, external_model);\n  },\n\n  default_model: {\n    state: { },\n    ui: {\n      chart: {\n        labels: {\n          dragging: true\n        },\n        lockNonSelected: 0,\n        lockActive: 0,\n        sizeSelectorActive: 0\n      },\n      datawarning: {\n        doubtDomain: [],\n        doubtRange: []\n      },\n      presentation: false\n    }\n  },\n\n  versionInfo: VERSION_INFO\n});\n\nexport default Cartogram;\n\n\n\n// WEBPACK FOOTER //\n// ./src/index.js","import \"./helpers/cartogram\";\n\nconst {\n  _globals: globals,\n  utils,\n  helpers: {\n    labels: Labels,\n    \"d3.geoProjection\": d3GeoProjection,\n    topojson,\n    \"d3.dynamicBackground\": DynamicBackground, \n  },\n  iconset: {\n    warn: iconWarn,\n    question: iconQuestion,\n  },\n} = Vizabi;\n\n\n// BUBBLE MAP CHART COMPONENT\nconst CartogramComponent = Vizabi.Component.extend(\"cartogram\", {\n  /**\n   * Initializes the component (Bubble Map Chart).\n   * Executed once before any template is rendered.\n   * @param {Object} config The config passed to the component\n   * @param {Object} context The component's parent\n   */\n  init(config, context) {\n    this.name = \"cartogram\";\n    this.template = require(\"./template.html\");\n\n\n    this.isMobile = utils.isMobileOrTablet();\n\n    //define expected models for this component\n    this.model_expects = [{\n      name: \"time\",\n      type: \"time\"\n    }, {\n      name: \"entities\",\n      type: \"entities\"\n    }, {\n      name: \"marker\",\n      type: \"marker\"\n    }, {\n      name: \"locale\",\n      type: \"locale\"\n    }, {\n      name: \"ui\",\n      type: \"ui\"\n    }];\n\n    const _this = this;\n    this.model_binds = {\n      \"change:time.value\": function(evt) {\n        if (!_this._readyOnce) return;\n        if (!_this.calculationQueue) { // collect timestamp that we request\n          _this.calculationQueue = [_this.model.time.value.toString()];\n        } else {\n          _this.calculationQueue.push(_this.model.time.value.toString());\n        }\n        (function(time) { // isolate timestamp\n          _this.model.marker.getFrame(time, (frame, time) => {\n            const index = _this.calculationQueue.indexOf(time.toString()); //\n          if (index == -1) { // we was receive more recent frame before so we pass this frame\n            return;\n          }\n          _this.calculationQueue.splice(0, index + 1); // remove timestamps that added to queue before current timestamp\n          _this.frameChanged(frame, time);\n        });\n\n        })(_this.model.time.value);\n      },\n      \"change:marker.size.extent\": function(evt, path) {\n        //console.log(\"EVENT change:marker:size:max\");\n        if (!_this._readyOnce) return;\n        _this.updateMarkerSizeLimits();\n        _this.updateEntities();\n      },\n      \"change:marker.color.scaleType\": function(evt, path) {\n        _this.updateIndicators();\n        _this.updateEntitityColor();\n      },\n\n      \"change:marker.size.use\": function(evt, path) {\n        _this.model.ui.chart.lockActive = _this.model.marker.size.use != \"constant\";\n      },\n      \"change:marker.color.palette\": function(evt, path) {\n        _this.updateEntitityColor();\n      },\n      \"change:ui.chart.lockNonSelected\": function(evt) {\n        _this.updateEntities(900);\n      },\n      \"change:marker.select\": function() {\n        if (!_this._readyOnce) return;\n        _this.updateLandOpacity();\n      },\n      \"change:marker.highlight\": function() {\n        if (!_this._readyOnce) return;\n        //console.log(\"EVENT change:entities:highlight\");\n        _this.updateLandOpacity();\n      },\n      \"change:marker.opacitySelectDim\": function() {\n        _this.updateLandOpacity();\n      },\n      \"change:marker.opacityRegular\": function() {\n        _this.updateLandOpacity();\n      },\n    };\n    //this._selectlist = new Selectlist(this);\n\n    //contructor is the same as any component\n    this._super(config, context);\n\n\n    _this.COLOR_LAND_DEFAULT = \"#fdfdfd\";\n\n    this.mapLands = null;\n    this.features = null;\n    this.topo_features = null;\n    this.borderArcs = null;\n    this.defaultWidth = 700;\n    this.defaultHeight = 550;\n    this.updateEntitiesQueue = [];\n    d3GeoProjection();\n    this.cached = [];\n\n    const projection = \"geo\" + utils.capitalize(this.model.ui.map.projection);\n\n    this.zeroProjection = d3[projection]()\n      .scale(1)\n      .translate([0, 0]);\n\n    this.projection = d3[projection]()\n      .scale(1)\n      .translate([0, 0]);\n\n    this.mapPath = d3.geoPath()\n      .projection(this.projection);\n\n    this.cartogram = d3.cartogram()\n        .projection(this.projection)\n        .properties(d => d.properties);\n\n    this._labels = new Labels(this);\n    this._labels.config({\n      CSS_PREFIX: \"vzb-ct\",\n      LABELS_CONTAINER_CLASS: \"vzb-ct-labels\",\n      LINES_CONTAINER_CLASS: \"vzb-ct-lines\"\n    });\n\n  },\n\n  afterPreload() {\n    const _this = this;\n    if (!this.world) utils.warn(\"cartogram afterPreload: missing country shapes \" + this.world);\n    if (!this.geometries) utils.warn(\"cartogram afterPreload: missing country shapes \" + this.geometries);\n  },\n  _getKey(d) {\n    return d.properties[this.model.ui.map.topology.geoIdProperty] &&\n      this.mapKeys[d.properties[this.model.ui.map.topology.geoIdProperty]] ?\n        this.mapKeys[d.properties[this.model.ui.map.topology.geoIdProperty]].toString() : \n        d.id.toString();\n  },\n  /**\n   * DOM is ready\n   */\n  readyOnce() {\n    const _this = this;\n    this.element = d3.select(this.element);\n\n    this.graph = this.element.select(\".vzb-ct-graph\");\n    this.mapSvg = this.element.select(\".vzb-ct-map-background\");\n\n    this.labelsContainerCrop = this.graph.select(\".vzb-ct-labels-crop\");\n    this.labelsContainer = this.graph.select(\".vzb-ct-labels\");\n\n    this.sTitleEl = this.graph.select(\".vzb-ct-axis-s-title\");\n    this.cTitleEl = this.graph.select(\".vzb-ct-axis-c-title\");\n\n    this.sInfoEl = this.graph.select(\".vzb-ct-axis-s-info\");\n    this.cInfoEl = this.graph.select(\".vzb-ct-axis-c-info\");\n\n    this.dataWarningEl = this.graph.select(\".vzb-data-warning\");\n    this.entityBubbles = null;\n    this.tooltip = this.element.select(\".vzb-ct-tooltip\");\n\n    // year background\n    this.yearEl = this.graph.select(\".vzb-ct-year\");\n    this.year = new DynamicBackground(this.yearEl);\n    this.year.setConditions({ xAlign: \"left\", yAlign: \"bottom\", bottomOffset: 5 });\n\n    this.mapGraph = this.element.select(\".vzb-ct-map-graph\")\n      .attr(\"width\", this.defaultWidth)\n      .attr(\"height\", this.defaultHeight);\n    this.mapGraph.html(\"\");\n\n    this.showAreas();\n    this.KEY = this.model.entities.getDimension();\n    this.TIMEDIM = this.model.time.getDimension();\n\n    this.updateUIStrings();\n    this.on(\"resize\", () => this.updateSize());\n    this.wScale = d3.scaleLinear()\n      .domain(this.model.ui.datawarning.doubtDomain)\n      .range(this.model.ui.datawarning.doubtRange);\n\n/*\n*/\n  },\n  \n  \n  frameChanged(frame, time) {\n    if (time.toString() != this.model.time.value.toString()) return; // frame is outdated\n    if (!frame) return;\n    this.values = frame;\n    this.updateTime();\n    this.updateTitleNumbers();\n    this.updateEntities(this.duration);\n  },\n\n  /*\n   * Both model and DOM are ready\n   */\n  ready() {\n    const _this = this;\n    this.cached = [];\n    this.updateIndicators();\n    this.updateUIStrings();\n    this.updateMarkerSizeLimits();\n    this.updateSize();\n    this.model.marker.getFrame(_this.model.time.value, (frame, time) => {\n      _this.mapKeys = Object.keys(frame.hook_map)\n        .reduce((obj, key) => {\n          obj[frame.hook_map[key]] = key;\n          return obj;\n        }, {});\n      _this.frameChanged(frame, time)\n    });\n  },\n\n  showAreas() {\n    const _this = this;\n    this.cartogram.iterations(0);\n    this.redrawInProgress = true;\n\n    this.cartogram(this.shapes, this.geometries).then(response => {\n      _this.redrawInProgress = false;\n\n      _this.features = _this.topo_features = response.features;\n      _this.mapLands = _this.mapGraph.selectAll(\".land\")\n        .data(_this.topo_features)\n        .enter().append(\"path\")\n        .attr(\"class\", d => \"land \" + (d.properties[_this.model.ui.map.topology.geoIdProperty] ?\n          d.properties[_this.model.ui.map.topology.geoIdProperty] :\n          d.id))\n        .attr(\"d\", _this.cartogram.path)\n        .on(\"mouseover\", (d, i) => {\n          if (utils.isTouchDevice()) return;\n          _this._interact()._mouseover(d, i);\n        })\n        .on(\"mouseout\", (d, i) => {\n          if (utils.isTouchDevice()) return;\n          _this._interact()._mouseout(d, i);\n        })\n        .on(\"click\", (d, i) => {\n          if (utils.isTouchDevice()) return;\n          _this._interact()._click(d, i);\n        })\n        .each(d => {\n          d[_this.KEY] = _this._getKey(d);\n        });\n      if (_this.borderArcs) {\n        const data = _this.cartogram.stitchArcs(response, _this.borderArcs);\n        _this.borders = _this.mapGraph.append(\"path\")\n          .datum(data)\n          .attr(\"class\", \"boundary\")\n          .attr(\"d\", _this.cartogram.path);\n      }\n    });\n  },\n\n  /**\n   * Changes labels for indicators\n   */\n  updateIndicators() {\n    this.sScale = this.model.marker.size.getScale();\n    this.cScale = this.model.marker.color.getScale();\n  },\n\n  updateMarkerSizeLimits() {\n    const _this = this;\n    const extent = this.model.marker.size.extent || [0, 1];\n    this.minRadius = Math.max(100 * extent[0], 0);\n    this.maxRadius = Math.max(100 * extent[1], 0);\n\n    this.sScale.domain([0, this.sScale.domain()[1]]);\n    if (this.model.marker.size.scaleType !== \"ordinal\") {\n      this.sScale.range([this.minRadius, this.maxRadius]);\n    } else {\n      this.sScale.rangePoints([this.minRadius, this.maxRadius], 0).range();\n    }\n  },\n\n  _redrawEntities() {\n    const _this = this;\n    if (this.updateEntitiesQueue.length == 0) return;\n    if (this.redrawInProgress) {\n      setTimeout(() => {\n        _this._redrawEntities();\n    }, 100);\n      return;\n    }\n    this.redrawInProgress = true;\n    let time = this.updateEntitiesQueue[this.updateEntitiesQueue.length - 1].time;\n    let duration = this.updateEntitiesQueue[this.updateEntitiesQueue.length - 1].duration;\n    this.updateEntitiesQueue = [];\n    if (this.model.ui.chart.lockNonSelected) {\n      time = this.model.time.parse(\"\" + this.model.ui.chart.lockNonSelected);\n    }\n    this.model.marker.getFrame(time, lockedFrame => {\n      const totValue = null;\n    if (_this.model.marker.size.use == \"constant\") {\n      _this.cartogram.iterations(0);\n    } else {\n      _this.cartogram.iterations(8);\n      //var areas = _this.topo_features.map(d3.geo.path().projection(null).area);\n      _this.cartogram.value(d => {\n        if (_this.model.ui.chart.lockNonSelected) {\n          const size1 = _this.sScale(lockedFrame.size[_this._getKey(d)]);\n          const size2 = _this.sScale(_this.values.size[_this._getKey(d)]);\n          return d3.geo.path().projection(null).area(d) * Math.pow((size2 / size1), 2);\n        }\n        return _this.sScale(_this.values.size[_this._getKey(d)]);\n      });\n    }\n    const start = new Date().getTime();\n    _this.cartogram(_this.shapes, _this.geometries, totValue).then(response => {\n      const end = new Date().getTime();\n      if (duration) { // increale duration for prevent gaps between frames\n        duration = Math.max(duration, end - start);\n      }\n      _this.features = response.features;\n      if (_this.borderArcs) {\n        const data = _this.cartogram.stitchArcs(response, _this.borderArcs);\n        _this.borders.datum(data)\n          .transition()\n          .duration(duration)\n          .ease(d3.easeLinear)\n          .attr(\"d\", _this.cartogram.path);\n      }\n    _this.mapLands.data(_this.features)\n      .each(d => {\n      d[_this.KEY] = _this._getKey(d);\n  });\n      if (duration) {\n        _this.mapLands.interrupt()\n          .transition()\n          .duration(duration)\n          .ease(d3.easeLinear)\n          .style(\"fill\", d => _this.values.color[_this._getKey(d)] != null ? _this.cScale(_this.values.color[_this._getKey(d)]) : _this.COLOR_LAND_DEFAULT)\n          .attr(\"d\", _this.cartogram.path);\n        if (_this.borderArcs) {\n          _this.borders.interrupt()\n            .transition()\n            .duration(duration)\n            .ease(d3.easeLinear)\n            .attr(\"d\", _this.cartogram.path);\n        }\n      } else {\n        _this.borders\n          .attr(\"d\", _this.cartogram.path);\n  \n        _this.mapLands\n          .style(\"fill\", d => _this.values.color[_this._getKey(d)] != null ? _this.cScale(_this.values.color[_this._getKey(d)]) : _this.COLOR_LAND_DEFAULT)\n          .attr(\"d\", _this.cartogram.path);\n      }\n      _this.updateLandOpacity();\n      _this.redrawInProgress = false;\n      _this._redrawEntities();\n    });\n  });\n  },\n\n  updateEntities(duration) {\n    const time = this.model.time.value;\n\n    this.updateEntitiesQueue.push({ time, duration });\n    this._redrawEntities();\n  },\n\n  updateEntitityColor() {\n    const _this = this;\n    this.mapLands.transition()\n      .duration(_this.duration)\n      .ease(d3.easeLinear)\n      .style(\"fill\", d => _this.values.color[_this._getKey(d)] != null ? _this.cScale(_this.values.color[_this._getKey(d)]) : _this.COLOR_LAND_DEFAULT);\n\n  },\n  updateUIStrings() {\n    const _this = this;\n\n    this.translator = this.model.locale.getTFunction();\n\n    const conceptPropsS = _this.model.marker.size.getConceptprops();\n    const conceptPropsC = _this.model.marker.color.getConceptprops();\n\n    this.strings = {\n      title: {\n        S: conceptPropsS.name,\n        C: conceptPropsC.name\n      }\n    };\n\n    this.sTitleEl.select(\"text\")\n      .text(this.translator(\"buttons/size\") + \": \" + this.strings.title.S)\n      .on(\"click\", () => {\n        _this.parent\n          .findChildByName(\"gapminder-treemenu\")\n          .markerID(\"size\")\n          .alignX(_this.model.locale.isRTL() ? \"right\" : \"left\")\n          .alignY(\"top\")\n          .updateView()\n          .toggle();\n      });\n\n    this.cTitleEl.select(\"text\")\n      .text(this.translator(\"buttons/color\") + \": \" + this.strings.title.C)\n      .on(\"click\", () => {\n        _this.parent\n          .findChildByName(\"gapminder-treemenu\")\n          .markerID(\"color\")\n          .alignX(_this.model.locale.isRTL() ? \"right\" : \"left\")\n          .alignY(\"top\")\n          .updateView()\n          .toggle();\n      });\n\n    utils.setIcon(this.dataWarningEl, iconWarn).select(\"svg\").attr(\"width\", \"0px\").attr(\"height\", \"0px\");\n    this.dataWarningEl.append(\"text\")\n      .attr(\"text-anchor\", \"end\")\n      .text(this.translator(\"hints/dataWarning\"));\n\n    this.dataWarningEl\n      .on(\"click\", () => {\n        _this.parent.findChildByName(\"gapminder-datawarning\").toggle();\n      })\n      .on(\"mouseover\", () => {\n        _this.updateDoubtOpacity(1);\n      })\n      .on(\"mouseout\", () => {\n        _this.updateDoubtOpacity();\n      });\n\n    this.sInfoEl\n      .html(iconQuestion)\n      .select(\"svg\").attr(\"width\", \"0px\").attr(\"height\", \"0px\");\n\n    //TODO: move away from UI strings, maybe to ready or ready once\n    this.sInfoEl.on(\"click\", () => {\n      _this.parent.findChildByName(\"gapminder-datanotes\").pin();\n    });\n    this.sInfoEl.on(\"mouseover\", function() {\n      const rect = this.getBBox();\n      const coord = utils.makeAbsoluteContext(this, this.farthestViewportElement)(rect.x - 10, rect.y + rect.height + 10);\n      const toolRect = _this.root.element.getBoundingClientRect();\n      const chartRect = _this.element.node().getBoundingClientRect();\n      _this.parent.findChildByName(\"gapminder-datanotes\").setHook(\"size\").show().setPos(coord.x + chartRect.left - toolRect.left, coord.y);\n    });\n    this.sInfoEl.on(\"mouseout\", () => {\n      _this.parent.findChildByName(\"gapminder-datanotes\").hide();\n    });\n\n    this.cInfoEl\n      .html(iconQuestion)\n      .select(\"svg\").attr(\"width\", \"0px\").attr(\"height\", \"0px\");\n\n    //TODO: move away from UI strings, maybe to ready or ready once\n    this.cInfoEl.on(\"click\", () => {\n      _this.parent.findChildByName(\"gapminder-datanotes\").pin();\n    });\n    this.cInfoEl.on(\"mouseover\", function() {\n      const rect = this.getBBox();\n      const coord = utils.makeAbsoluteContext(this, this.farthestViewportElement)(rect.x - 10, rect.y + rect.height + 10);\n      const toolRect = _this.root.element.getBoundingClientRect();\n      const chartRect = _this.element.node().getBoundingClientRect();\n      _this.parent.findChildByName(\"gapminder-datanotes\").setHook(\"color\").show().setPos(coord.x + chartRect.left - toolRect.left, coord.y);\n    });\n    this.cInfoEl.on(\"mouseout\", () => {\n      _this.parent.findChildByName(\"gapminder-datanotes\").hide();\n    });\n  },\n\n  updateDoubtOpacity(opacity) {\n    if (opacity == null) opacity = this.wScale(+this.time.getUTCFullYear().toString());\n    if (this.someSelected) opacity = 1;\n    this.dataWarningEl.style(\"opacity\", opacity);\n  },\n\n  /*\n   * UPDATE TIME:\n   * Ideally should only update when time or data changes\n   */\n  updateTime() {\n    const _this = this;\n    this.time_1 = this.time == null ? this.model.time.value : this.time;\n    this.time = this.model.time.value;\n    this.duration = this.model.time.playing && (this.time - this.time_1 > 0) ? this.model.time.delayAnimations : 0;\n    this.year.setText(this.model.time.formatDate(this.time), this.duration);\n  },\n\n\n  /**\n   * Executes everytime the container or vizabi is resized\n   * Ideally,it contains only operations related to size\n   */\n  updateSize() {\n    const profiles = {\n      small: {\n        margin: { top: 10, right: 10, left: 10, bottom: 0 },\n        infoElHeight: 16,\n      },\n      medium: {\n        margin: { top: 20, right: 20, left: 20, bottom: 30 },\n        infoElHeight: 20,\n      },\n      large: {\n        margin: { top: 30, right: 30, left: 30, bottom: 35 },\n        infoElHeight: 22,\n      }\n    };\n\n    const presentationProfileChanges = {\n      medium: {\n        infoElHeight: 26\n      },\n      large: {\n        infoElHeight: 32\n      }\n    };\n\n    this.activeProfile = this.getActiveProfile(profiles, presentationProfileChanges);\n    const { margin } = this.activeProfile;\n    const { infoElHeight } = this.activeProfile;\n\n    //stage\n    const height = this.height = (parseInt(this.element.style(\"height\"), 10) - margin.top - margin.bottom) || 0;\n    const width = this.width = (parseInt(this.element.style(\"width\"), 10) - margin.left - margin.right) || 0;\n\n    if (this.height <= 0 || this.width <= 0) return utils.warn(\"Bubble map updateSize() abort: vizabi container is too little or has display:none\");\n\n\n    let scaleDelta = 1, mapTopOffset = 0, mapLeftOffset = 0;\n    const currentNW = this.zeroProjection([\n      this.model.ui.map.bounds.west,\n      this.model.ui.map.bounds.north\n    ]);\n    const currentSE = this.zeroProjection([\n      this.model.ui.map.bounds.east,\n      this.model.ui.map.bounds.south\n    ]);\n    const canvas = [\n      [0, 0],\n      [width, height]\n    ];\n    if (this.model.ui.map.preserveAspectRatio) {\n      mapTopOffset =  margin.top;\n      mapLeftOffset =  margin.left;\n      const scaleX = Math.abs((canvas[1][0] - canvas[0][0]) / (currentSE[0] - currentNW[0]));\n      const scaleY = Math.abs((canvas[1][1] - canvas[0][1]) / (currentSE[1] - currentNW[1]));\n      if (scaleX != scaleY) {\n        if (scaleX > scaleY) {\n          scaleDelta = scaleY;\n          mapLeftOffset += (Math.abs(canvas[1][0] - canvas[0][0]) - Math.abs(scaleDelta * (currentNW[1] - currentSE[1]))) / 2;\n        } else {\n          scaleDelta = scaleX;\n          mapTopOffset += (Math.abs(canvas[1][1] - canvas[0][1]) - Math.abs(scaleDelta * (currentNW[0] - currentSE[0]))) / 2;\n        }\n      }\n    } else {\n      scaleDelta = Math.abs((canvas[1][0] - canvas[0][0]) / (currentSE[0] - currentNW[0]));\n    }\n\n    this.graph\n      .attr(\"transform\", \"translate(\" + margin.left + \",\" + margin.top + \")\");\n\n    this.year.resize(this.width, this.height);\n\n    this.mapSvg\n      .attr(\"width\", width)\n      .attr(\"height\", height)\n      .attr(\"preserveAspectRatio\", \"xMidYMid\")\n      .attr(\"x\", margin.left)\n      .attr(\"y\", margin.top)\n      .style(\"transform\", \"translate3d(\" + margin.left + \"px,\" + margin.top + \"px,0)\");\n\n    this.projection\n      .translate([canvas[0][0] - (currentNW[0] * scaleDelta) + mapLeftOffset - margin.left, canvas[0][1] - (currentNW[1] * scaleDelta) + mapTopOffset - margin.top])\n      .scale(scaleDelta)\n      .precision(0.1);\n    this.cartogram.projection(this.projection);\n    this.updateEntities();\n\n    this.year.setConditions({\n      widthRatio: 2 / 10\n    });\n    this.year.resize(this.width, this.height);\n    \n    this.cTitleEl\n      .style(\"font-size\", infoElHeight)\n      .attr(\"transform\", \"translate(0,\" + margin.top + \")\");\n\n    const cTitleBB = this.cTitleEl.select(\"text\").node().getBBox();\n\n    this.sTitleEl.attr(\"transform\", \"translate(\" + 0 + \",\" + (margin.top + cTitleBB.height) + \")\")\n      .classed(\"vzb-hidden\", this.model.marker.size.use == \"constant\");\n\n    const warnBB = this.dataWarningEl.select(\"text\").node().getBBox();\n    this.dataWarningEl.select(\"svg\")\n      .attr(\"width\", warnBB.height * 0.75)\n      .attr(\"height\", warnBB.height * 0.75)\n      .attr(\"x\", -warnBB.width - warnBB.height * 1.2)\n      .attr(\"y\", -warnBB.height * 0.65);\n\n    this.dataWarningEl\n      .attr(\"transform\", \"translate(\" + (this.width) + \",\" + (this.height - warnBB.height * 0.5) + \")\")\n      .select(\"text\");\n\n    if (this.sInfoEl.select(\"svg\").node()) {\n      const titleBBox = this.sTitleEl.node().getBBox();\n      const translate = [0, 0];//d3.transform(this.yTitleEl.attr(\"transform\")).translate;\n\n      this.sInfoEl.select(\"svg\")\n        .attr(\"width\", infoElHeight)\n        .attr(\"height\", infoElHeight);\n      this.sInfoEl.attr(\"transform\", \"translate(\"\n        + (titleBBox.x + translate[0] + titleBBox.width + infoElHeight * 0.4) + \",\"\n        + (translate[1] - infoElHeight * 0.8) + \")\");\n    }\n\n    this.cInfoEl.classed(\"vzb-hidden\", this.cTitleEl.classed(\"vzb-hidden\"));\n\n    if (!this.cInfoEl.classed(\"vzb-hidden\") && this.cInfoEl.select(\"svg\").node()) {\n      const titleBBox = this.cTitleEl.node().getBBox();\n      const translate = [0, 0];//d3.transform(this.sTitleEl.attr(\"transform\")).translate;\n\n      this.cInfoEl.select(\"svg\")\n        .attr(\"width\", infoElHeight)\n        .attr(\"height\", infoElHeight);\n      this.cInfoEl.attr(\"transform\", \"translate(\"\n        + (titleBBox.x + translate[0] + titleBBox.width + infoElHeight * 0.4) + \",\"\n        + (translate[1] - infoElHeight * 0.8) + \")\");\n    }\n  },\n\n  fitSizeOfTitles() {\n\n    //reset font sizes first to make the measurement consistent\n    const cTitleText = this.cTitleEl.select(\"text\")\n      .style(\"font-size\", null);\n    const sTitleText = this.sTitleEl.select(\"text\")\n      .style(\"font-size\", null);\n\n\n    const cTitleBB = cTitleText.node().getBBox();\n    const sTitleBB = this.sTitleEl.classed(\"vzb-hidden\") ? cTitleBB : sTitleText.node().getBBox();\n\n    const font =\n      Math.max(parseInt(cTitleText.style(\"font-size\")), parseInt(sTitleText.style(\"font-size\")))\n      * this.width / Math.max(cTitleBB.width, sTitleBB.width);\n\n    if (Math.max(cTitleBB.width, sTitleBB.width) > this.width) {\n      cTitleText.style(\"font-size\", font + \"px\");\n      sTitleText.style(\"font-size\", font + \"px\");\n    } else {\n      // Else - reset the font size to default so it won't get stuck\n      cTitleText.style(\"font-size\", null);\n      sTitleText.style(\"font-size\", null);\n    }\n  },\n  _interact() {\n    const _this = this;\n\n    return {\n      _mouseover(d, i) {\n        if (_this.model.time.dragging) return;\n\n        _this.model.marker.highlightMarker(d);\n\n        _this.hovered = d;\n        //put the exact value in the size title\n        _this.updateTitleNumbers();\n        _this.fitSizeOfTitles();\n\n        if (_this.model.marker.isSelected(d)) { // if selected, not show hover tooltip\n          _this._setTooltip();\n        } else {\n          //position tooltip\n          _this._setTooltip(d);\n        }\n      },\n      _mouseout(d, i) {\n        if (_this.model.time.dragging) return;\n        _this._setTooltip();\n        _this.hovered = null;\n        _this.updateTitleNumbers();\n        _this.fitSizeOfTitles();\n        _this.model.marker.clearHighlighted();\n      },\n      _click(d, i) {\n        _this.model.marker.selectMarker(d);\n      }\n    };\n\n  },\n\n  // show size number on title when hovered on a bubble\n  updateTitleNumbers() {\n    const _this = this;\n\n    let mobile; // if is mobile device and only one bubble is selected, update the ytitle for the bubble\n    if (_this.isMobile && _this.model.marker.select && _this.model.marker.select.length === 1) {\n      mobile = _this.model.marker.select[0];\n    }\n\n    if (_this.hovered || mobile) {\n      const hovered = _this.hovered || mobile;\n      const formatterC = _this.model.marker.color.getTickFormatter();\n\n      let unitC = _this.translator(\"unit/\" + _this.model.marker.color.which);\n      //suppress unit strings that found no translation (returns same thing as requested)\n      if (unitC === \"unit/\" + _this.model.marker.color.which) unitC = \"\";\n\n      const valueC = _this.values.color[_this._getKey(hovered)];\n      _this.cTitleEl.select(\"text\")\n        .text(this.strings.title.C + \": \" +\n          (valueC || valueC === 0 ? formatterC(valueC) + \" \" + unitC : _this.translator(\"hints/nodata\")));\n\n      if (this.model.marker.size.use !== \"constant\") {\n        const formatterS = _this.model.marker.size.getTickFormatter();\n\n        let unitS = _this.translator(\"unit/\" + _this.model.marker.size.which);\n        //suppress unit strings that found no translation (returns same thing as requested)\n        if (unitS === \"unit/\" + _this.model.marker.size.which) unitS = \"\";\n\n        const valueS = _this.values.size[_this._getKey(hovered)];\n        _this.sTitleEl.select(\"text\")\n          .text(this.strings.title.S + \": \" + formatterS(valueS) + \" \" + unitS);\n      }\n\n      this.cInfoEl.classed(\"vzb-hidden\", true);\n      this.sInfoEl.classed(\"vzb-hidden\", true);\n    } else {\n      this.cTitleEl.select(\"text\")\n        .text(this.strings.title.C);\n      this.sTitleEl.select(\"text\")\n        .text(this.strings.title.S);\n\n      this.cInfoEl.classed(\"vzb-hidden\", false);\n      this.sInfoEl.classed(\"vzb-hidden\", false);\n    }\n  },\n\n  _setTooltip(d) {\n    const _this = this;\n    if (d) {\n      const tooltipText = this.values.label[this._getKey(d)] ?\n        this.values.label[this._getKey(d)]\n        : d.properties.MN_NAME;\n      const offset = 10;\n      const mouse = d3.mouse(this.graph.node()).map(d => parseInt(d));\n      let x = mouse[0];\n      let y = mouse[1];\n      let xPos, yPos, xSign = -1,\n        ySign = -1,\n        xOffset = 0,\n        yOffset = 0;\n\n      if (offset) {\n        xOffset = offset * 0.71; // .71 - sin and cos for 315\n        yOffset = offset * 0.71;\n      }\n      //position tooltip\n      this.tooltip.classed(\"vzb-hidden\", false)\n      //.attr(\"style\", \"left:\" + (mouse[0] + 50) + \"px;top:\" + (mouse[1] + 50) + \"px\")\n        .selectAll(\"text\")\n        .text(tooltipText);\n\n      const contentBBox = this.tooltip.select(\"text\").node().getBBox();\n      if (x - xOffset - contentBBox.width < 0) {\n        xSign = 1;\n        x += contentBBox.width + 5; // corrective to the block Radius and text padding\n      } else {\n        x -= 5; // corrective to the block Radius and text padding\n      }\n      if (y - yOffset - contentBBox.height < 0) {\n        ySign = 1;\n        y += contentBBox.height;\n      } else {\n        y -= 11; // corrective to the block Radius and text padding\n      }\n      if (offset) {\n        xPos = x + xOffset * xSign;\n        yPos = y + yOffset * ySign; // 5 and 11 - corrective to the block Radius and text padding\n      } else {\n        xPos = x + xOffset * xSign; // .71 - sin and cos for 315\n        yPos = y + yOffset * ySign; // 5 and 11 - corrective to the block Radius and text padding\n      }\n      this.tooltip.attr(\"transform\", \"translate(\" + (xPos ? xPos : mouse[0]) + \",\" + (yPos ? yPos : mouse[1]) +\n        \")\");\n\n      this.tooltip.select(\"rect\").attr(\"width\", contentBBox.width + 8)\n        .attr(\"height\", contentBBox.height * 1.2)\n        .attr(\"x\", -contentBBox.width - 4)\n        .attr(\"y\", -contentBBox.height * 0.85)\n        .attr(\"rx\", contentBBox.height * 0.2)\n        .attr(\"ry\", contentBBox.height * 0.2);\n\n\n    } else {\n\n      this.tooltip.classed(\"vzb-hidden\", true);\n    }\n  },\n\n  updateLandOpacity() {\n    const _this = this;\n    //if(!duration)duration = 0;\n\n    const OPACITY_HIGHLT = 0.8;\n    const OPACITY_HIGHLT_DIM = 0.3;\n    const OPACITY_SELECT = 1.0;\n    const OPACITY_REGULAR = this.model.marker.opacityRegular;\n    const OPACITY_SELECT_DIM = this.model.marker.opacitySelectDim;\n    this.someHighlighted = (this.model.marker.highlight.length > 0);\n    this.someSelected = (this.model.marker.select.length > 0);\n    this.mapLands\n      .style(\"opacity\", d => {\n\n      if (_this.someHighlighted) {\n      //highlight or non-highlight\n      if (_this.model.marker.isHighlighted(d)) return OPACITY_HIGHLT;\n    }\n\n    if (_this.someSelected) {\n      //selected or non-selected\n      return _this.model.marker.isSelected(d) ? OPACITY_SELECT : OPACITY_SELECT_DIM;\n    }\n\n    if (_this.someHighlighted) return OPACITY_HIGHLT_DIM;\n\n    return OPACITY_REGULAR;\n  });\n\n\n    const someSelectedAndOpacityZero = _this.someSelected && _this.model.marker.opacitySelectDim < 0.01;\n\n    // when pointer events need update...\n    if (someSelectedAndOpacityZero != this.someSelectedAndOpacityZero_1) {\n      this.mapLands.style(\"pointer-events\", d => (!someSelectedAndOpacityZero || _this.model.marker.isSelected(d)) ?\n        \"visible\" : \"none\");\n    }\n\n    this.someSelectedAndOpacityZero_1 = _this.someSelected && _this.model.marker.opacitySelectDim < 0.01;\n  },\n\n  preload() {\n    const _this = this;\n    const shape_path = this.model.ui.map.topology.path \n      || (this.model.data.assetsPath + \"world-50m.json\");    \n\n    const projection = \"geo\" + utils.capitalize(this.model.ui.map.projection);\n\n    this.zeroProjection = d3[projection]();\n    this.zeroProjection\n      .scale(1)\n      .translate([0, 0]);\n\n    this.projection = d3[projection]();\n    this.projection\n      .scale(1)\n      .translate([0, 0]);\n\n    this.mapPath = d3.geoPath()\n      .projection(this.projection);\n\n    this.model.ui.map.scale = 1;\n    return this._loadShapes(shape_path).then(\n        shapes => {\n        _this.shapes = shapes;\n        _this.geometries = _this.shapes.objects[_this.model.ui.map.topology.objects.boundaries].geometries;\n        _this.mapFeature = topojson.feature(_this.shapes, _this.shapes.objects[_this.model.ui.map.topology.objects.geo]);\n        _this.mapBounds = _this.mapPath.bounds(_this.mapFeature);\n        _this.boundaries = topojson.mesh(_this.shapes, _this.shapes.objects[_this.model.ui.map.topology.objects.boundaries], (a, b) => a !== b);\n        _this.borderArcs = _this.cartogram.meshArcs(_this.shapes, _this.shapes.objects[_this.model.ui.map.topology.objects.boundaries], (a, b) => {\n          a.properties[_this.model.ui.map.topology.geoIdProperty] && \n          a.properties[_this.model.ui.map.topology.geoIdProperty] !== b.properties[_this.model.ui.map.topology.geoIdProperty]\n        });\n      }\n    );\n  },\n  \n  _loadShapes(shape_path) {\n    return new Promise((resolve, reject) => {\n      d3.json(shape_path, (error, json) => {\n        if (error) return console.warn(\"Failed loading json \" + shape_path + \". \" + error);\n        resolve(json);\n      });\n    });\n  }\n});\n\n\nexport default CartogramComponent;\n\n\n\n// WEBPACK FOOTER //\n// ./src/component.js","const { \n  utils,\n  helpers: {\n    topojson,\n  }\n} = Vizabi;\n\n/*\n * d3.cartogram is a d3-friendly implementation of An Algorithm to Construct\n * Continuous Area Cartograms:\n *\n * <http://chrisman.scg.ulaval.ca/G360/dougenik.pdf>\n *\n * It requires topojson to decode TopoJSON-encoded topologies:\n *\n * <http://github.com/mbostock/topojson/>\n *\n * Usage:\n *\n * var cartogram = d3.cartogram()\n *  .projection(d3.geo.albersUsa())\n *  .value(function(d) {\n *    return Math.random() * 100;\n *  });\n * d3.json(\"path/to/topology.json\", function(topology) {\n *  var features = cartogram(topology, topology.objects.OBJECTNAME.geometries);\n *  d3.select(\"svg\").selectAll(\"path\")\n *    .data(features)\n *    .enter()\n *    .append(\"path\")\n *      .attr(\"d\", cartogram.path);\n * });\n */\nd3.cartogram = function() {\n\n  function carto(topology, geometries, totalValue) {\n\n    var calculateObjectsMeta = function(objects, values, path) {\n      return new Promise(function(resolve, reject) {\n        var areas = objects.map(path.area);\n        var totalArea = d3.sum(areas),\n          sizeErrorsTot =0,\n          sizeErrorsNum=0;\n\n        var calculateMeta = function(index, cb) {\n          var area = Math.abs(areas[index]), // XXX: why do we have negative areas?\n            v = +values[index],\n            desired = totalArea * v / totalValue,\n            radius = Math.sqrt(area / Math.PI),\n            mass = Math.sqrt(desired / Math.PI) - radius,\n            sizeError = Math.max(area, desired) / Math.min(area, desired);\n          // console.log(o.id, \"@\", j, \"area:\", area, \"value:\", v, \"->\", desired, radius, mass, sizeError);\n          cb({\n            id: objects[index].id,\n            area: area,\n            centroid: path.centroid(objects[index]),\n            value: v,\n            desired: desired,\n            radius: radius,\n            mass: mass,\n            sizeError: sizeError\n          });\n        };\n        var calculateMetaSequence = function(index) {\n          if (index >= objects.length) {\n            return resolve({ meta: meta, sizeError: (sizeErrorsTot/sizeErrorsNum) });\n          }\n          calculateMeta(index, function(response) {\n            meta.push(response);\n            sizeErrorsTot+=response.sizeError;\n            sizeErrorsNum++;\n            if (index % 400 == 0) {\n              utils.defer(function() {\n                calculateMetaSequence(++index);\n              });\n            } else {\n              calculateMetaSequence(++index);\n            }\n          });\n        };\n        var meta = [];\n        calculateMetaSequence(0);\n      });\n    };\n    // copy it first\n    return new Promise(function(resolve, reject) {\n      topology = copy(topology);\n\n      // objects are projected into screen coordinates\n\n      // project the arcs into screen space\n      var tf = transformer(topology.transform), x, y, len1, i1, out1, len2=topology.arcs.length, i2=0,\n        projectedArcs = new Array(len2);\n      let projectedArcsDeferResolver;\n      var projectedArcsDefer = new Promise((resolve, reject) => {\n        projectedArcsDeferResolver = resolve;\n      });\n      var generateTopologySegment = function(segmentIndex, segmentLength) {\n        return new Promise(function(resolve, reject) {\n          i1 = 0;\n          while (i1<segmentLength) {\n            topology.arcs[segmentIndex][i1][0] = (x += topology.arcs[segmentIndex][i1][0]);\n            topology.arcs[segmentIndex][i1][1] = (y += topology.arcs[segmentIndex][i1][1]);\n            out1[i1] = projection === null ? tf(topology.arcs[segmentIndex][i1]) : projection(tf(topology.arcs[segmentIndex][i1]));\n            i1++;\n          }\n          resolve(out1);\n        });\n\n      };\n      var generateTopologyArcs = function(index, totalLength) {\n        if (index >= totalLength) {\n          return projectedArcsDeferResolver(projectedArcs);\n        }\n        x = 0;\n        y = 0;\n        len1 = topology.arcs[index].length;\n        i1 = 0;\n        out1 = new Array(len1);\n\n        generateTopologySegment(index, len1).then(function(segment) {\n          projectedArcs[index++]=segment;\n          if (index % 400 == 0) {\n            utils.defer(function() {\n              generateTopologyArcs(index, totalLength);\n            });\n          } else {\n            generateTopologyArcs(index, totalLength);\n          }\n        });\n      };\n      generateTopologyArcs(0, len2);\n\n      projectedArcsDefer.then(function(projectedArcs) {\n        // path with identity projection\n        var path = d3.geoPath()\n          .projection(null);\n        var objects = object(projectedArcs, { type: \"GeometryCollection\", geometries: geometries })\n          .geometries.map(function(geom) {\n            return {\n              type: \"Feature\",\n              id: geom.id,\n              properties: properties.call(null, geom, topology),\n              geometry: geom\n            };\n          });\n        var values = objects.map(value);\n        if (!totalValue) {\n          totalValue = d3.sum(values);\n        }\n        // no iterations; just return the features\n        if (iterations <= 0) {\n          resolve({\n            features: objects,\n            arcs: projectedArcs\n          });\n        }\n        var i = 0;\n        var resizeSegments = function(index, iterations) {\n          if (index >= iterations) {\n            return iterationsDeferResolver();\n          }\n          calculateObjectsMeta(objects, values, path).then(function(response) {\n            var forceReductionFactor = 1 / (1 + response.sizeError);\n\n            // console.log(\"meta:\", meta);\n            // console.log(\"  total area:\", totalArea);\n            // console.log(\"  force reduction factor:\", forceReductionFactor, \"mean error:\", sizeError);\n            var delta, centroid, mass, radius, rSquared, dx, dy, distSquared, dist, Fij;\n            var updatePoint = function(i2, len2) {\n              var len1, i1, delta, len3, i3, centroid, mass, radius, rSquared, dx, dy, distSquared, dist, Fij;\n              while (i2<len2) {\n                len1=projectedArcs[i2].length;\n                i1=0;\n                while (i1<len1) {\n                  // create an array of vectors: [x, y]\n                  delta = [0, 0];\n                  len3 = response.meta.length;\n                  i3=0;\n                  while (i3<len3) {\n                    centroid =  response.meta[i3].centroid;\n                    mass =      response.meta[i3].mass;\n                    radius =    response.meta[i3].radius;\n                    rSquared = (radius*radius);\n                    dx = projectedArcs[i2][i1][0] - centroid[0];\n                    dy = projectedArcs[i2][i1][1] - centroid[1];\n                    distSquared = dx * dx + dy * dy;\n                    dist=Math.sqrt(distSquared);\n                    Fij = (dist > radius)\n                      ? mass * radius / dist\n                      : mass *\n                      (distSquared / rSquared) *\n                      (4 - 3 * dist / radius);\n                    delta[0]+=(Fij * cosArctan(dy, dx));\n                    delta[1]+=(Fij * sinArctan(dy, dx));\n                    i3++;\n                  }\n                  projectedArcs[i2][i1][0] += (delta[0]*forceReductionFactor);\n                  projectedArcs[i2][i1][1] += (delta[1]*forceReductionFactor);\n                  i1++;\n                }\n                i2++;\n              }\n            };\n            var updatePointSequence = function(start) {\n              if (start >= projectedArcs.length) {\n                if (response.sizeError <= 1) {\n                  resizeSegments(iterations, iterations);\n                  return;\n                }\n                utils.defer(function() {\n                  resizeSegments(++index, iterations);\n                });\n                return;\n              }\n              var end = Math.min(start + 400, projectedArcs.length);\n              updatePoint(start, end);\n              utils.defer(function() {\n                updatePointSequence(end);\n              });\n            };\n            updatePointSequence(0);\n            // break if we hit the target size error\n          });\n        };\n        let iterationsDeferResolver;\n        const iterationsDefer = new Promise((resolve, reject) => {\n          iterationsDeferResolver = resolve;\n        });\n        resizeSegments(0, iterations);\n        iterationsDefer.then(function() {\n          resolve({\n            features: objects,\n            arcs: projectedArcs\n          });\n        });\n      });\n\n      /*\n       while(i2<len2){\n       x = 0;\n       y = 0;\n       len1 = topology.arcs[i2].length;\n       i1 = 0;\n       out1 = new Array(len1);\n       while(i1<len1){\n       topology.arcs[i2][i1][0] = (x += topology.arcs[i2][i1][0]);\n       topology.arcs[i2][i1][1] = (y += topology.arcs[i2][i1][1]);\n       out1[i1] = projection === null ? tf(topology.arcs[i2][i1]) : projection(tf(topology.arcs[i2][i1]));\n       i1++;\n       }\n       projectedArcs[i2++]=out1;\n\n       }\n       */\n    });\n\n  }\n\n  var iterations = 8,\n    projection = d3.geoAlbers(),\n    properties = function(id) {\n      return {};\n    },\n    value = function(d) {\n      return 1;\n    };\n\n  // for convenience\n  carto.path = d3.geoPath()\n    .projection(null);\n\n  carto.iterations = function(i) {\n    if (arguments.length) {\n      iterations = i;\n      return carto;\n    } else {\n      return iterations;\n    }\n  };\n\n  carto.value = function(v) {\n    if (arguments.length) {\n      value = d3.functor(v);\n      return carto;\n    } else {\n      return value;\n    }\n  };\n\n  carto.projection = function(p) {\n    if (arguments.length) {\n      projection = p;\n      return carto;\n    } else {\n      return projection;\n    }\n  };\n\n  carto.feature = function(topology, geom) {\n    return {\n      type: \"Feature\",\n      id: geom.id,\n      properties: properties.call(null, geom, topology),\n      geometry: {\n        type: geom.type,\n        coordinates: topojson.feature(topology, geom).geometry.coordinates\n      }\n    };\n  };\n\n  carto.meshArcs = function(topology, o, filter) {\n    var arcs = [];\n\n    function arc(i) {\n      var j = i < 0 ? ~i : i;\n      (geomsByArc[j] || (geomsByArc[j] = [])).push({\n        i: i,\n        g: geom\n      });\n    }\n\n    function line(arcs) {\n      arcs.forEach(arc);\n    }\n\n    function polygon(arcs) {\n      arcs.forEach(line);\n    }\n\n    function geometry(o) {\n      if (o.type === \"GeometryCollection\") o.geometries.forEach(geometry);\n      else if (o.type in geometryType) geom = o, geometryType[o.type](o.arcs);\n    }\n\n    if (arguments.length > 1) {\n      var geomsByArc = [],\n        geom;\n\n      var geometryType = {\n        LineString: line,\n        MultiLineString: polygon,\n        Polygon: polygon,\n        MultiPolygon: function(arcs) {\n          arcs.forEach(polygon);\n        }\n      };\n\n      geometry(o);\n\n      geomsByArc.forEach(arguments.length < 3 ? function(geoms) {\n          arcs.push(geoms[0].i);\n        } : function(geoms) {\n          if (filter(geoms[0].g, geoms[geoms.length - 1].g)) arcs.push(geoms[0].i);\n        });\n    } else {\n      for (var i = 0, n = topology.arcs.length; i < n; ++i) arcs.push(i);\n    }\n\n    return arcs;\n  };\n\n  carto.stitchArcs = function(topology, arcs) {\n    var stitchedArcs = {},\n      fragmentByStart = {},\n      fragmentByEnd = {},\n      fragments = [],\n      emptyIndex = -1;\n\n    // Stitch empty arcs first, since they may be subsumed by other arcs.\n    arcs.forEach(function(i, j) {\n      var arc = topology.arcs[i < 0 ? ~i : i],\n        t;\n      if (arc.length < 3 && !arc[1][0] && !arc[1][1]) {\n        t = arcs[++emptyIndex], arcs[emptyIndex] = i, arcs[j] = t;\n      }\n    });\n\n    arcs.forEach(function(i) {\n      var e = ends(i),\n        start = e[0],\n        end = e[1],\n        f, g;\n\n      if (f = fragmentByEnd[start]) {\n        delete fragmentByEnd[f.end];\n        f.push(i);\n        f.end = end;\n        if (g = fragmentByStart[end]) {\n          delete fragmentByStart[g.start];\n          var fg = g === f ? f : f.concat(g);\n          fragmentByStart[fg.start = f.start] = fragmentByEnd[fg.end = g.end] = fg;\n        } else {\n          fragmentByStart[f.start] = fragmentByEnd[f.end] = f;\n        }\n      } else if (f = fragmentByStart[end]) {\n        delete fragmentByStart[f.start];\n        f.unshift(i);\n        f.start = start;\n        if (g = fragmentByEnd[start]) {\n          delete fragmentByEnd[g.end];\n          var gf = g === f ? f : g.concat(f);\n          fragmentByStart[gf.start = g.start] = fragmentByEnd[gf.end = f.end] = gf;\n        } else {\n          fragmentByStart[f.start] = fragmentByEnd[f.end] = f;\n        }\n      } else {\n        f = [i];\n        fragmentByStart[f.start = start] = fragmentByEnd[f.end = end] = f;\n      }\n    });\n\n    function ends(i) {\n      var arc = topology.arcs[i < 0 ? ~i : i],\n        p0 = arc[0],\n        p1;\n      if (topology.transform) p1 = [0, 0], arc.forEach(function(dp) {\n        p1[0] += dp[0], p1[1] += dp[1];\n      });\n      else p1 = arc[arc.length - 1];\n      return i < 0 ? [p1, p0] : [p0, p1];\n    }\n\n    function flush(fragmentByEnd, fragmentByStart) {\n      for (var k in fragmentByEnd) {\n        var f = fragmentByEnd[k];\n        delete fragmentByStart[f.start];\n        delete f.start;\n        delete f.end;\n        f.forEach(function(i) {\n          stitchedArcs[i < 0 ? ~i : i] = 1;\n        });\n        fragments.push(f);\n      }\n    }\n\n    flush(fragmentByEnd, fragmentByStart);\n    flush(fragmentByStart, fragmentByEnd);\n    arcs.forEach(function(i) {\n      if (!stitchedArcs[i < 0 ? ~i : i]) fragments.push([i]);\n    });\n\n    return object(topology, {\n      type: \"MultiLineString\",\n      arcs: fragments\n    });\n  };\n\n  carto.features = function(topo, geometries) {\n    return geometries.map(function(f) {\n      return carto.feature(topo, f);\n    });\n  };\n\n  carto.properties = function(props) {\n    if (arguments.length) {\n      properties = d3.functor(props);\n      return carto;\n    } else {\n      return properties;\n    }\n  };\n\n  return carto;\n};\n\nvar transformer = d3.cartogram.transformer = function(tf) {\n  var kx = tf.scale[0],\n    ky = tf.scale[1],\n    dx = tf.translate[0],\n    dy = tf.translate[1];\n\n  function transform(c) {\n    return [c[0] * kx + dx, c[1] * ky + dy];\n  }\n\n  transform.invert = function(c) {\n    return [(c[0] - dx) / kx, (c[1]- dy) / ky];\n  };\n\n  return transform;\n};\n\nfunction angle(a, b) {\n  return Math.atan2(b[1] - a[1], b[0] - a[0]);\n}\n\nfunction distance(a, b) {\n  var dx = b[0] - a[0],\n    dy = b[1] - a[1];\n  return Math.sqrt(dx * dx + dy * dy);\n}\n\nfunction projector(proj) {\n  var types = {\n    Point: proj,\n    LineString: function(coords) {\n      return coords.map(proj);\n    },\n    MultiLineString: function(arcs) {\n      return arcs.map(types.LineString);\n    },\n    Polygon: function(rings) {\n      return rings.map(types.LineString);\n    },\n    MultiPolygon: function(rings) {\n      return rings.map(types.Polygon);\n    }\n  };\n  return function(geom) {\n    return types[geom.type](geom.coordinates);\n  };\n}\nfunction cosArctan(dx, dy) {\n  if (dy===0) return 0;\n  var div = dx/dy;\n  return (dy>0)?\n    (1/Math.sqrt(1+(div*div))):\n    (-1/Math.sqrt(1+(div*div)));\n}\nfunction sinArctan(dx, dy) {\n  if (dy===0) return 1;\n  var div = dx/dy;\n  return (dy>0)?\n    (div/Math.sqrt(1+(div*div))):\n    (-div/Math.sqrt(1+(div*div)));\n}\nfunction copy(o) {\n  return (o instanceof Array)\n    ? o.map(copy)\n    : (typeof o === \"string\" || typeof o === \"number\")\n      ? o\n      : copyObject(o);\n}\n\nfunction copyObject(o) {\n  var obj = {};\n  for (var k in o) obj[k] = copy(o[k]);\n  return obj;\n}\n\nfunction object(topology, o) {\n  var arcs = topology.arcs ? topology.arcs : topology;\n  function arc(i, points) {\n    if (points.length) points.pop();\n    if (!arcs[i < 0 ? ~i : i]) {\n      console.log(\"fail\");\n    }\n    for (var a = arcs[i < 0 ? ~i : i], k = 0, n = a.length; k < n; ++k) {\n      points.push(a[k]);\n    }\n    if (i < 0) reverse(points, n);\n  }\n\n  function line(arcs) {\n    var points = [];\n    for (var i = 0, n = arcs.length; i < n; ++i) arc(arcs[i], points);\n    return points;\n  }\n\n  function polygon(arcs) {\n    return arcs.map(line);\n  }\n\n  function geometry(o) {\n    o = Object.create(o);\n    o.coordinates = geometryType[o.type](o.arcs);\n    return o;\n  }\n  var geometryType = {\n    LineString: line,\n    MultiLineString: polygon,\n    Polygon: polygon,\n    MultiPolygon: function(arcs) { return arcs.map(polygon); }\n  };\n\n  return o.type === \"GeometryCollection\"\n    ? (o = Object.create(o), o.geometries = o.geometries.map(geometry), o)\n    : geometry(o);\n}\n\nfunction reverse(array, n) {\n  var t, j = array.length, i = j - n; while (i < --j) t = array[i], array[i++] = array[j], array[j] = t;\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/helpers/cartogram.js","module.exports = \"<!--  Component -->\\n<div class=\\\"vzb-cartogram\\\">\\n\\n    <svg class=\\\"vzb-cartogram-svg\\\">\\n        <g class=\\\"vzb-ct-graph\\\">\\n            <g class=\\\"vzb-ct-year\\\"></g>\\n            <svg class=\\\"vzb-ct-map-background vzb-export\\\">\\n                <g class=\\\"vzb-ct-map-graph\\\"></g>\\n            </svg>\\n            <svg class=\\\"vzb-ct-labels-crop\\\">\\n                <g class=\\\"vzb-ct-labels\\\">\\n                    <line class=\\\"vzb-ct-vertical-now\\\"></line>\\n                </g>\\n            </svg>\\n\\n            <g class=\\\"vzb-ct-axis-c-title\\\"><text></text></g>\\n            <g class=\\\"vzb-ct-axis-s-title\\\"><text></text></g>\\n            <g class=\\\"vzb-ct-axis-c-info\\\"></g>\\n            <g class=\\\"vzb-ct-axis-s-info\\\"></g>\\n            <g class=\\\"vzb-ct-tooltip vzb-hidden\\\">\\n                <rect class=\\\"vzb-tooltip-border\\\"></rect>\\n                <text class=\\\"vzb-tooltip-text\\\"></text>\\n\\n            </g>\\n\\n            <g class=\\\"vzb-data-warning vzb-noexport\\\">\\n                <svg></svg>\\n                <text></text>\\n            </g>\\n        </g>\\n    </svg>\\n</div>\\n\";\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./src/template.html\n// module id = 4\n// module chunks = 0"],"sourceRoot":""}