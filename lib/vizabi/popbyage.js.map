{"version":3,"sources":["webpack:///popbyage.js","webpack:///webpack/bootstrap b052a1a26d0b6c78b453","webpack:///./src/index.js","webpack:///./src/component.js","webpack:///./src/template.html"],"names":["modules","__webpack_require__","moduleId","installedModules","exports","module","i","l","call","m","c","value","d","name","getter","o","Object","defineProperty","configurable","enumerable","get","n","__esModule","object","property","prototype","hasOwnProperty","p","s","_component","_component2","obj","default","VERSION_INFO","version","build","PopByAge","Vizabi","Tool","extend","init","placeholder","external_model","this","components","component","model","Component","_super","validate","entities","state","dimAllPossible","entities_allpossible","dim","keys","show","length","entities_geodomain","skipFilter","entities_side","default_model","marker_tags","ui","chart","stacked","inpercent","flipSides","lockActive","lockNonSelected","buttons","dialogs","popup","sidebar","moreoptions","presentation","locale","versionInfo","_toConsumableArray","arr","Array","isArray","arr2","from","_Vizabi","utils","axisSmart","helpers","iconQuestion","iconset","question","config","context","template","model_expects","type","_this","model_binds","change:time.value","evt","_readyOnce","time","step","snapped","playing","dragging","next","d3","bisectLeft","timeSteps","prev","snapTime","Date","filter","t","marker","getFrame","frame","frameAxisX","axis_x","_updateEntities","updateBarsOpacity","nextIndex","prevFrameTime","nextFrameTime","fraction","nValues","pValues","interpolateDiagonal","change:marker.select","someSelected","select","nonSelectedOpacityZero","change:marker.highlight","path","_highlightBars","change:marker.opacitySelectDim","change:marker.opacityRegular","change:marker.color.palette","change:marker.color.scaleType","change:marker.color.which","stackDim","entitiesProps","color","use","colorConcept","getConceptprops","concept_type","domain","sideConcept","side","which","setWhich","concept","STACKDIM","skipFilterSide","SIDEDIM","geoDomainDimension","sideShow","set","marker_allpossible","change:marker.side.which","sideDim","entitiesSideProps","clearSideState","change:entities.show","isEmpty","forEach","getFilteredEntities","isShown","showEntity","change:entities_side.show","doReturn","_entitiesSameDimWithSide","_space","h","_name","_updateIndicators","_ready","_updateLimits","resize","_redrawLocked","change:ui.chart.inpercent","change:ui.chart.flipSides","switchSideState","change:ui.chart.lockNonSelected","lock","stackKeys","stackSkip","yearLocked","text","translator","_makeOutlines","lockedPaths","html","xScale","yScale","cScale","xAxis","xAxisLeft","yAxis","xScales","SHIFTEDAGEDIM","checkDimensions","colorUseConstant","geoLess","sideSkip","readyOnce","el","element","interaction","_interaction","graph","yAxisEl","xAxisEl","xAxisLeftEl","xTitleEl","xInfoEl","yTitleEl","barsCrop","lockedCrop","labelsCrop","bars","labels","title","titleRight","year","getDimension","geoDomainDefaultValue","on","_attributeUpdaters","_newWidth","width","AGEDIM","ageShift","PREFIXEDSIDEDIM","PREFIXEDSTACKDIM","total","width_","_newX","prevSbl","previousSibling","prevSblDatum","datum","x_","ready","_this2","getAllSteps","shiftScale","scale","linear","range","label_side","getEntity","stack","label_stack","age","axis_y","TIMEDIM","groupBy","grouping","updateUIStrings","frameAllColor","_createLimits","apFrame","parse","lockFrame","dataBetweenFrames","data","val1","val2","shiftedAge","ageKeys","sideKeys","getTFunction","xTitle","selectAll","enter","append","parent","findChildByName","markerID","alignX","isRTL","alignY","updateView","toggle","setIcon","attr","pin","rect","getBBox","coord","makeAbsoluteContext","farthestViewportElement","x","y","height","toolRect","root","getBoundingClientRect","chartRect","node","setHook","setPos","left","hide","_this3","duration","delayAnimations","getScale","tickFormat","getTickFormatter","ageDim","ages","getKeys","map","shiftedAgeKeys","slice","reverse","concat","sideItems","getItems","sideFiltered","f","sortFunc","ascending","descending","sort","push","stacks","sortedStackKeys","getPalette","reduce","val","indexOf","stackItems","twoSided","classed","xScaleLeft","copy","markers","axisX","sideKeysNF","getNestedItems","limits","getLimitsByDimensions","timeKeys","getUnique","totals","inpercentMaxLimits","maxLimits","ageSum","sideMaxLimits","stackSum","max","maxSideLimit","Math","apply","domainMin","domainMax","_interpolateBetweenTotals","nextStep","reorder","prefixedSideDim","prefixedStackDim","shiftedAgeDim","ageData","outAge","j","r","barsData","ageBars","exit","remove","oneBarHeight","barHeight","firstBarOffsetY","merge","sideBars","activeProfile","centerWidth","stackBars","highlighted","mouseover","mouseout","click","onTap","tap","order","stepShift","transition","ease","easeLinear","interrupt","entityLabels","_id","each","yearOlds","parseInt","_setYear","formatDate","KEYS","unique","_getAllDimensions","exceptType","key","line","curve","curveStepBefore","stackIndex","pathsData","getValueMD","paths","getColorShade","colorID","shadeID","timeValue","formattedTime","isTouchDevice","highlightMarker","_showLabel","clearHighlighted","selectMarker","event","stopPropagation","someHighlighted","highlight","formatter","format","label","textData","invert","presentationProfileChanges","medium","margin","right","bottom","infoElHeight","large","top","profiles","small","titlesSpacing","getActiveProfile","style","warn","maxRange","tickSizeInner","tickSizeOuter","tickPadding","tickSizeMinor","labelerOptions","scaleType","toolMargin","limitMaxTickNumber","translateX","rangePoints","zeroTickEl","empty","zeroTickWidth","tickNodes","nodes","titleBBox","transform","hTranslate","translateY","OPACITY_HIGHLT_DIM","opacityHighlightDim","OPACITY_SELECT","opacityRegular","OPACITY_REGULAR","OPACITY_SELECT_DIM","opacitySelectDim","nonSelectedOpacityZeroFlag","isSelected","isHighlighted","bar"],"mappings":"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","file":"popbyage.js","sourcesContent":["/******/ (function(modules) { // webpackBootstrap\n/******/ \t// The module cache\n/******/ \tvar installedModules = {};\n/******/\n/******/ \t// The require function\n/******/ \tfunction __webpack_require__(moduleId) {\n/******/\n/******/ \t\t// Check if module is in cache\n/******/ \t\tif(installedModules[moduleId]) {\n/******/ \t\t\treturn installedModules[moduleId].exports;\n/******/ \t\t}\n/******/ \t\t// Create a new module (and put it into the cache)\n/******/ \t\tvar module = installedModules[moduleId] = {\n/******/ \t\t\ti: moduleId,\n/******/ \t\t\tl: false,\n/******/ \t\t\texports: {}\n/******/ \t\t};\n/******/\n/******/ \t\t// Execute the module function\n/******/ \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n/******/\n/******/ \t\t// Flag the module as loaded\n/******/ \t\tmodule.l = true;\n/******/\n/******/ \t\t// Return the exports of the module\n/******/ \t\treturn module.exports;\n/******/ \t}\n/******/\n/******/\n/******/ \t// expose the modules object (__webpack_modules__)\n/******/ \t__webpack_require__.m = modules;\n/******/\n/******/ \t// expose the module cache\n/******/ \t__webpack_require__.c = installedModules;\n/******/\n/******/ \t// identity function for calling harmony imports with the correct context\n/******/ \t__webpack_require__.i = function(value) { return value; };\n/******/\n/******/ \t// define getter function for harmony exports\n/******/ \t__webpack_require__.d = function(exports, name, getter) {\n/******/ \t\tif(!__webpack_require__.o(exports, name)) {\n/******/ \t\t\tObject.defineProperty(exports, name, {\n/******/ \t\t\t\tconfigurable: false,\n/******/ \t\t\t\tenumerable: true,\n/******/ \t\t\t\tget: getter\n/******/ \t\t\t});\n/******/ \t\t}\n/******/ \t};\n/******/\n/******/ \t// getDefaultExport function for compatibility with non-harmony modules\n/******/ \t__webpack_require__.n = function(module) {\n/******/ \t\tvar getter = module && module.__esModule ?\n/******/ \t\t\tfunction getDefault() { return module['default']; } :\n/******/ \t\t\tfunction getModuleExports() { return module; };\n/******/ \t\t__webpack_require__.d(getter, 'a', getter);\n/******/ \t\treturn getter;\n/******/ \t};\n/******/\n/******/ \t// Object.prototype.hasOwnProperty.call\n/******/ \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n/******/\n/******/ \t// __webpack_public_path__\n/******/ \t__webpack_require__.p = \"\";\n/******/\n/******/ \t// Load entry module and return exports\n/******/ \treturn __webpack_require__(__webpack_require__.s = 4);\n/******/ })\n/************************************************************************/\n/******/ ([\n/* 0 */\n/***/ (function(module, exports, __webpack_require__) {\n\n\"use strict\";\n\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\n__webpack_require__(2);\n\nvar _component = __webpack_require__(1);\n\nvar _component2 = _interopRequireDefault(_component);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nvar VERSION_INFO = { version: \"1.1.5\", build: 1493625494281 };\n\n//BAR CHART TOOL\nvar PopByAge = Vizabi.Tool.extend(\"PopByAge\", {\n\n  /**\n   * Initializes the tool (Bar Chart Tool).\n   * Executed once before any template is rendered.\n   * @param {Object} placeholder Placeholder element for the tool\n   * @param {Object} external_model Model as given by the external page\n   */\n  init: function init(placeholder, external_model) {\n\n    this.name = \"popbyage\";\n\n    //specifying components\n    this.components = [{\n      component: _component2.default,\n      placeholder: \".vzb-tool-viz\",\n      model: [\"state.time\", \"state.marker\", \"state.marker_allpossible\", \"state.entities\", \"state.entities_side\", \"state.entities_allpossible\", \"state.entities_geodomain\", \"locale\", \"ui\"] //pass models to component\n    }, {\n      component: Vizabi.Component.get(\"timeslider\"),\n      placeholder: \".vzb-tool-timeslider\",\n      model: [\"state.time\", \"state.entities\", \"state.marker\", \"ui\"]\n    }, {\n      component: Vizabi.Component.get(\"dialogs\"),\n      placeholder: \".vzb-tool-dialogs\",\n      model: [\"state\", \"ui\", \"locale\"]\n    }, {\n      component: Vizabi.Component.get(\"buttonlist\"),\n      placeholder: \".vzb-tool-buttonlist\",\n      model: [\"state\", \"ui\", \"locale\"]\n    }, {\n      component: Vizabi.Component.get(\"treemenu\"),\n      placeholder: \".vzb-tool-treemenu\",\n      model: [\"state.marker\", \"state.marker_tags\", \"state.time\", \"locale\"]\n    }, {\n      component: Vizabi.Component.get(\"datanotes\"),\n      placeholder: \".vzb-tool-datanotes\",\n      model: [\"state.marker\", \"locale\"]\n    }, {\n      component: Vizabi.Component.get(\"steppedspeedslider\"),\n      placeholder: \".vzb-tool-stepped-speed-slider\",\n      model: [\"state.time\", \"locale\"]\n    }];\n\n    //constructor is the same as any tool\n    this._super(placeholder, external_model);\n  },\n  validate: function validate(model) {\n    model = this.model || model;\n\n    this._super(model);\n\n    //validate on first model set only\n    if (!this.model) {\n      var entities = model.state.entities;\n      var dimAllPossible = model.state.entities_allpossible.dim;\n      if (Object.keys(entities.show).length > 0) {\n        var show = {};\n        if (entities.show[entities.dim] && entities.show[entities.dim][\"$in\"]) {\n          show[entities.dim] = {};\n          show[entities.dim][\"$in\"] = entities.show[entities.dim][\"$in\"];\n        }\n        if (entities.dim !== dimAllPossible) {\n          show[\"is--\" + dimAllPossible] = true;\n        }\n        if (!entities.show[entities.dim] || !(Object.keys(entities.show).length == 1)) {\n          entities.show = show;\n        }\n      }\n\n      var entities_geodomain = model.state.entities_geodomain;\n      entities_geodomain.skipFilter = model.state.entities.dim === entities_geodomain.dim || model.state.entities_side.dim === entities_geodomain.dim;\n    }\n  },\n\n\n  default_model: {\n    state: {\n      marker_tags: {}\n    },\n    ui: {\n      chart: {\n        stacked: true,\n        inpercent: false,\n        flipSides: true,\n        lockActive: true,\n        lockNonSelected: 0\n      },\n      \"buttons\": [\"colors\", \"inpercent\", \"side\", \"lock\", \"moreoptions\", \"fullscreen\"],\n      \"dialogs\": {\n        \"popup\": [\"timedisplay\", \"colors\", \"side\", \"moreoptions\"],\n        \"sidebar\": [\"timedisplay\", \"colors\", \"show\"],\n        \"moreoptions\": [\"opacity\", \"speed\", \"colors\", \"side\", \"presentation\", \"about\"]\n      },\n      presentation: false\n    },\n    locale: {}\n  },\n\n  versionInfo: VERSION_INFO\n});\n\nexports.default = PopByAge;\n\n/***/ }),\n/* 1 */\n/***/ (function(module, exports, __webpack_require__) {\n\n\"use strict\";\n\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nfunction _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }\n\nvar _Vizabi = Vizabi,\n    utils = _Vizabi.utils,\n    Component = _Vizabi.Component,\n    axisSmart = _Vizabi.helpers[\"d3.axisWithLabelPicker\"],\n    iconQuestion = _Vizabi.iconset.question;\n\n// POP BY AGE CHART COMPONENT\n\nvar PopByAge = Component.extend(\"popbyage\", {\n\n  /**\n   * Initializes the component (Bar Chart).\n   * Executed once before any template is rendered.\n   * @param {Object} config The config passed to the component\n   * @param {Object} context The component's parent\n   */\n  init: function init(config, context) {\n    this.name = \"popbyage\";\n    this.template = __webpack_require__(3);\n\n    //define expected models for this component\n    this.model_expects = [{\n      name: \"time\",\n      type: \"time\"\n    }, {\n      name: \"marker\",\n      type: \"model\"\n    }, {\n      name: \"marker_allpossible\",\n      type: \"model\"\n    }, {\n      name: \"entities\",\n      type: \"entities\"\n    }, {\n      name: \"entities_side\",\n      type: \"entities\"\n    }, {\n      name: \"entities_allpossible\",\n      type: \"entities\"\n    }, {\n      name: \"entities_geodomain\",\n      type: \"entities\"\n    }, {\n      name: \"locale\",\n      type: \"locale\"\n    }, {\n      name: \"ui\",\n      type: \"ui\"\n    }];\n\n    var _this = this;\n    this.model_binds = {\n      \"change:time.value\": function changeTimeValue(evt) {\n        if (!_this._readyOnce) return;\n        if (_this.model.time.step != 1 && !_this.snapped && !_this.model.time.playing && !_this.model.time.dragging) {\n          var next = d3.bisectLeft(_this.timeSteps, _this.model.time.value);\n          if (next != 0 && _this.timeSteps[next] - _this.model.time.value) {\n            _this.snapped = true;\n            var time = _this.model.time.value;\n            var prev = _this.timeSteps[next - 1];\n            next = _this.timeSteps[next];\n            var snapTime = time - prev < next - time ? prev : next;\n            _this.model.time.value = new Date(snapTime);\n          }\n        }\n        if (!_this.snapped) {\n          if (_this.timeSteps.filter(function (t) {\n            return t - _this.model.time.value == 0;\n          }).length) {\n            _this.model.marker.getFrame(_this.model.time.value, function (frame) {\n              _this.frame = frame;\n              _this.frameAxisX = frame.axis_x;\n              _this._updateEntities();\n              _this.updateBarsOpacity();\n            });\n          } else {\n            var nextIndex = d3.bisectLeft(_this.timeSteps, _this.model.time.value);\n            var prevFrameTime = _this.timeSteps[nextIndex - 1];\n            var nextFrameTime = _this.timeSteps[nextIndex];\n            var fraction = (_this.model.time.value - prevFrameTime) / (nextFrameTime - prevFrameTime);\n            _this.model.marker.getFrame(nextFrameTime, function (nValues) {\n              _this.model.marker.getFrame(prevFrameTime, function (pValues) {\n                _this.frameAxisX = _this.interpolateDiagonal(pValues.axis_x, nValues.axis_x, fraction);\n                _this._updateEntities();\n                _this.updateBarsOpacity();\n              });\n            });\n          }\n        }\n        _this.snapped = false;\n      },\n      \"change:marker.select\": function changeMarkerSelect(evt) {\n        _this.someSelected = _this.model.marker.select.length > 0;\n        _this.nonSelectedOpacityZero = false;\n        _this.updateBarsOpacity();\n      },\n      \"change:marker.highlight\": function changeMarkerHighlight(evt, path) {\n        if (!_this._readyOnce) return;\n        _this._highlightBars();\n      },\n      \"change:marker.opacitySelectDim\": function changeMarkerOpacitySelectDim() {\n        _this.updateBarsOpacity();\n      },\n      \"change:marker.opacityRegular\": function changeMarkerOpacityRegular() {\n        _this.updateBarsOpacity();\n      },\n      \"change:marker.color.palette\": function changeMarkerColorPalette(evt) {\n        if (!_this._readyOnce) return;\n        _this._updateEntities(true);\n      },\n      \"change:marker.color.scaleType\": function changeMarkerColorScaleType(evt) {\n        if (!_this._readyOnce) return;\n        _this._updateEntities();\n      },\n      \"change:marker.color.which\": function changeMarkerColorWhich(evt) {\n        if (!_this._readyOnce) return;\n        var stackDim = void 0;\n        var show = {};\n        var entitiesProps = {};\n        if (_this.model.marker.color.use == \"constant\") {\n          stackDim = null;\n        } else {\n          var colorConcept = _this.model.marker.color.getConceptprops();\n          if (colorConcept.concept_type == \"entity_set\") {\n            stackDim = colorConcept.domain;\n            //show[\"is--\" + _this.model.marker.color.which] = true;\n            var sideConcept = _this.model.marker.side.getConceptprops();\n            if (sideConcept.concept_type == \"entity_set\" && stackDim == sideConcept.domain && _this.model.marker.side.which !== _this.model.marker.color.which) {\n              _this.model.marker.side.setWhich({ \"concept\": _this.model.marker.color.which });\n            }\n          } else {\n            stackDim = _this.model.marker.color.which;\n          }\n        }\n        if (_this.STACKDIM !== stackDim) {\n          entitiesProps[\"show\"] = show;\n        }\n        entitiesProps[\"dim\"] = stackDim;\n        var skipFilterSide = _this.SIDEDIM !== _this.geoDomainDimension || _this.model.marker.color.which === _this.model.marker.side.which;\n        if (!skipFilterSide) {\n          var sideShow = {};\n          sideShow[\"is--\" + _this.model.marker.side.which] = true;\n          _this.model.entities_side.set(\"show\", sideShow);\n        }\n        _this.model.entities_side.skipFilter = skipFilterSide;\n        _this.model.entities_geodomain.skipFilter = stackDim === _this.geoDomainDimension || _this.SIDEDIM === _this.geoDomainDimension;\n        _this.model.entities.set(entitiesProps);\n        _this.model.entities_allpossible.set(\"dim\", stackDim);\n        _this.model.marker_allpossible.color.set(\"which\", _this.model.marker.color.which);\n      },\n      \"change:marker.side.which\": function changeMarkerSideWhich(evt) {\n        if (!_this._readyOnce) return;\n        var sideDim = void 0;\n        var show = {};\n        var entitiesSideProps = {};\n        if (_this.model.marker.side.use == \"constant\") {\n          sideDim = null;\n        } else {\n          var sideConcept = _this.model.marker.side.getConceptprops();\n          if (sideConcept.concept_type == \"entity_set\") {\n            sideDim = sideConcept.domain;\n            var colorConcept = _this.model.marker.color.getConceptprops();\n            if (colorConcept.concept_type == \"entity_set\" && sideDim == colorConcept.domain && _this.model.marker.color.which !== _this.model.marker.side.which) {\n              _this.model.marker.color.setWhich({ \"concept\": _this.model.marker.side.which });\n            }\n          } else {\n            sideDim = _this.model.marker.side.which;\n          }\n        }\n        //        const sideDim = _this.model.marker.side.use == \"constant\" ? null : _this.model.marker.side.which;\n        _this.model.entities_geodomain.skipFilter = sideDim === _this.geoDomainDimension || _this.STACKDIM === _this.geoDomainDimension;\n        _this.model.marker.side.clearSideState();\n        var skipFilterSide = sideDim !== _this.geoDomainDimension || _this.model.marker.color.which === _this.model.marker.side.which;\n        if (!skipFilterSide) {\n          show[\"is--\" + _this.model.marker.side.which] = true;\n        }\n        _this.model.entities_side.skipFilter = skipFilterSide;\n        entitiesSideProps[\"show\"] = show;\n        entitiesSideProps[\"dim\"] = sideDim;\n        //        _this.model.entities_side.clearShow();\n        _this.model.entities_side.set(entitiesSideProps);\n      },\n      \"change:entities.show\": function changeEntitiesShow(evt) {\n        if (!_this._readyOnce) return;\n        if (_this.model.entities.dim === _this.model.entities_side.dim && !utils.isEmpty(_this.model.entities.show) && _this.model.entities.show[_this.model.entities.dim] && !utils.isEmpty(_this.model.entities_side.show)) {\n          utils.forEach(_this.model.entities_side.getFilteredEntities(), function (s) {\n            if (!_this.model.entities.isShown(s)) {\n              _this.model.marker.side.clearSideState();\n              _this.model.entities_side.showEntity(s);\n            }\n          });\n        }\n      },\n      \"change:entities_side.show\": function changeEntities_sideShow(evt) {\n        if (!_this._readyOnce) return;\n\n        var doReturn = false;\n        var _entitiesSameDimWithSide = null;\n        utils.forEach(_this.model.marker.side._space, function (h) {\n          if (h.dim === _this.model.entities_side.dim && h._name !== _this.model.entities_side._name && h._name !== _this.model.entities_geodomain._name) {\n            _entitiesSameDimWithSide = h;\n          }\n        });\n        if (_entitiesSameDimWithSide && !utils.isEmpty(_entitiesSameDimWithSide.show) && _entitiesSameDimWithSide.show[_entitiesSameDimWithSide.dim]) {\n          utils.forEach(_this.model.entities_side.getFilteredEntities(), function (s) {\n            if (!_entitiesSameDimWithSide.isShown(s)) {\n              _entitiesSameDimWithSide.showEntity(s);\n              doReturn = true;\n            }\n          });\n        }\n        if (doReturn) return;\n\n        _this._updateIndicators();\n        if (!_this.model._ready || !_this.frame) return;\n        _this._updateLimits();\n        _this.resize();\n        _this._updateEntities(true);\n        _this._redrawLocked();\n      },\n      \"change:ui.chart.inpercent\": function changeUiChartInpercent(evt) {\n        if (!_this._readyOnce) return;\n        _this._updateLimits();\n        _this.resize();\n        _this._updateEntities();\n        _this._redrawLocked();\n      },\n      \"change:ui.chart.flipSides\": function changeUiChartFlipSides(evt) {\n        if (!_this._readyOnce) return;\n        _this.model.marker.side.switchSideState();\n        _this._updateIndicators();\n        _this.resize();\n        _this._updateEntities(true);\n        _this._redrawLocked();\n      },\n      \"change:ui.chart.lockNonSelected\": function changeUiChartLockNonSelected(evt) {\n        _this.lock = _this.model.ui.chart.lockNonSelected;\n        if (_this.lock) {\n          if (!(_this.stackKeys.length <= 1 || _this.stackSkip)) {\n            _this.model.ui.chart.lockNonSelected = 0;\n            return;\n          }\n          _this.yearLocked.text(_this.translator(\"popbyage/locked\") + \" \" + _this.lock);\n          _this._makeOutlines(_this.frameAxisX);\n        } else {\n          _this.yearLocked.text(\"\");\n          _this.lockedPaths.html(\"\");\n        }\n      }\n    };\n\n    //contructor is the same as any component\n    this._super(config, context);\n\n    this.xScale = null;\n    this.yScale = null;\n    this.cScale = null;\n\n    this.xAxis = axisSmart(\"bottom\");\n    this.xAxisLeft = axisSmart(\"bottom\");\n    this.yAxis = axisSmart(\"left\");\n    this.xScales = [];\n    this.SHIFTEDAGEDIM = \"s_age\";\n  },\n\n\n  // afterPreload: function() {\n  //   var obj = {};\n  //   obj[\"which\"] = this.model.marker.axis_x.which;\n  //   obj[\"use\"] = this.model.marker.axis_x.use;\n  //   this.model.marker_side.hook_total.set(obj);\n  // },\n\n  checkDimensions: function checkDimensions() {\n    var stackDim = this.model.entities.dim;\n    var sideDim = this.model.entities_side.dim;\n\n    this.colorUseConstant = this.model.marker.color.use == \"constant\";\n    this.stackSkip = this.colorUseConstant || stackDim == sideDim;\n    this.geoLess = stackDim !== this.geoDomainDimension && sideDim !== this.geoDomainDimension;\n    this.sideSkip = this.model.marker.side.use == \"constant\";\n  },\n\n\n  /**\n   * DOM is ready\n   */\n  readyOnce: function readyOnce() {\n    var _this = this;\n    this.el = this.el ? this.el : d3.select(this.element);\n    this.element = this.el;\n\n    this.interaction = this._interaction();\n\n    this.graph = this.element.select(\".vzb-bc-graph\");\n    this.yAxisEl = this.graph.select(\".vzb-bc-axis-y\");\n    this.xAxisEl = this.graph.select(\".vzb-bc-axis-x\");\n    this.xAxisLeftEl = this.graph.select(\".vzb-bc-axis-x-left\");\n    this.xTitleEl = this.element.select(\".vzb-bc-axis-x-title\");\n    this.xInfoEl = this.element.select(\".vzb-bc-axis-x-info\");\n    this.yTitleEl = this.graph.select(\".vzb-bc-axis-y-title\");\n    this.barsCrop = this.graph.select(\".vzb-bc-bars-crop\");\n    this.lockedCrop = this.graph.select(\".vzb-bc-locked-crop\");\n    this.labelsCrop = this.graph.select(\".vzb-bc-labels-crop\");\n    this.bars = this.barsCrop.select(\".vzb-bc-bars\");\n    this.lockedPaths = this.lockedCrop.select(\".vzb-bc-paths\");\n    this.labels = this.labelsCrop.select(\".vzb-bc-labels\");\n\n    this.title = this.element.select(\".vzb-bc-title\");\n    this.titleRight = this.element.select(\".vzb-bc-title-right\");\n    this.year = this.element.select(\".vzb-bc-year-now\");\n    this.yearLocked = this.element.select(\".vzb-bc-year-locked\");\n\n    this.geoDomainDimension = this.model.entities_geodomain.getDimension();\n    this.geoDomainDefaultValue = this.model.entities_geodomain.show[this.geoDomainDimension][\"$in\"][0];\n\n    this.someSelected = this.model.marker.select.length > 0;\n    this.nonSelectedOpacityZero = false;\n\n    this.on(\"resize\", function () {\n      _this._updateEntities();\n      _this._redrawLocked();\n    });\n\n    this._attributeUpdaters = {\n      _newWidth: function _newWidth(d, i) {\n        d[\"x_\"] = 0;\n        var width = void 0;\n        if (_this.geoLess && _this.stackSkip && _this.sideSkip) {\n          width = (_this.frameAxisX[d[_this.AGEDIM] + _this.ageShift] || {})[_this.geoDomainDefaultValue];\n        } else if (_this.geoLess && _this.stackSkip) {\n          width = _this.colorUseConstant || d[_this.PREFIXEDSIDEDIM] == d[_this.PREFIXEDSTACKDIM] ? (_this.frameAxisX[d[_this.PREFIXEDSIDEDIM]][d[_this.AGEDIM] + _this.ageShift] || {})[_this.geoDomainDefaultValue] : 0;\n        } else if (_this.geoLess && _this.sideSkip) {\n          width = (_this.frameAxisX[d[_this.PREFIXEDSTACKDIM]][d[_this.AGEDIM] + _this.ageShift] || {})[_this.geoDomainDefaultValue];\n        } else if (_this.stackSkip) {\n          width = _this.colorUseConstant || d[_this.PREFIXEDSIDEDIM] == d[_this.PREFIXEDSTACKDIM] ? _this.frameAxisX[d[_this.PREFIXEDSIDEDIM]][d[_this.AGEDIM] + _this.ageShift] : 0;\n        } else if (_this.sideSkip) {\n          width = _this.frameAxisX[d[_this.PREFIXEDSTACKDIM]][d[_this.AGEDIM] + _this.ageShift];\n        } else {\n          width = _this.frameAxisX[d[_this.PREFIXEDSTACKDIM]][d[_this.PREFIXEDSIDEDIM]][d[_this.AGEDIM] + _this.ageShift];\n        }\n        d[\"width_\"] = width ? _this.xScale(width) : 0;\n        if (_this.ui.chart.inpercent) {\n          d[\"width_\"] /= _this.total[d[_this.PREFIXEDSIDEDIM]];\n        }\n        return d.width_;\n      },\n      _newX: function _newX(d, i) {\n        var prevSbl = this.previousSibling;\n        if (prevSbl) {\n          var prevSblDatum = d3.select(prevSbl).datum();\n          d[\"x_\"] = prevSblDatum.x_ + prevSblDatum.width_;\n        } else {\n          d[\"x_\"] = 0;\n        }\n        return d.x_;\n      }\n    };\n  },\n\n\n  /*\n   * Both model and DOM are ready\n   */\n  ready: function ready() {\n    var _this2 = this;\n\n    //TODO: get component ready if some submodel doesn't ready ??????\n    if (!this.model.marker._ready) return;\n\n    var _this = this;\n\n    this.lock = _this.model.ui.chart.lockNonSelected;\n    this.timeSteps = this.model.time.getAllSteps();\n\n    this.shiftScale = d3.scale.linear().domain([this.timeSteps[0], this.timeSteps[this.timeSteps.length - 1]]).range([0, this.timeSteps.length - 1]);\n\n    this.side = this.model.marker.label_side.getEntity();\n    this.SIDEDIM = this.side.getDimension();\n    this.PREFIXEDSIDEDIM = \"side_\" + this.SIDEDIM;\n    this.stack = this.model.marker.label_stack.getEntity();\n    this.STACKDIM = this.stack.getDimension(); // || this.geoDomainDimension;//this.model.marker.color.which;\n    this.PREFIXEDSTACKDIM = \"stack_\" + this.STACKDIM;\n    this.age = this.model.marker.axis_y.getEntity();\n    this.AGEDIM = this.age.getDimension();\n    this.TIMEDIM = this.model.time.getDimension();\n    this.groupBy = this.age.grouping || 1;\n    this.checkDimensions();\n    this.updateUIStrings();\n    this._updateIndicators();\n\n    if (this.lock && (this.stackKeys.length <= 1 || this.stackSkip)) {\n      this.yearLocked.text(this.translator(\"popbyage/locked\") + \" \" + this.lock);\n    } else {\n      _this.model.ui.chart.lockNonSelected = 0;\n    }\n\n    this.frame = null;\n    this.frameAllColor = {};\n    this.model.marker.getFrame(_this.model.time.value, function (frame) {\n      _this.frame = frame;\n      _this.frameAxisX = frame.axis_x;\n\n      _this._createLimits();\n      _this._updateLimits();\n\n      _this.resize();\n      _this2.model.marker_allpossible.getFrame(_this.model.time.value, function (apFrame) {\n        _this.frameAllColor = apFrame.color || {};\n        _this._updateEntities(true);\n        _this.updateBarsOpacity();\n        _this._redrawLocked();\n      });\n    });\n  },\n  _redrawLocked: function _redrawLocked() {\n    var _this = this;\n    if (!this.lock) return;\n\n    this.model.marker.getFrame(this.model.time.parse(\"\" + this.lock), function (lockFrame) {\n      if (!lockFrame) return;\n      _this.lockedPaths.html(\"\");\n      _this._makeOutlines(lockFrame.axis_x);\n    });\n  },\n  interpolateDiagonal: function interpolateDiagonal(pValues, nValues, fraction) {\n    var _this = this;\n    var dataBetweenFrames = {};\n    var data = void 0;\n    var val1 = void 0,\n        val2 = void 0,\n        shiftedAge = void 0;\n    var groupBy = this.groupBy;\n    if (this.geoLess && this.stackSkip && this.sideSkip) {\n      data = dataBetweenFrames;\n      utils.forEach(_this.ageKeys, function (age) {\n        shiftedAge = +age + groupBy;\n        val1 = pValues[age][_this.geoDomainDefaultValue];\n        val2 = (nValues[shiftedAge] || {})[_this.geoDomainDefaultValue] || 0;\n        data[shiftedAge] = {};\n        data[shiftedAge][_this.geoDomainDefaultValue] = val1 == null || val2 == null ? null : val1 + (val2 - val1) * fraction;\n      });\n      data[0] = {};\n      data[0][_this.geoDomainDefaultValue] = nValues[0][_this.geoDomainDefaultValue] || 0;\n    } else if (this.stackSkip && this.geoLess) {\n      utils.forEach(_this.sideKeys, function (side) {\n        data = dataBetweenFrames[side] = {};\n        utils.forEach(_this.ageKeys, function (age) {\n          shiftedAge = +age + groupBy;\n          val1 = pValues[side][age][_this.geoDomainDefaultValue];\n          val2 = (nValues[side][shiftedAge] || {})[_this.geoDomainDefaultValue] || 0;\n          data[shiftedAge] = {};\n          data[shiftedAge][_this.geoDomainDefaultValue] = val1 == null || val2 == null ? null : val1 + (val2 - val1) * fraction;\n        });\n        data[0] = {};\n        data[0][_this.geoDomainDefaultValue] = nValues[side][0][_this.geoDomainDefaultValue] || 0;\n      });\n    } else if (this.stackSkip) {\n      utils.forEach(_this.sideKeys, function (side) {\n        data = dataBetweenFrames[side] = {};\n        utils.forEach(_this.ageKeys, function (age) {\n          shiftedAge = +age + groupBy;\n          val1 = pValues[side][age];\n          val2 = nValues[side][shiftedAge] || 0;\n          data[shiftedAge] = val1 == null || val2 == null ? null : val1 + (val2 - val1) * fraction;\n        });\n        data[0] = nValues[side][0] || 0;\n      });\n    } else if (this.sideSkip && this.geoLess) {\n      utils.forEach(_this.stackKeys, function (stack) {\n        data = dataBetweenFrames[stack] = {};\n        utils.forEach(_this.ageKeys, function (age) {\n          shiftedAge = +age + groupBy;\n          val1 = pValues[stack][age][_this.geoDomainDefaultValue];\n          val2 = (nValues[stack][shiftedAge] || {})[_this.geoDomainDefaultValue] || 0;\n          data[shiftedAge] = {};\n          data[shiftedAge][_this.geoDomainDefaultValue] = val1 == null || val2 == null ? null : val1 + (val2 - val1) * fraction;\n        });\n        data[0] = {};\n        data[0][_this.geoDomainDefaultValue] = nValues[stack][0][_this.geoDomainDefaultValue] || 0;\n      });\n    } else if (this.sideSkip) {\n      utils.forEach(_this.stackKeys, function (stack) {\n        data = dataBetweenFrames[stack] = {};\n        utils.forEach(_this.ageKeys, function (age) {\n          shiftedAge = +age + groupBy;\n          val1 = pValues[stack][age];\n          val2 = nValues[stack][shiftedAge] || 0;\n          data[shiftedAge] = val1 == null || val2 == null ? null : val1 + (val2 - val1) * fraction;\n        });\n        data[0] = nValues[stack][0] || 0;\n      });\n    } else {\n      utils.forEach(_this.stackKeys, function (stack) {\n        dataBetweenFrames[stack] = {};\n        utils.forEach(_this.sideKeys, function (side) {\n          data = dataBetweenFrames[stack][side] = {};\n          utils.forEach(_this.ageKeys, function (age) {\n            shiftedAge = +age + groupBy;\n            val1 = pValues[stack][side][age];\n            val2 = nValues[stack][side][shiftedAge] || 0;\n            data[shiftedAge] = val1 == null || val2 == null ? null : val1 + (val2 - val1) * fraction;\n          });\n          data[0] = nValues[stack][side][0] || 0;\n        });\n      });\n    }\n    return dataBetweenFrames;\n  },\n  updateUIStrings: function updateUIStrings() {\n    var _this = this;\n    this.translator = this.model.locale.getTFunction();\n\n    var xTitle = this.xTitleEl.selectAll(\"text\").data([0]);\n    xTitle.enter().append(\"text\");\n    xTitle.on(\"click\", function () {\n      _this.parent.findChildByName(\"gapminder-treemenu\").markerID(\"axis_x\").alignX(_this.model.locale.isRTL() ? \"right\" : \"left\").alignY(\"top\").updateView().toggle();\n    });\n\n    utils.setIcon(this.xInfoEl, iconQuestion).select(\"svg\").attr(\"width\", \"0px\").attr(\"height\", \"0px\");\n\n    this.xInfoEl.on(\"click\", function () {\n      _this.parent.findChildByName(\"gapminder-datanotes\").pin();\n    });\n    this.xInfoEl.on(\"mouseover\", function () {\n      if (_this.model.time.dragging) return;\n      var rect = this.getBBox();\n      var coord = utils.makeAbsoluteContext(this, this.farthestViewportElement)(rect.x - 10, rect.y + rect.height + 10);\n      var toolRect = _this.root.element.getBoundingClientRect();\n      var chartRect = _this.element.node().getBoundingClientRect();\n      _this.parent.findChildByName(\"gapminder-datanotes\").setHook(\"axis_x\").show().setPos(coord.x + chartRect.left - toolRect.left, coord.y);\n    });\n    this.xInfoEl.on(\"mouseout\", function () {\n      if (_this.model.time.dragging) return;\n      _this.parent.findChildByName(\"gapminder-datanotes\").hide();\n    });\n\n    // var titleStringY = this.model.marker.axis_y.getConceptprops().name;\n\n    // var yTitle = this.yTitleEl.selectAll(\"text\").data([0]);\n    // yTitle.enter().append(\"text\");\n    // yTitle\n    //   .attr(\"y\", \"-6px\")\n    //   .attr(\"x\", \"-9px\")\n    //   .attr(\"dx\", \"-0.72em\")\n    //   .text(titleStringY);\n  },\n\n\n  /**\n   * Changes labels for indicators\n   */\n  _updateIndicators: function _updateIndicators() {\n    var _this3 = this;\n\n    var _this = this;\n    this.duration = this.model.time.delayAnimations;\n    this.yScale = this.model.marker.axis_y.getScale();\n    this.xScale = this.model.marker.axis_x.getScale();\n    this.yAxis.tickFormat(_this.model.marker.axis_y.getTickFormatter());\n    this.xAxis.tickFormat(_this.model.marker.axis_x.getTickFormatter());\n    this.xAxisLeft.tickFormat(_this.model.marker.axis_x.getTickFormatter());\n\n    var sideDim = this.SIDEDIM;\n    var stackDim = this.STACKDIM;\n    var ageDim = this.AGEDIM;\n    var groupBy = this.groupBy;\n\n    var ages = this.model.marker.getKeys(ageDim);\n    var ageKeys = [];\n    ageKeys = ages.map(function (m) {\n      return m[ageDim];\n    });\n    this.ageKeys = ageKeys;\n\n    this.shiftedAgeKeys = this.timeSteps.map(function (m, i) {\n      return -i * groupBy;\n    }).slice(1).reverse().concat(ageKeys);\n\n    var sideItems = this.model.marker.label_side.getItems();\n    //var sideKeys = Object.keys(sideItems);\n    var sideKeys = [];\n    if (!utils.isEmpty(sideItems)) {\n      var sideFiltered = !!this.model.marker.side.getEntity().show[sideDim];\n      var sides = this.model.marker.getKeys(sideDim).filter(function (f) {\n        return !sideFiltered || _this3.model.marker.side.getEntity().isShown(f);\n      });\n      sideKeys = sides.map(function (m) {\n        return m[sideDim];\n      });\n\n      if (sideKeys.length > 2) sideKeys.length = 2;\n      if (sideKeys.length > 1) {\n        var sortFunc = this.ui.chart.flipSides ? d3.ascending : d3.descending;\n        sideKeys.sort(sortFunc);\n      }\n    }\n    if (!sideKeys.length) sideKeys.push(\"undefined\");\n    this.sideKeys = sideKeys;\n\n    var stacks = this.model.marker.getKeys(stackDim);\n    var stackKeys = stacks.map(function (m) {\n      return m[stackDim];\n    });\n\n    var sortedStackKeys = utils.keys(this.model.marker.color.getPalette()).reduce(function (arr, val) {\n      if (stackKeys.indexOf(val) != -1) arr.push(val);\n      return arr;\n    }, []);\n\n    if (sortedStackKeys.length != stackKeys.length) {\n      sortedStackKeys = stackKeys.reduce(function (arr, val) {\n        if (arr.indexOf(val) == -1) arr.push(val);\n        return arr;\n      }, sortedStackKeys);\n    }\n    this.stackKeys = sortedStackKeys;\n    this.stackItems = this.model.marker.label_stack.getItems();\n\n    this.stacked = this.ui.chart.stacked && this.model.marker.color.use != \"constant\" && this.stack.getDimension();\n\n    this.twoSided = this.sideKeys.length > 1;\n    this.titleRight.classed(\"vzb-hidden\", !this.twoSided);\n    if (this.twoSided) {\n      this.xScaleLeft = this.xScale.copy();\n      this.title.text(sideItems[this.sideKeys[1]]);\n      this.titleRight.text(sideItems[this.sideKeys[0]]);\n    } else {\n      var title = this.sideKeys.length && sideItems[this.sideKeys[0]] ? sideItems[this.sideKeys[0]] : \"\";\n      this.title.text(title);\n    }\n\n    this.cScale = this.model.marker.color.getScale();\n\n    var shiftedAgeDim = this.SHIFTEDAGEDIM;\n    this.markers = this.model.marker.getKeys(ageDim);\n  },\n  _createLimits: function _createLimits() {\n    var _this = this;\n    var axisX = this.model.marker.axis_x;\n\n    //const sideKeysNF = Object.keys(this.model.marker.side.getItems());\n    var sideKeysNF = Object.keys(this.model.marker.side.getNestedItems([this.SIDEDIM]));\n    if (!sideKeysNF.length) sideKeysNF.push(\"undefined\");\n\n    var keys = this.stackSkip && this.sideSkip ? [] : this.sideSkip ? [this.STACKDIM] : this.stackSkip ? [this.SIDEDIM] : [this.STACKDIM, this.SIDEDIM];\n    var limits = axisX.getLimitsByDimensions(keys.concat([this.AGEDIM, this.TIMEDIM]));\n    var timeKeys = axisX.getUnique();\n    var totals = {};\n    var inpercentMaxLimits = {};\n    var maxLimits = {};\n    sideKeysNF.forEach(function (s) {\n      maxLimits[s] = [];\n      inpercentMaxLimits[s] = [];\n    });\n\n    if (_this.stackSkip && _this.sideSkip) {\n      utils.forEach(timeKeys, function (time) {\n        totals[time] = {};\n        var ageSum = 0;\n        var sideMaxLimits = [];\n        utils.forEach(_this.ageKeys, function (age) {\n          var stackSum = 0;\n          if (limits[age] && limits[age][time]) {\n            stackSum += limits[age][time].max;\n            ageSum += stackSum;\n          }\n          sideMaxLimits.push(stackSum);\n        });\n        totals[time][sideKeysNF[0]] = ageSum;\n        var maxSideLimit = Math.max.apply(Math, sideMaxLimits);\n        inpercentMaxLimits[sideKeysNF[0]].push(maxSideLimit / ageSum);\n        maxLimits[sideKeysNF[0]].push(maxSideLimit);\n      });\n    } else if (_this.sideSkip) {\n      utils.forEach(timeKeys, function (time) {\n        totals[time] = {};\n        var ageSum = 0;\n        var sideMaxLimits = [];\n        utils.forEach(_this.ageKeys, function (age) {\n          var stackSum = 0;\n          utils.forEach(_this.stackKeys, function (stack) {\n            if (limits[stack] && limits[stack][age] && limits[stack][age][time]) {\n              stackSum += limits[stack][age][time].max;\n              ageSum += stackSum;\n            }\n          });\n          sideMaxLimits.push(stackSum);\n        });\n        totals[time][sideKeysNF[0]] = ageSum;\n        var maxSideLimit = Math.max.apply(Math, sideMaxLimits);\n        inpercentMaxLimits[sideKeysNF[0]].push(maxSideLimit / ageSum);\n        maxLimits[sideKeysNF[0]].push(maxSideLimit);\n      });\n    } else if (_this.stackSkip) {\n      utils.forEach(timeKeys, function (time) {\n        totals[time] = {};\n        utils.forEach(sideKeysNF, function (side) {\n          var ageSum = 0;\n          var sideMaxLimits = [];\n          utils.forEach(_this.ageKeys, function (age) {\n            var stackSum = 0;\n            if (limits[side] && limits[side][age] && limits[side][age][time]) {\n              stackSum += limits[side][age][time].max;\n              ageSum += stackSum;\n            }\n            sideMaxLimits.push(stackSum);\n          });\n          totals[time][side] = ageSum;\n          var maxSideLimit = Math.max.apply(Math, sideMaxLimits);\n          inpercentMaxLimits[side].push(maxSideLimit / ageSum);\n          maxLimits[side].push(maxSideLimit);\n        });\n      });\n    } else {\n      utils.forEach(timeKeys, function (time) {\n        totals[time] = {};\n        utils.forEach(sideKeysNF, function (side) {\n          var ageSum = 0;\n          var sideMaxLimits = [];\n          utils.forEach(_this.ageKeys, function (age) {\n            var stackSum = 0;\n            utils.forEach(_this.stackKeys, function (stack) {\n              if (limits[stack][side] && limits[stack][side][age] && limits[stack][side][age][time]) {\n                stackSum += limits[stack][side][age][time].max;\n                ageSum += stackSum;\n              }\n            });\n            sideMaxLimits.push(stackSum);\n          });\n          totals[time][side] = ageSum;\n          var maxSideLimit = Math.max.apply(Math, sideMaxLimits);\n          inpercentMaxLimits[side].push(maxSideLimit / ageSum);\n          maxLimits[side].push(maxSideLimit);\n        });\n      });\n    }\n\n    this.maxLimits = {};\n    this.inpercentMaxLimits = {};\n    sideKeysNF.forEach(function (s) {\n      _this.maxLimits[s] = Math.max.apply(Math, _toConsumableArray(maxLimits[s]));\n      _this.inpercentMaxLimits[s] = Math.max.apply(Math, _toConsumableArray(inpercentMaxLimits[s]));\n    });\n    this.totals = totals;\n  },\n  _updateLimits: function _updateLimits() {\n    var _this = this;\n    var axisX = this.model.marker.axis_x;\n    var domain = void 0;\n    if (this.ui.chart.inpercent) {\n      domain = [0, Math.max.apply(Math, _toConsumableArray(this.sideKeys.map(function (s) {\n        return _this.inpercentMaxLimits[s];\n      })))];\n    } else {\n      domain = axisX.domainMin != null && axisX.domainMax != null ? [+axisX.domainMin, +axisX.domainMax] : [0, Math.max.apply(Math, _toConsumableArray(this.sideKeys.map(function (s) {\n        return _this.maxLimits[s];\n      })))];\n    }\n    this.xScale.domain(domain);\n    if (this.xScaleLeft) this.xScaleLeft.domain(this.xScale.domain());\n  },\n  _interpolateBetweenTotals: function _interpolateBetweenTotals(timeSteps, totals, time) {\n    var nextStep = d3.bisectLeft(timeSteps, time);\n    var fraction = (time - timeSteps[nextStep - 1]) / (timeSteps[nextStep] - timeSteps[nextStep - 1]);\n    var total = {};\n    utils.forEach(this.sideKeys, function (side) {\n      total[side] = totals[timeSteps[nextStep]][side] * fraction + totals[timeSteps[nextStep - 1]][side] * (1 - fraction);\n    });\n    return total;\n  },\n\n\n  /**\n   * Updates entities\n   */\n  _updateEntities: function _updateEntities(reorder) {\n\n    var _this = this;\n    var time = this.model.time;\n    var sideDim = this.SIDEDIM;\n    var prefixedSideDim = this.PREFIXEDSIDEDIM;\n    var ageDim = this.AGEDIM;\n    var stackDim = this.STACKDIM;\n    var prefixedStackDim = this.PREFIXEDSTACKDIM;\n    var timeDim = this.TIMEDIM;\n    var duration = time.playing ? time.delayAnimations : 0;\n    var total = void 0;\n\n    var groupBy = this.groupBy;\n    //var group_offset = this.model.marker.group_offset ? Math.abs(this.model.marker.group_offset % groupBy) : 0;\n\n    if (this.ui.chart.inpercent) {\n      this.total = this.totals[time.value] ? this.totals[time.value] : this._interpolateBetweenTotals(this.timeSteps, this.totals, time.value);\n    }\n\n    var domain = this.yScale.domain();\n\n    //this.model.age.setVisible(markers);\n\n    var nextStep = d3.bisectLeft(this.timeSteps, time.value);\n\n    var shiftedAgeDim = this.SHIFTEDAGEDIM;\n\n    var markers = this.markers.map(function (data) {\n      var o = {};\n      o[ageDim] = o[shiftedAgeDim] = +data[ageDim];\n      o[ageDim] -= nextStep * groupBy;\n      return o;\n    });\n\n    var ageData = markers.slice(0);\n\n    var outAge = {};\n    outAge[shiftedAgeDim] = markers.length * groupBy;\n    outAge[ageDim] = outAge[shiftedAgeDim] - nextStep * groupBy;\n\n    this.ageShift = nextStep * groupBy;\n\n    if (nextStep) ageData.push(outAge);\n\n    var stacks = _this.stacked ? _this.stackKeys : [_this.geoDomainDefaultValue];\n    var geoDomainDefaultValue = this.geoDomainDefaultValue;\n    var geoDomainDimension = this.geoDomainDimension;\n\n    var _loop = function _loop(i, j) {\n      var d = ageData[i];\n      d[\"side\"] = _this.sideKeys.map(function (m) {\n        var r = {};\n        r[ageDim] = d[ageDim];\n        r[shiftedAgeDim] = d[shiftedAgeDim];\n        r[prefixedSideDim] = m;\n        r[sideDim] = m;\n        r[\"stack\"] = stacks.map(function (m) {\n          var s = {};\n          s[geoDomainDimension] = geoDomainDefaultValue;\n          s[ageDim] = r[ageDim];\n          s[shiftedAgeDim] = r[shiftedAgeDim];\n          s[sideDim] = r[sideDim];\n          s[stackDim] = m;\n          s[prefixedSideDim] = r[prefixedSideDim];\n          s[prefixedStackDim] = m;\n          return s;\n        });\n        return r;\n      });\n    };\n\n    for (var i = 0, j = ageData.length; i < j; i++) {\n      _loop(i, j);\n    }\n\n    this.barsData = ageData;\n\n    var ageBars = this.bars.selectAll(\".vzb-bc-bar\").data(ageData, function (d) {\n      return d[ageDim];\n    });\n    //exit selection\n    ageBars.exit().remove();\n\n    var oneBarHeight = this.oneBarHeight;\n    var barHeight = this.barHeight;\n    var firstBarOffsetY = this.firstBarOffsetY;\n\n    //enter selection -- init bars\n    ageBars = ageBars.enter().append(\"g\").attr(\"class\", function (d) {\n      return \"vzb-bc-bar \" + \"vzb-bc-bar-\" + d[ageDim];\n    }).attr(\"transform\", function (d, i) {\n      return \"translate(0,\" + (firstBarOffsetY - (d[shiftedAgeDim] - domain[0] - groupBy) * oneBarHeight) + \")\";\n    }).merge(ageBars);\n\n    // this.ageBars.attr(\"class\", function(d) {\n    //     return \"vzb-bc-bar \" + \"vzb-bc-bar-\" + d[ageDim];\n    //   })\n\n\n    var sideBars = ageBars.selectAll(\".vzb-bc-side\").data(function (d) {\n      return d.side;\n    }, function (d) {\n      return d[prefixedSideDim];\n    });\n\n    sideBars.exit().remove();\n    sideBars = sideBars.enter().append(\"g\").attr(\"class\", function (d, i) {\n      return \"vzb-bc-side \" + \"vzb-bc-side-\" + (!i != !_this.twoSided ? \"right\" : \"left\");\n    }).attr(\"transform\", function (d, i) {\n      return i ? \"scale(-1,1) translate(\" + _this.activeProfile.centerWidth + \",0)\" : \"\";\n    }).merge(sideBars);\n\n    if (reorder) {\n      sideBars.attr(\"class\", function (d, i) {\n        return \"vzb-bc-side \" + \"vzb-bc-side-\" + (!i != !_this.twoSided ? \"right\" : \"left\");\n      }).attr(\"transform\", function (d, i) {\n        return i ? \"scale(-1,1) translate(\" + _this.activeProfile.centerWidth + \",0)\" : \"\";\n      });\n    }\n\n    var _attributeUpdaters = this._attributeUpdaters;\n\n    var stackBars = sideBars.selectAll(\".vzb-bc-stack\").data(function (d) {\n      return d.stack;\n    }, function (d) {\n      return d[prefixedStackDim];\n    });\n\n    stackBars.exit().remove();\n    stackBars = stackBars.enter().append(\"rect\").attr(\"class\", function (d, i) {\n      return \"vzb-bc-stack \" + \"vzb-bc-stack-\" + i + (_this.highlighted ? \" vzb-dimmed\" : \"\");\n    }).attr(\"y\", 0).attr(\"height\", barHeight).attr(\"fill\", function (d) {\n      return _this.cScale(_this.frameAllColor[d[prefixedStackDim]] || d[prefixedStackDim]);\n    }).attr(\"width\", _attributeUpdaters._newWidth).attr(\"x\", _attributeUpdaters._newX).on(\"mouseover\", _this.interaction.mouseover).on(\"mouseout\", _this.interaction.mouseout).on(\"click\", _this.interaction.click).onTap(_this.interaction.tap).merge(stackBars);\n\n    if (reorder) stackBars.attr(\"class\", function (d, i) {\n      return \"vzb-bc-stack \" + \"vzb-bc-stack-\" + i + (_this.highlighted ? \" vzb-dimmed\" : \"\");\n    }).attr(\"fill\", function (d) {\n      return _this.cScale(_this.frameAllColor[d[prefixedStackDim]] || d[prefixedStackDim]);\n    }).order();\n\n    var stepShift = ageData[0][shiftedAgeDim] - ageData[0][ageDim] - this.shiftScale(time.value) * groupBy;\n\n    if (duration) {\n      var transition = d3.transition().duration(duration).ease(d3.easeLinear);\n\n      ageBars.transition(transition).attr(\"transform\", function (d, i) {\n        return \"translate(0,\" + (firstBarOffsetY - (d[shiftedAgeDim] - domain[0] - stepShift) * oneBarHeight) + \")\";\n      });\n      stackBars.transition(transition).attr(\"width\", _attributeUpdaters._newWidth).attr(\"x\", _attributeUpdaters._newX);\n    } else {\n      ageBars.interrupt().attr(\"transform\", function (d, i) {\n        return \"translate(0,\" + (firstBarOffsetY - (d[shiftedAgeDim] - domain[0] - stepShift) * oneBarHeight) + \")\";\n      });\n      stackBars.interrupt().attr(\"width\", _attributeUpdaters._newWidth).attr(\"x\", _attributeUpdaters._newX);\n    }\n\n    this.ageBars = ageBars;\n    this.sideBars = sideBars;\n    this.stackBars = stackBars;\n\n    this.entityLabels = this.labels.selectAll(\".vzb-bc-label text\").data(markers);\n    //exit selection\n    this.entityLabels.exit().remove();\n\n    this.entityLabels = this.entityLabels.enter().append(\"g\").attr(\"class\", \"vzb-bc-label\").attr(\"id\", function (d) {\n      return \"vzb-bc-label-\" + d[shiftedAgeDim] + \"-\" + _this._id;\n    }).append(\"text\").attr(\"class\", \"vzb-bc-age\").merge(this.entityLabels).each(function (d, i) {\n      var yearOlds = _this.translator(\"popbyage/yearOlds\");\n\n      var age = parseInt(d[shiftedAgeDim], 10);\n\n      if (groupBy > 1) {\n        age = age + \"-to-\" + (age + groupBy - 1);\n      }\n\n      d[\"text\"] = age + yearOlds;\n    }).attr(\"y\", function (d, i) {\n      return firstBarOffsetY - (d[shiftedAgeDim] - domain[0]) * oneBarHeight - 10;\n    });\n    // .style(\"fill\", function(d) {\n    //   var color = _this.cScale(values.color[d[ageDim]]);\n    //   return d3.rgb(color).darker(2);\n    // });\n\n    if (duration) {\n      this.year.transition().duration(duration).ease(d3.easeLinear).on(\"end\", this._setYear(time.value));\n    } else {\n      this.year.interrupt().text(time.formatDate(time.value)).transition();\n    }\n  },\n  _makeOutlines: function _makeOutlines(frame) {\n    var _this = this;\n\n    var KEYS = utils.unique(this.model.marker._getAllDimensions({ exceptType: \"time\" }));\n    KEYS.forEach(function (key, i) {\n      if (key === _this.AGEDIM) KEYS[i] = _this.SHIFTEDAGEDIM;\n      //if (_this.geoLess)\n    });\n\n    var barHeight = this.barHeight;\n    var firstBarOffsetY = this.firstBarOffsetY + barHeight;\n\n    var line = d3.line().curve(d3.curveStepBefore).x(function (d) {\n      return d.x;\n    }) //_ + d.width_)\n    .y(function (d, i) {\n      return firstBarOffsetY - barHeight * i;\n    });\n\n    var stackIndex = [0, 0];\n\n    var pathsData = this.sideKeys.map(function (s, i) {\n      if (_this.stackSkip) {\n        _this.barsData[0].side[i].stack.forEach(function (d, j) {\n          if (d[_this.PREFIXEDSIDEDIM] === d[_this.PREFIXEDSTACKDIM]) {\n            stackIndex[i] = j;\n          }\n        });\n      }\n      var data = {};\n      data.d = _this.barsData.map(function (age) {\n        var r = {};\n        var x = utils.getValueMD(age.side[i].stack[stackIndex[i]], frame, KEYS);\n        r.x = x ? _this.xScale(x) : 0;\n        if (_this.ui.chart.inpercent) {\n          r.x /= _this.total[age.side[i].stack[stackIndex[i]][_this.PREFIXEDSIDEDIM]];\n        }\n        return r;\n      });\n      return data;\n    });\n\n    var data = this.bars.selectAll(\".vzb-bc-side-left\").selectAll(\".vzb-bc-stack-0\").data();\n    var color = _this.cScale(data[0][this.PREFIXEDSTACKDIM]);\n    var colorShade = this.model.marker.color.getColorShade({\n      colorID: _this.frameAllColor[data[0][this.PREFIXEDSTACKDIM]] || data[0][this.PREFIXEDSTACKDIM],\n      shadeID: \"shade\"\n    }) || \"#000\"; //d3.hsl(color).darker(2);\n\n    var paths = this.lockedPaths.selectAll(\"path\").data(pathsData);\n    paths.exit().remove();\n    paths.enter().append(\"path\").merge(paths).attr(\"d\", function (d) {\n      return line(d.d);\n    }).attr(\"stroke\", \"#000\") //colorShade)\n    .attr(\"transform\", function (d, i) {\n      return i ? \"scale(-1,1) translate(\" + _this.activeProfile.centerWidth + \",0)\" : \"\";\n    });\n  },\n  _setYear: function _setYear(timeValue) {\n    var formattedTime = this.model.time.formatDate(timeValue);\n    return function () {\n      d3.select(this).text(formattedTime);\n    };\n  },\n  _interaction: function _interaction() {\n    var _this = this;\n    return {\n      mouseover: function mouseover(d, i) {\n        if (utils.isTouchDevice()) return;\n        _this.model.marker.highlightMarker(d);\n        _this._showLabel(d);\n      },\n      mouseout: function mouseout(d, i) {\n        if (utils.isTouchDevice()) return;\n        _this.model.marker.clearHighlighted();\n      },\n      click: function click(d, i) {\n        if (utils.isTouchDevice()) return;\n        _this.model.marker.selectMarker(d);\n      },\n      tap: function tap(d) {\n        d3.event.stopPropagation();\n        _this.model.marker.selectMarker(d);\n      }\n    };\n  },\n  _highlightBars: function _highlightBars(d) {\n    var _this = this;\n\n    _this.someHighlighted = _this.model.marker.highlight.length > 0;\n\n    _this.updateBarsOpacity();\n\n    if (!_this.someHighlighted) {\n      //hide labels\n      _this.labels.selectAll(\".vzb-hovered\").classed(\"vzb-hovered\", false);\n    }\n  },\n  _showLabel: function _showLabel(d) {\n    var _this = this;\n    var formatter = _this.ui.chart.inpercent ? d3.format(\".1%\") : _this.model.marker.axis_x.getTickFormatter();\n    var sideDim = _this.SIDEDIM;\n    var ageDim = _this.AGEDIM;\n    var stackDim = _this.STACKDIM;\n    var shiftedAgeDim = \"s_age\";\n\n    var left = _this.sideKeys.indexOf(d[sideDim]) > 0;\n    var label = _this.labels.select(\"#vzb-bc-label-\" + d[shiftedAgeDim] + \"-\" + _this._id);\n    label.selectAll(\".vzb-bc-age\").text(function (textData) {\n      //var total = _this.ui.chart.inpercent ? _this.totalValues[d[sideDim]] : 1;\n      var text = _this.stackKeys.length > 1 ? _this.stackItems[d[stackDim]] : textData.text;\n      text = _this.twoSided ? text : textData.text + \" \" + _this.stackItems[d[stackDim]];\n      var value = _this.xScale.invert(d[\"width_\"]);\n      return text + \": \" + formatter(value);\n    }).attr(\"x\", (left ? -1 : 1) * (_this.activeProfile.centerWidth * 0.5 + 7)).classed(\"vzb-text-left\", left);\n\n    label.classed(\"vzb-hovered\", true);\n  },\n\n\n  /**\n   * Executes everytime the container or vizabi is resized\n   * Ideally,it contains only operations related to size\n   */\n\n  presentationProfileChanges: {\n    medium: {\n      margin: { right: 80, bottom: 80 },\n      infoElHeight: 32\n    },\n    large: {\n      margin: { top: 100, right: 100, left: 100, bottom: 80 },\n      infoElHeight: 32\n    }\n  },\n\n  profiles: {\n    \"small\": {\n      margin: {\n        top: 70,\n        right: 20,\n        left: 40,\n        bottom: 40\n      },\n      infoElHeight: 16,\n      centerWidth: 2,\n      titlesSpacing: 5\n    },\n    \"medium\": {\n      margin: {\n        top: 80,\n        right: 60,\n        left: 60,\n        bottom: 40\n      },\n      infoElHeight: 20,\n      centerWidth: 2,\n      titlesSpacing: 10\n    },\n    \"large\": {\n      margin: {\n        top: 100,\n        right: 60,\n        left: 60,\n        bottom: 40\n      },\n      infoElHeight: 22,\n      centerWidth: 2,\n      titlesSpacing: 20\n    }\n  },\n\n  resize: function resize() {\n\n    var _this = this;\n\n    this.activeProfile = this.getActiveProfile(this.profiles, this.presentationProfileChanges);\n\n    //this.activeProfile = this.profiles[this.getLayoutProfile()];\n    var margin = this.activeProfile.margin;\n    var infoElHeight = this.activeProfile.infoElHeight;\n\n    //stage\n    this.height = parseInt(this.element.style(\"height\"), 10) - margin.top - margin.bottom || 0;\n    this.width = parseInt(this.element.style(\"width\"), 10) - margin.left - margin.right || 0;\n\n    if (this.height <= 0 || this.width <= 0) return utils.warn(\"Pop by age resize() abort: vizabi container is too little or has display:none\");\n\n    this.graph.attr(\"transform\", \"translate(\" + margin.left + \",\" + margin.top + \")\");\n\n    this.barsCrop.attr(\"width\", this.width).attr(\"height\", Math.max(0, this.height));\n\n    this.lockedCrop.attr(\"width\", this.width).attr(\"height\", Math.max(0, this.height));\n\n    this.labelsCrop.attr(\"width\", this.width).attr(\"height\", Math.max(0, this.height));\n\n    var groupBy = this.groupBy;\n\n    var domain = this.yScale.domain();\n    this.oneBarHeight = this.height / (domain[1] - domain[0]);\n    var barHeight = this.barHeight = this.oneBarHeight * groupBy; // height per bar is total domain height divided by the number of possible markers in the domain\n    this.firstBarOffsetY = this.height - this.barHeight;\n\n    if (this.stackBars) this.stackBars.attr(\"height\", barHeight);\n\n    if (this.sideBars) this.sideBars.attr(\"transform\", function (d, i) {\n      return i ? \"scale(-1,1) translate(\" + _this.activeProfile.centerWidth + \",0)\" : \"\";\n    });\n\n    //update scales to the new range\n    this.yScale.range([this.height, 0]);\n\n    var maxRange = this.twoSided ? (this.width - this.activeProfile.centerWidth) * 0.5 : this.width;\n\n    this.xScale.range([0, maxRange]);\n\n    //apply scales to axes and redraw\n    this.yAxis.scale(this.yScale).tickSizeInner(-this.width).tickSizeOuter(0).tickPadding(6).tickSizeMinor(-this.width, 0).labelerOptions({\n      scaleType: this.model.marker.axis_y.scaleType,\n      toolMargin: margin,\n      limitMaxTickNumber: 19\n    });\n\n    var format = this.ui.chart.inpercent ? d3.format((groupBy > 3 ? \"\" : \".1\") + \"%\") : this.model.marker.axis_x.getTickFormatter();\n\n    this.xAxis.scale(this.xScale).tickFormat(format).tickSizeInner(-this.height).tickSizeOuter(0).tickPadding(6).tickSizeMinor(-this.height, 0).labelerOptions({\n      scaleType: this.model.marker.axis_x.scaleType,\n      toolMargin: margin,\n      limitMaxTickNumber: 6\n    });\n\n    var translateX = this.twoSided ? (this.width + _this.activeProfile.centerWidth) * 0.5 : 0;\n\n    this.xAxisEl.attr(\"transform\", \"translate(\" + translateX + \",\" + this.height + \")\").call(this.xAxis);\n\n    this.yAxisEl.attr(\"transform\", \"translate(\" + 0 + \",0)\").call(this.yAxis);\n    //this.xAxisEl.call(this.xAxis);\n    this.xAxisLeftEl.classed(\"vzb-hidden\", !this.twoSided);\n    if (this.twoSided) {\n      if (this.model.marker.axis_x.scaleType !== \"ordinal\") {\n        this.xScaleLeft.range([(this.width - this.activeProfile.centerWidth) * 0.5, 0]);\n      } else {\n        this.xScaleLeft.rangePoints([(this.width - this.activeProfile.centerWidth) * 0.5, 0]).range();\n      }\n\n      this.xAxisLeft.scale(this.xScaleLeft).tickFormat(format).tickSizeInner(-this.height).tickSizeOuter(0).tickPadding(6).tickSizeMinor(-this.height, 0).labelerOptions({\n        scaleType: this.model.marker.axis_x.scaleType,\n        toolMargin: margin,\n        limitMaxTickNumber: 6\n      });\n\n      this.xAxisLeftEl.attr(\"transform\", \"translate(0,\" + this.height + \")\").call(this.xAxisLeft);\n      var zeroTickEl = this.xAxisEl.select(\".tick text\");\n      if (!zeroTickEl.empty()) {\n        var zeroTickWidth = zeroTickEl.node().getBBox().width;\n        zeroTickEl.attr(\"dx\", -(this.activeProfile.centerWidth + zeroTickWidth) * 0.5);\n      }\n      this.xAxisEl.select(\".tick line\").classed(\"vzb-hidden\", true);\n\n      //hide left axis zero tick\n      var tickNodes = this.xAxisLeftEl.selectAll(\".tick\").nodes();\n      d3.select(tickNodes[tickNodes.length - 1]).classed(\"vzb-hidden\", true);\n    }\n\n    var isRTL = this.model.locale.isRTL();\n\n    this.bars.attr(\"transform\", \"translate(\" + translateX + \",0)\");\n    this.lockedPaths.attr(\"transform\", \"translate(\" + translateX + \",0)\");\n    this.labels.attr(\"transform\", \"translate(\" + translateX + \",0)\");\n\n    this.title.attr(\"x\", margin.left + (this.twoSided ? translateX - this.activeProfile.titlesSpacing : 0)).style(\"text-anchor\", this.twoSided ? \"end\" : \"\").attr(\"y\", margin.top * 0.7);\n    this.titleRight.attr(\"x\", margin.left + translateX + this.activeProfile.titlesSpacing).attr(\"y\", margin.top * 0.7);\n\n    this.xTitleEl.style(\"font-size\", infoElHeight + \"px\").attr(\"transform\", \"translate(\" + (isRTL ? this.width : margin.left * 0.4) + \",\" + margin.top * 0.4 + \")\");\n    this.xTitleEl.select(\"text\").text(this.model.marker.axis_x.getConceptprops().name);\n\n    if (this.xInfoEl.select(\"svg\").node()) {\n      var titleBBox = this.xTitleEl.node().getBBox();\n      var t = utils.transform(this.xTitleEl.node());\n      var hTranslate = isRTL ? titleBBox.x + t.translateX - infoElHeight * 1.4 : titleBBox.x + t.translateX + titleBBox.width + infoElHeight * 0.4;\n\n      this.xInfoEl.select(\"svg\").attr(\"width\", infoElHeight + \"px\").attr(\"height\", infoElHeight + \"px\");\n      this.xInfoEl.attr(\"transform\", \"translate(\" + hTranslate + \",\" + (t.translateY - infoElHeight * 0.8) + \")\");\n    }\n\n    this.year.attr(\"x\", this.width + margin.left).attr(\"y\", margin.top * 0.4);\n    this.yearLocked.attr(\"x\", this.width + margin.left).attr(\"y\", margin.top);\n  },\n  updateBarsOpacity: function updateBarsOpacity(duration) {\n    var _this = this;\n\n    var OPACITY_HIGHLT = 1.0;\n    var OPACITY_HIGHLT_DIM = this.model.marker.opacityHighlightDim;\n    var OPACITY_SELECT = this.model.marker.opacityRegular;\n    var OPACITY_REGULAR = this.model.marker.opacityRegular;\n    var OPACITY_SELECT_DIM = this.model.marker.opacitySelectDim;\n\n    var nonSelectedOpacityZero = _this.model.marker.opacitySelectDim < 0.01;\n    var nonSelectedOpacityZeroFlag = nonSelectedOpacityZero != this.nonSelectedOpacityZero;\n    var someSelected = this.someSelected;\n    var someHighlighted = this.someHighlighted;\n\n    this.stackBars.each(function (d) {\n      var isSelected = someSelected ? _this.model.marker.isSelected(d) : false;\n      var isHighlighted = someHighlighted ? _this.model.marker.isHighlighted(d) : false;\n      var bar = d3.select(this);\n\n      bar.style(\"opacity\", isHighlighted ? OPACITY_HIGHLT : someSelected ? isSelected ? OPACITY_SELECT : OPACITY_SELECT_DIM : someHighlighted ? OPACITY_HIGHLT_DIM : OPACITY_REGULAR).style(\"stroke\", isSelected ? \"#333\" : null);\n\n      if (nonSelectedOpacityZeroFlag) {\n        bar.style(\"pointer-events\", !someSelected || !nonSelectedOpacityZero || isSelected ? \"visible\" : \"none\");\n      }\n    });\n\n    this.nonSelectedOpacityZero = _this.model.marker.opacitySelectDim < 0.01;\n  }\n});\n\nexports.default = PopByAge;\n\n/***/ }),\n/* 2 */\n/***/ (function(module, exports) {\n\n// removed by extract-text-webpack-plugin\n\n/***/ }),\n/* 3 */\n/***/ (function(module, exports) {\n\nmodule.exports = \"<!-- PopByAge Component -->\\n<svg class=\\\"vzb-popbyage\\\">\\n    <g class=\\\"vzb-bc-header\\\">\\n        <g class=\\\"vzb-bc-axis-x-title\\\"></g>\\n        <g class=\\\"vzb-bc-axis-x-info vzb-noexport\\\"></g>\\n        <text class=\\\"vzb-bc-title\\\"></text>\\n        <text class=\\\"vzb-bc-title vzb-bc-title-right\\\"></text>\\n        <text class=\\\"vzb-bc-year vzb-bc-year-now\\\"></text>\\n        <text class=\\\"vzb-bc-year vzb-bc-year-locked\\\"></text>\\n    </g>\\n    <g class=\\\"vzb-bc-graph\\\">\\n\\n        <g class=\\\"vzb-bc-axis-y-title\\\"></g>\\n\\n        <g class=\\\"vzb-bc-axis-y\\\"></g>\\n\\n        <svg class=\\\"vzb-bc-bars-crop\\\">\\n            <g class=\\\"vzb-bc-bars\\\"></g>\\n        </svg>\\n        \\n        <svg class=\\\"vzb-bc-locked-crop\\\">\\n            <g class=\\\"vzb-bc-paths\\\"></g>\\n        </svg>\\n\\n        <g class=\\\"vzb-bc-axis-x\\\"></g>\\n        <g class=\\\"vzb-bc-axis-x vzb-bc-axis-x-left\\\"></g>\\n\\n        <svg class=\\\"vzb-bc-labels-crop\\\">\\n            <g class=\\\"vzb-bc-labels\\\"></g>\\n        </svg>\\n\\n        <g class=\\\"vzb-bc-axis-labels\\\">\\n            <!-- <text class=\\\"vzb-x_label\\\">Lifespan</text>\\n                  <text class=\\\"vzb-y_label\\\">Lifespan</text> -->\\n        </g>\\n    </g>\\n</svg>\\n\";\n\n/***/ }),\n/* 4 */\n/***/ (function(module, exports, __webpack_require__) {\n\nmodule.exports = __webpack_require__(0);\n\n\n/***/ })\n/******/ ]);\n\n\n// WEBPACK FOOTER //\n// popbyage.js"," \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// identity function for calling harmony imports with the correct context\n \t__webpack_require__.i = function(value) { return value; };\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 4);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap b052a1a26d0b6c78b453","import \"./styles.scss\";\nimport component from \"./component\";\n\nconst VERSION_INFO = { version: __VERSION, build: __BUILD };\n\n//BAR CHART TOOL\nconst PopByAge = Vizabi.Tool.extend(\"PopByAge\", {\n\n  /**\n   * Initializes the tool (Bar Chart Tool).\n   * Executed once before any template is rendered.\n   * @param {Object} placeholder Placeholder element for the tool\n   * @param {Object} external_model Model as given by the external page\n   */\n  init(placeholder, external_model) {\n\n    this.name = \"popbyage\";\n\n    //specifying components\n    this.components = [{\n      component,\n      placeholder: \".vzb-tool-viz\",\n      model: [\"state.time\", \"state.marker\", \"state.marker_allpossible\", \"state.entities\", \"state.entities_side\", \"state.entities_allpossible\", \"state.entities_geodomain\", \"locale\", \"ui\"] //pass models to component\n    }, {\n      component: Vizabi.Component.get(\"timeslider\"),\n      placeholder: \".vzb-tool-timeslider\",\n      model: [\"state.time\", \"state.entities\", \"state.marker\", \"ui\"]\n    }, {\n      component: Vizabi.Component.get(\"dialogs\"),\n      placeholder: \".vzb-tool-dialogs\",\n      model: [\"state\", \"ui\", \"locale\"]\n    }, {\n      component: Vizabi.Component.get(\"buttonlist\"),\n      placeholder: \".vzb-tool-buttonlist\",\n      model: [\"state\", \"ui\", \"locale\"]\n    }, {\n      component: Vizabi.Component.get(\"treemenu\"),\n      placeholder: \".vzb-tool-treemenu\",\n      model: [\"state.marker\", \"state.marker_tags\", \"state.time\", \"locale\"]\n    }, {\n      component: Vizabi.Component.get(\"datanotes\"),\n      placeholder: \".vzb-tool-datanotes\",\n      model: [\"state.marker\", \"locale\"]\n    }, {\n      component: Vizabi.Component.get(\"steppedspeedslider\"),\n      placeholder: \".vzb-tool-stepped-speed-slider\",\n      model: [\"state.time\", \"locale\"]\n    }];\n\n    //constructor is the same as any tool\n    this._super(placeholder, external_model);\n  },\n\n  validate(model) {\n    model = this.model || model;\n\n    this._super(model);\n\n    //validate on first model set only\n    if (!this.model) {\n      const entities = model.state.entities;\n      const dimAllPossible = model.state.entities_allpossible.dim;\n      if (Object.keys(entities.show).length > 0) {\n        const show = {};\n        if (entities.show[entities.dim] && entities.show[entities.dim][\"$in\"]) {\n          show[entities.dim] = {};\n          show[entities.dim][\"$in\"] = entities.show[entities.dim][\"$in\"];\n        }\n        if (entities.dim !== dimAllPossible) {\n          show[\"is--\" + dimAllPossible] = true;\n        }\n        if (!entities.show[entities.dim] || !(Object.keys(entities.show).length == 1)) {\n          entities.show = show;\n        }\n      }\n\n      const entities_geodomain = model.state.entities_geodomain;\n      entities_geodomain.skipFilter = model.state.entities.dim === entities_geodomain.dim ||\n        model.state.entities_side.dim === entities_geodomain.dim;\n    }\n  },\n\n  default_model: {\n    state: {\n      marker_tags: {}\n    },\n    ui: {\n      chart: {\n        stacked: true,\n        inpercent: false,\n        flipSides: true,\n        lockActive: true,\n        lockNonSelected: 0\n      },\n      \"buttons\": [\"colors\", \"inpercent\", \"side\", \"lock\", \"moreoptions\", \"fullscreen\"],\n      \"dialogs\": {\n        \"popup\": [\"timedisplay\", \"colors\", \"side\", \"moreoptions\"],\n        \"sidebar\": [\"timedisplay\", \"colors\", \"show\"],\n        \"moreoptions\": [\"opacity\", \"speed\", \"colors\", \"side\", \"presentation\", \"about\"]\n      },\n      presentation: false\n    },\n    locale: { }\n  },\n\n  versionInfo: VERSION_INFO\n});\n\nexport default PopByAge;\n\n\n\n// WEBPACK FOOTER //\n// ./src/index.js","const {\n  utils,\n  Component,\n  helpers: {\n    \"d3.axisWithLabelPicker\": axisSmart\n  },\n  iconset: {\n    question: iconQuestion\n  },\n} = Vizabi;\n\n// POP BY AGE CHART COMPONENT\nconst PopByAge = Component.extend(\"popbyage\", {\n\n  /**\n   * Initializes the component (Bar Chart).\n   * Executed once before any template is rendered.\n   * @param {Object} config The config passed to the component\n   * @param {Object} context The component's parent\n   */\n  init(config, context) {\n    this.name = \"popbyage\";\n    this.template = require(\"./template.html\");\n\n    //define expected models for this component\n    this.model_expects = [{\n      name: \"time\",\n      type: \"time\"\n    }, {\n      name: \"marker\",\n      type: \"model\"\n    }, {\n      name: \"marker_allpossible\",\n      type: \"model\"\n    }, {\n      name: \"entities\",\n      type: \"entities\"\n    }, {\n      name: \"entities_side\",\n      type: \"entities\"\n    }, {\n      name: \"entities_allpossible\",\n      type: \"entities\"\n    }, {\n      name: \"entities_geodomain\",\n      type: \"entities\"\n    }, {\n      name: \"locale\",\n      type: \"locale\"\n    }, {\n      name: \"ui\",\n      type: \"ui\"\n    }];\n\n    const _this = this;\n    this.model_binds = {\n      \"change:time.value\": function(evt) {\n        if (!_this._readyOnce) return;\n        if (_this.model.time.step != 1 && !_this.snapped && !_this.model.time.playing && !_this.model.time.dragging) {\n          let next = d3.bisectLeft(_this.timeSteps, _this.model.time.value);\n          if (next != 0 && (_this.timeSteps[next] - _this.model.time.value)) {\n            _this.snapped = true;\n            const time = _this.model.time.value;\n            const prev = _this.timeSteps[next - 1];\n            next = _this.timeSteps[next];\n            const snapTime = (time - prev) < (next - time) ? prev : next;\n            _this.model.time.value = new Date(snapTime);\n          }\n        }\n        if (!_this.snapped) {\n          if (_this.timeSteps.filter(t => (t - _this.model.time.value) == 0).length) {\n            _this.model.marker.getFrame(_this.model.time.value, frame => {\n              _this.frame = frame;\n              _this.frameAxisX = frame.axis_x;\n              _this._updateEntities();\n              _this.updateBarsOpacity();\n            });\n          } else {\n            const nextIndex = d3.bisectLeft(_this.timeSteps, _this.model.time.value);\n            const prevFrameTime = _this.timeSteps[nextIndex - 1];\n            const nextFrameTime = _this.timeSteps[nextIndex];\n            const fraction = (_this.model.time.value - prevFrameTime) / (nextFrameTime - prevFrameTime);\n            _this.model.marker.getFrame(nextFrameTime, nValues => {\n              _this.model.marker.getFrame(prevFrameTime, pValues => {\n                _this.frameAxisX = _this.interpolateDiagonal(pValues.axis_x, nValues.axis_x, fraction);\n                _this._updateEntities();\n                _this.updateBarsOpacity();\n              });\n            });\n          }\n        }\n        _this.snapped = false;\n      },\n      \"change:marker.select\": function(evt) {\n        _this.someSelected = (_this.model.marker.select.length > 0);\n        _this.nonSelectedOpacityZero = false;\n        _this.updateBarsOpacity();\n      },\n      \"change:marker.highlight\": function(evt, path) {\n        if (!_this._readyOnce) return;\n        _this._highlightBars();\n      },\n      \"change:marker.opacitySelectDim\": function() {\n        _this.updateBarsOpacity();\n      },\n      \"change:marker.opacityRegular\": function() {\n        _this.updateBarsOpacity();\n      },\n      \"change:marker.color.palette\": function(evt) {\n        if (!_this._readyOnce) return;\n        _this._updateEntities(true);\n      },\n      \"change:marker.color.scaleType\": function(evt) {\n        if (!_this._readyOnce) return;\n        _this._updateEntities();\n      },\n      \"change:marker.color.which\": function(evt) {\n        if (!_this._readyOnce) return;\n        let stackDim;\n        const show = {};\n        const entitiesProps = {}\n        if (_this.model.marker.color.use == \"constant\") {\n          stackDim = null;\n        } else {\n          const colorConcept = _this.model.marker.color.getConceptprops();\n          if (colorConcept.concept_type == \"entity_set\") {\n            stackDim = colorConcept.domain;\n            //show[\"is--\" + _this.model.marker.color.which] = true;\n            const sideConcept = _this.model.marker.side.getConceptprops();\n            if (sideConcept.concept_type == \"entity_set\" && stackDim == sideConcept.domain && _this.model.marker.side.which !== _this.model.marker.color.which) {\n              _this.model.marker.side.setWhich({\"concept\" : _this.model.marker.color.which});\n            }          \n          } else {\n            stackDim = _this.model.marker.color.which;\n          }\n        }\n        if (_this.STACKDIM !== stackDim) { \n          entitiesProps[\"show\"] = show;\n        }\n        entitiesProps[\"dim\"] = stackDim;\n        const skipFilterSide = _this.SIDEDIM !== _this.geoDomainDimension || _this.model.marker.color.which === _this.model.marker.side.which;\n        if (!skipFilterSide) {\n          const sideShow = {};\n          sideShow[\"is--\" + _this.model.marker.side.which] = true;\n          _this.model.entities_side.set(\"show\", sideShow);\n        }\n        _this.model.entities_side.skipFilter = skipFilterSide;\n        _this.model.entities_geodomain.skipFilter = stackDim === _this.geoDomainDimension || _this.SIDEDIM === _this.geoDomainDimension;\n        _this.model.entities.set(entitiesProps);\n        _this.model.entities_allpossible.set(\"dim\", stackDim);\n        _this.model.marker_allpossible.color.set(\"which\", _this.model.marker.color.which);\n      },\n      \"change:marker.side.which\": function(evt) {\n        if (!_this._readyOnce) return;\n        let sideDim;\n        const show = {};\n        const entitiesSideProps = {}\n        if (_this.model.marker.side.use == \"constant\") {\n          sideDim = null;\n        } else {\n          const sideConcept = _this.model.marker.side.getConceptprops();\n          if (sideConcept.concept_type == \"entity_set\") {\n            sideDim = sideConcept.domain;\n            const colorConcept = _this.model.marker.color.getConceptprops();\n            if (colorConcept.concept_type == \"entity_set\" && sideDim == colorConcept.domain && _this.model.marker.color.which !== _this.model.marker.side.which) {\n              _this.model.marker.color.setWhich({\"concept\" : _this.model.marker.side.which});\n            }          \n          } else {\n            sideDim = _this.model.marker.side.which;\n          }\n        } \n//        const sideDim = _this.model.marker.side.use == \"constant\" ? null : _this.model.marker.side.which;\n        _this.model.entities_geodomain.skipFilter = sideDim === _this.geoDomainDimension || _this.STACKDIM === _this.geoDomainDimension;\n        _this.model.marker.side.clearSideState();\n        const skipFilterSide = sideDim !== _this.geoDomainDimension || _this.model.marker.color.which === _this.model.marker.side.which;\n        if (!skipFilterSide) {\n          show[\"is--\" + _this.model.marker.side.which] = true;\n        }\n        _this.model.entities_side.skipFilter = skipFilterSide;\n        entitiesSideProps[\"show\"] = show;\n        entitiesSideProps[\"dim\"] = sideDim;\n//        _this.model.entities_side.clearShow();\n        _this.model.entities_side.set(entitiesSideProps);\n      },\n      \"change:entities.show\": function(evt) {\n        if (!_this._readyOnce) return;\n        if (_this.model.entities.dim === _this.model.entities_side.dim\n          && !utils.isEmpty(_this.model.entities.show)\n          && _this.model.entities.show[_this.model.entities.dim]\n          && !utils.isEmpty(_this.model.entities_side.show)) {\n          utils.forEach(_this.model.entities_side.getFilteredEntities(), s => {\n            if (!_this.model.entities.isShown(s)) {\n              _this.model.marker.side.clearSideState();\n              _this.model.entities_side.showEntity(s);\n            }\n          });\n        }\n      },\n      \"change:entities_side.show\": function(evt) {\n        if (!_this._readyOnce) return;\n\n        let doReturn = false;\n        let _entitiesSameDimWithSide = null;\n        utils.forEach(_this.model.marker.side._space, h => {\n          if (h.dim === _this.model.entities_side.dim && h._name !== _this.model.entities_side._name && h._name !== _this.model.entities_geodomain._name) {\n            _entitiesSameDimWithSide = h;\n          }\n        });\n        if (_entitiesSameDimWithSide && !utils.isEmpty(_entitiesSameDimWithSide.show) && _entitiesSameDimWithSide.show[_entitiesSameDimWithSide.dim]) {\n          utils.forEach(_this.model.entities_side.getFilteredEntities(), s => {\n            if (!_entitiesSameDimWithSide.isShown(s)) {\n              _entitiesSameDimWithSide.showEntity(s);\n              doReturn = true;\n            }\n          });\n        }\n        if (doReturn) return;\n\n        _this._updateIndicators();\n        if (!_this.model._ready || !_this.frame) return;\n        _this._updateLimits();\n        _this.resize();\n        _this._updateEntities(true);\n        _this._redrawLocked();\n      },\n      \"change:ui.chart.inpercent\": function(evt) {\n        if (!_this._readyOnce) return;\n        _this._updateLimits();\n        _this.resize();\n        _this._updateEntities();\n        _this._redrawLocked();\n      },\n      \"change:ui.chart.flipSides\": function(evt) {\n        if (!_this._readyOnce) return;\n        _this.model.marker.side.switchSideState();\n        _this._updateIndicators();\n        _this.resize();\n        _this._updateEntities(true);\n        _this._redrawLocked();\n      },\n      \"change:ui.chart.lockNonSelected\": function(evt) {\n        _this.lock = _this.model.ui.chart.lockNonSelected;\n        if (_this.lock) {\n          if (!(_this.stackKeys.length <= 1 || _this.stackSkip)) {\n            _this.model.ui.chart.lockNonSelected = 0;\n            return;\n          }\n          _this.yearLocked.text(_this.translator(\"popbyage/locked\") + \" \" + _this.lock);\n          _this._makeOutlines(_this.frameAxisX);\n        } else {\n          _this.yearLocked.text(\"\");\n          _this.lockedPaths.html(\"\");\n        }\n      }\n    };\n\n    //contructor is the same as any component\n    this._super(config, context);\n\n    this.xScale = null;\n    this.yScale = null;\n    this.cScale = null;\n\n    this.xAxis = axisSmart(\"bottom\");\n    this.xAxisLeft = axisSmart(\"bottom\");\n    this.yAxis = axisSmart(\"left\");\n    this.xScales = [];\n    this.SHIFTEDAGEDIM = \"s_age\";\n\n  },\n\n  // afterPreload: function() {\n  //   var obj = {};\n  //   obj[\"which\"] = this.model.marker.axis_x.which;\n  //   obj[\"use\"] = this.model.marker.axis_x.use;\n  //   this.model.marker_side.hook_total.set(obj);\n  // },\n\n  checkDimensions() {\n    const stackDim = this.model.entities.dim;\n    const sideDim = this.model.entities_side.dim;\n\n    this.colorUseConstant = this.model.marker.color.use == \"constant\";\n    this.stackSkip = this.colorUseConstant || stackDim == sideDim;\n    this.geoLess = stackDim !== this.geoDomainDimension && sideDim !== this.geoDomainDimension;\n    this.sideSkip = this.model.marker.side.use == \"constant\";\n  },\n\n  /**\n   * DOM is ready\n   */\n  readyOnce() {\n    const _this = this;\n    this.el = (this.el) ? this.el : d3.select(this.element);\n    this.element = this.el;\n\n    this.interaction = this._interaction();\n\n    this.graph = this.element.select(\".vzb-bc-graph\");\n    this.yAxisEl = this.graph.select(\".vzb-bc-axis-y\");\n    this.xAxisEl = this.graph.select(\".vzb-bc-axis-x\");\n    this.xAxisLeftEl = this.graph.select(\".vzb-bc-axis-x-left\");\n    this.xTitleEl = this.element.select(\".vzb-bc-axis-x-title\");\n    this.xInfoEl = this.element.select(\".vzb-bc-axis-x-info\");\n    this.yTitleEl = this.graph.select(\".vzb-bc-axis-y-title\");\n    this.barsCrop = this.graph.select(\".vzb-bc-bars-crop\");\n    this.lockedCrop = this.graph.select(\".vzb-bc-locked-crop\");\n    this.labelsCrop = this.graph.select(\".vzb-bc-labels-crop\");\n    this.bars = this.barsCrop.select(\".vzb-bc-bars\");\n    this.lockedPaths = this.lockedCrop.select(\".vzb-bc-paths\");\n    this.labels = this.labelsCrop.select(\".vzb-bc-labels\");\n\n    this.title = this.element.select(\".vzb-bc-title\");\n    this.titleRight = this.element.select(\".vzb-bc-title-right\");\n    this.year = this.element.select(\".vzb-bc-year-now\");\n    this.yearLocked = this.element.select(\".vzb-bc-year-locked\");\n\n    this.geoDomainDimension = this.model.entities_geodomain.getDimension();\n    this.geoDomainDefaultValue = this.model.entities_geodomain.show[this.geoDomainDimension][\"$in\"][0];\n\n    this.someSelected = (this.model.marker.select.length > 0);\n    this.nonSelectedOpacityZero = false;\n\n    this.on(\"resize\", () => {\n      _this._updateEntities();\n      _this._redrawLocked();\n    });\n\n    this._attributeUpdaters = {\n      _newWidth(d, i) {\n        d[\"x_\"] = 0;\n        let width;\n        if (_this.geoLess && _this.stackSkip && _this.sideSkip) {\n          width = (_this.frameAxisX[d[_this.AGEDIM] + _this.ageShift] || {})[_this.geoDomainDefaultValue];\n        } else if (_this.geoLess && _this.stackSkip) {\n          width = _this.colorUseConstant || d[_this.PREFIXEDSIDEDIM] == d[_this.PREFIXEDSTACKDIM] ? (_this.frameAxisX[d[_this.PREFIXEDSIDEDIM]][d[_this.AGEDIM] + _this.ageShift] || {})[_this.geoDomainDefaultValue] : 0;\n        } else if (_this.geoLess && _this.sideSkip) {\n          width = (_this.frameAxisX[d[_this.PREFIXEDSTACKDIM]][d[_this.AGEDIM] + _this.ageShift] || {})[_this.geoDomainDefaultValue];\n        } else if (_this.stackSkip) {\n          width = _this.colorUseConstant || d[_this.PREFIXEDSIDEDIM] == d[_this.PREFIXEDSTACKDIM] ? _this.frameAxisX[d[_this.PREFIXEDSIDEDIM]][d[_this.AGEDIM] + _this.ageShift] : 0;\n        } else if (_this.sideSkip) {\n          width = _this.frameAxisX[d[_this.PREFIXEDSTACKDIM]][d[_this.AGEDIM] + _this.ageShift];\n        } else {\n          width = _this.frameAxisX[d[_this.PREFIXEDSTACKDIM]][d[_this.PREFIXEDSIDEDIM]][d[_this.AGEDIM] + _this.ageShift];\n        }\n        d[\"width_\"] = width ? _this.xScale(width) : 0;\n        if (_this.ui.chart.inpercent) {\n          d[\"width_\"] /= _this.total[d[_this.PREFIXEDSIDEDIM]];\n        }\n        return d.width_;\n      },\n      _newX(d, i) {\n        const prevSbl = this.previousSibling;\n        if (prevSbl) {\n          const prevSblDatum = d3.select(prevSbl).datum();\n          d[\"x_\"] = prevSblDatum.x_ + prevSblDatum.width_;\n        } else {\n          d[\"x_\"] = 0;\n        }\n        return d.x_;\n      }\n    };\n  },\n\n  /*\n   * Both model and DOM are ready\n   */\n  ready() {\n    //TODO: get component ready if some submodel doesn't ready ??????\n    if (!this.model.marker._ready) return;\n\n    const _this = this;\n\n    this.lock = _this.model.ui.chart.lockNonSelected;\n    this.timeSteps = this.model.time.getAllSteps();\n\n    this.shiftScale = d3.scale.linear()\n      .domain([this.timeSteps[0], this.timeSteps[this.timeSteps.length - 1]])\n      .range([0, this.timeSteps.length - 1]);\n\n    this.side = this.model.marker.label_side.getEntity();\n    this.SIDEDIM = this.side.getDimension();\n    this.PREFIXEDSIDEDIM = \"side_\" + this.SIDEDIM;\n    this.stack = this.model.marker.label_stack.getEntity();\n    this.STACKDIM = this.stack.getDimension();// || this.geoDomainDimension;//this.model.marker.color.which;\n    this.PREFIXEDSTACKDIM = \"stack_\" + this.STACKDIM;\n    this.age = this.model.marker.axis_y.getEntity();\n    this.AGEDIM = this.age.getDimension();\n    this.TIMEDIM = this.model.time.getDimension();\n    this.groupBy = this.age.grouping || 1;\n    this.checkDimensions();\n    this.updateUIStrings();\n    this._updateIndicators();\n\n    if (this.lock && (this.stackKeys.length <= 1 || this.stackSkip)) {\n      this.yearLocked.text(this.translator(\"popbyage/locked\") + \" \" + this.lock);\n    } else {\n      _this.model.ui.chart.lockNonSelected = 0;\n    }\n\n    this.frame = null;\n    this.frameAllColor = {};\n    this.model.marker.getFrame(_this.model.time.value, frame => {\n      _this.frame = frame;\n      _this.frameAxisX = frame.axis_x;\n\n      _this._createLimits();\n      _this._updateLimits();\n\n      _this.resize();\n      this.model.marker_allpossible.getFrame(_this.model.time.value, apFrame => {\n        _this.frameAllColor = apFrame.color || {};\n        _this._updateEntities(true);\n        _this.updateBarsOpacity();\n        _this._redrawLocked();\n      });\n    });\n  },\n\n  _redrawLocked() {\n    const _this = this;   \n    if (!this.lock) return;\n\n    this.model.marker.getFrame(this.model.time.parse(\"\" + this.lock), lockFrame => {\n      if (!lockFrame) return;\n      _this.lockedPaths.html(\"\");\n      _this._makeOutlines(lockFrame.axis_x);  \n    });\n  },\n\n  interpolateDiagonal(pValues, nValues, fraction) {\n    const _this = this;\n    const dataBetweenFrames = {};\n    let data;\n    let val1, val2, shiftedAge;\n    const groupBy = this.groupBy;\n    if (this.geoLess && this.stackSkip && this.sideSkip) {\n      data = dataBetweenFrames;\n      utils.forEach(_this.ageKeys, age => {\n        shiftedAge = +age + groupBy;\n        val1 = pValues[age][_this.geoDomainDefaultValue];\n        val2 = (nValues[shiftedAge] || {})[_this.geoDomainDefaultValue] || 0;\n        data[shiftedAge] = {};\n        data[shiftedAge][_this.geoDomainDefaultValue] = (val1 == null || val2 == null) ? null : val1 + ((val2 - val1) * fraction);\n      });\n      data[0] = {};\n      data[0][_this.geoDomainDefaultValue] = nValues[0][_this.geoDomainDefaultValue] || 0;\n    } else if (this.stackSkip && this.geoLess) {\n      utils.forEach(_this.sideKeys, side => {\n        data = dataBetweenFrames[side] = {};\n        utils.forEach(_this.ageKeys, age => {\n          shiftedAge = +age + groupBy;\n          val1 = pValues[side][age][_this.geoDomainDefaultValue];\n          val2 = (nValues[side][shiftedAge] || {})[_this.geoDomainDefaultValue] || 0;\n          data[shiftedAge] = {};\n          data[shiftedAge][_this.geoDomainDefaultValue] = (val1 == null || val2 == null) ? null : val1 + ((val2 - val1) * fraction);\n        });\n        data[0] = {};\n        data[0][_this.geoDomainDefaultValue] = nValues[side][0][_this.geoDomainDefaultValue] || 0;\n      });\n    } else if (this.stackSkip) {\n      utils.forEach(_this.sideKeys, side => {\n        data = dataBetweenFrames[side] = {};\n        utils.forEach(_this.ageKeys, age => {\n          shiftedAge = +age + groupBy;\n          val1 = pValues[side][age];\n          val2 = nValues[side][shiftedAge] || 0;\n          data[shiftedAge] = (val1 == null || val2 == null) ? null : val1 + ((val2 - val1) * fraction);\n        });\n        data[0] = nValues[side][0] || 0;\n      });\n    } else if (this.sideSkip && this.geoLess) {\n      utils.forEach(_this.stackKeys, stack => {\n        data = dataBetweenFrames[stack] = {};\n        utils.forEach(_this.ageKeys, age => {\n          shiftedAge = +age + groupBy;\n          val1 = pValues[stack][age][_this.geoDomainDefaultValue];\n          val2 = (nValues[stack][shiftedAge] || {})[_this.geoDomainDefaultValue] || 0;\n          data[shiftedAge] = {};\n          data[shiftedAge][_this.geoDomainDefaultValue] = (val1 == null || val2 == null) ? null : val1 + ((val2 - val1) * fraction);\n        });\n        data[0] = {};\n        data[0][_this.geoDomainDefaultValue] = nValues[stack][0][_this.geoDomainDefaultValue] || 0;\n      });\n    } else if (this.sideSkip) {\n      utils.forEach(_this.stackKeys, stack => {\n        data = dataBetweenFrames[stack] = {};\n        utils.forEach(_this.ageKeys, age => {\n          shiftedAge = +age + groupBy;\n          val1 = pValues[stack][age];\n          val2 = nValues[stack][shiftedAge] || 0;\n          data[shiftedAge] = (val1 == null || val2 == null) ? null : val1 + ((val2 - val1) * fraction);\n        });\n        data[0] = nValues[stack][0] || 0;\n      });\n    } else {\n      utils.forEach(_this.stackKeys, stack => {\n        dataBetweenFrames[stack] = {};\n        utils.forEach(_this.sideKeys, side => {\n          data = dataBetweenFrames[stack][side] = {};\n          utils.forEach(_this.ageKeys, age => {\n            shiftedAge = +age + groupBy;\n            val1 = pValues[stack][side][age];\n            val2 = nValues[stack][side][shiftedAge] || 0;\n            data[shiftedAge] = (val1 == null || val2 == null) ? null : val1 + ((val2 - val1) * fraction);\n          });\n          data[0] = nValues[stack][side][0] || 0;\n        });\n      });\n    }\n    return dataBetweenFrames;\n  },\n\n  updateUIStrings() {\n    const _this = this;\n    this.translator = this.model.locale.getTFunction();\n\n    const xTitle = this.xTitleEl.selectAll(\"text\").data([0]);\n    xTitle.enter().append(\"text\");\n    xTitle\n      .on(\"click\", () => {\n        _this.parent\n          .findChildByName(\"gapminder-treemenu\")\n          .markerID(\"axis_x\")\n          .alignX(_this.model.locale.isRTL() ? \"right\" : \"left\")\n          .alignY(\"top\")\n          .updateView()\n          .toggle();\n      });\n\n    utils.setIcon(this.xInfoEl, iconQuestion)\n      .select(\"svg\").attr(\"width\", \"0px\").attr(\"height\", \"0px\");\n\n    this.xInfoEl.on(\"click\", () => {\n      _this.parent.findChildByName(\"gapminder-datanotes\").pin();\n    });\n    this.xInfoEl.on(\"mouseover\", function() {\n      if (_this.model.time.dragging) return;\n      const rect = this.getBBox();\n      const coord = utils.makeAbsoluteContext(this, this.farthestViewportElement)(rect.x - 10, rect.y + rect.height + 10);\n      const toolRect = _this.root.element.getBoundingClientRect();\n      const chartRect = _this.element.node().getBoundingClientRect();\n      _this.parent.findChildByName(\"gapminder-datanotes\").setHook(\"axis_x\").show().setPos(coord.x + chartRect.left - toolRect.left, coord.y);\n    });\n    this.xInfoEl.on(\"mouseout\", () => {\n      if (_this.model.time.dragging) return;\n    _this.parent.findChildByName(\"gapminder-datanotes\").hide();\n  });\n\n    // var titleStringY = this.model.marker.axis_y.getConceptprops().name;\n\n    // var yTitle = this.yTitleEl.selectAll(\"text\").data([0]);\n    // yTitle.enter().append(\"text\");\n    // yTitle\n    //   .attr(\"y\", \"-6px\")\n    //   .attr(\"x\", \"-9px\")\n    //   .attr(\"dx\", \"-0.72em\")\n    //   .text(titleStringY);\n  },\n\n  /**\n   * Changes labels for indicators\n   */\n  _updateIndicators() {\n    const _this = this;\n    this.duration = this.model.time.delayAnimations;\n    this.yScale = this.model.marker.axis_y.getScale();\n    this.xScale = this.model.marker.axis_x.getScale();\n    this.yAxis.tickFormat(_this.model.marker.axis_y.getTickFormatter());\n    this.xAxis.tickFormat(_this.model.marker.axis_x.getTickFormatter());\n    this.xAxisLeft.tickFormat(_this.model.marker.axis_x.getTickFormatter());\n\n    const sideDim = this.SIDEDIM;\n    const stackDim = this.STACKDIM;\n    const ageDim = this.AGEDIM;\n    const groupBy = this.groupBy;\n\n    const ages = this.model.marker.getKeys(ageDim);\n    let ageKeys = [];\n    ageKeys = ages.map(m => m[ageDim]);\n    this.ageKeys = ageKeys;\n\n    this.shiftedAgeKeys = this.timeSteps.map((m, i) => -i * groupBy).slice(1).reverse().concat(ageKeys);\n\n    const sideItems = this.model.marker.label_side.getItems();\n    //var sideKeys = Object.keys(sideItems);\n    let sideKeys = [];\n    if (!utils.isEmpty(sideItems)) {\n      const sideFiltered = !!this.model.marker.side.getEntity().show[sideDim];\n      const sides = this.model.marker.getKeys(sideDim)\n          .filter(f => !sideFiltered || this.model.marker.side.getEntity().isShown(f));\n      sideKeys = sides.map(m => m[sideDim]);\n\n      if (sideKeys.length > 2) sideKeys.length = 2;\n      if (sideKeys.length > 1) {\n        const sortFunc = this.ui.chart.flipSides ? d3.ascending : d3.descending;\n        sideKeys.sort(sortFunc);\n      }\n    }\n    if (!sideKeys.length) sideKeys.push(\"undefined\");\n    this.sideKeys = sideKeys;\n\n    const stacks = this.model.marker.getKeys(stackDim);\n    const stackKeys = stacks.map(m => m[stackDim]);\n\n    let sortedStackKeys = utils.keys(this.model.marker.color.getPalette()).reduce((arr, val) => {\n        if (stackKeys.indexOf(val) != -1) arr.push(val);\n        return arr;\n      }, []);\n\n    if (sortedStackKeys.length != stackKeys.length) {\n      sortedStackKeys = stackKeys.reduce((arr, val) => {\n          if (arr.indexOf(val) == -1) arr.push(val);\n          return arr;\n        }, sortedStackKeys);\n    }\n    this.stackKeys = sortedStackKeys;\n    this.stackItems = this.model.marker.label_stack.getItems();\n\n    this.stacked = this.ui.chart.stacked && this.model.marker.color.use != \"constant\" && this.stack.getDimension();\n\n    this.twoSided = this.sideKeys.length > 1;\n    this.titleRight.classed(\"vzb-hidden\", !this.twoSided);\n    if (this.twoSided) {\n      this.xScaleLeft = this.xScale.copy();\n      this.title.text(sideItems[this.sideKeys[1]]);\n      this.titleRight.text(sideItems[this.sideKeys[0]]);\n    } else {\n      const title = this.sideKeys.length && sideItems[this.sideKeys[0]] ? sideItems[this.sideKeys[0]] : \"\";\n      this.title.text(title);\n    }\n\n    this.cScale = this.model.marker.color.getScale();\n\n    const shiftedAgeDim = this.SHIFTEDAGEDIM;\n    this.markers = this.model.marker.getKeys(ageDim);\n  },\n\n  _createLimits() {\n    const _this = this;\n    const axisX = this.model.marker.axis_x;\n\n    //const sideKeysNF = Object.keys(this.model.marker.side.getItems());\n    const sideKeysNF = Object.keys(this.model.marker.side.getNestedItems([this.SIDEDIM]));\n    if (!sideKeysNF.length) sideKeysNF.push(\"undefined\");\n\n    const keys = this.stackSkip && this.sideSkip ? [] : (this.sideSkip ? [this.STACKDIM] : (this.stackSkip ? [this.SIDEDIM] : [this.STACKDIM, this.SIDEDIM]));\n    const limits = axisX.getLimitsByDimensions(keys.concat([this.AGEDIM, this.TIMEDIM]));\n    const timeKeys = axisX.getUnique();\n    const totals = {};\n    const inpercentMaxLimits = {};\n    const maxLimits = {};\n    sideKeysNF.forEach(s => {\n      maxLimits[s] = [];\n      inpercentMaxLimits[s] = [];\n    });\n\n    if (_this.stackSkip && _this.sideSkip) {\n      utils.forEach(timeKeys, time => {\n        totals[time] = {};\n        let ageSum = 0;\n        const sideMaxLimits = [];\n        utils.forEach(_this.ageKeys, age => {\n          let stackSum = 0;\n          if (limits[age] && limits[age][time]) {\n            stackSum += limits[age][time].max;\n            ageSum += stackSum;\n          }\n          sideMaxLimits.push(stackSum);\n        });\n        totals[time][sideKeysNF[0]] = ageSum;\n        const maxSideLimit = Math.max(...sideMaxLimits);\n        inpercentMaxLimits[sideKeysNF[0]].push(maxSideLimit / ageSum);\n        maxLimits[sideKeysNF[0]].push(maxSideLimit);\n      });\n    } else if (_this.sideSkip) {\n      utils.forEach(timeKeys, time => {\n        totals[time] = {};\n        let ageSum = 0;\n        const sideMaxLimits = [];\n        utils.forEach(_this.ageKeys, age => {\n          let stackSum = 0;\n            utils.forEach(_this.stackKeys, stack => {\n              if (limits[stack] && limits[stack][age] && limits[stack][age][time]) {\n              stackSum += limits[stack][age][time].max;\n              ageSum += stackSum;\n            }\n          });\n          sideMaxLimits.push(stackSum);\n        });\n        totals[time][sideKeysNF[0]] = ageSum;\n        const maxSideLimit = Math.max(...sideMaxLimits);\n        inpercentMaxLimits[sideKeysNF[0]].push(maxSideLimit / ageSum);\n        maxLimits[sideKeysNF[0]].push(maxSideLimit);\n      });\n    } else if (_this.stackSkip) {\n      utils.forEach(timeKeys, time => {\n        totals[time] = {};\n        utils.forEach(sideKeysNF, side => {\n          let ageSum = 0;\n          const sideMaxLimits = [];\n          utils.forEach(_this.ageKeys, age => {\n            let stackSum = 0;\n            if (limits[side] && limits[side][age] && limits[side][age][time]) {\n              stackSum += limits[side][age][time].max;\n              ageSum += stackSum;\n            }\n            sideMaxLimits.push(stackSum);\n          });\n          totals[time][side] = ageSum;\n          const maxSideLimit = Math.max(...sideMaxLimits);\n          inpercentMaxLimits[side].push(maxSideLimit / ageSum);\n          maxLimits[side].push(maxSideLimit);\n        });\n      });\n    } else {\n      utils.forEach(timeKeys, time => {\n        totals[time] = {};\n        utils.forEach(sideKeysNF, side => {\n          let ageSum = 0;\n          const sideMaxLimits = [];\n          utils.forEach(_this.ageKeys, age => {\n            let stackSum = 0;\n            utils.forEach(_this.stackKeys, stack => {\n              if (limits[stack][side] && limits[stack][side][age] && limits[stack][side][age][time]) {\n                stackSum += limits[stack][side][age][time].max;\n                ageSum += stackSum;\n              }\n            });\n            sideMaxLimits.push(stackSum);\n          });\n          totals[time][side] = ageSum;\n          const maxSideLimit = Math.max(...sideMaxLimits);\n          inpercentMaxLimits[side].push(maxSideLimit / ageSum);\n          maxLimits[side].push(maxSideLimit);\n        });\n      });\n    }\n\n    this.maxLimits = {};\n    this.inpercentMaxLimits = {};\n    sideKeysNF.forEach(s => {\n      _this.maxLimits[s] = Math.max(...maxLimits[s]);\n      _this.inpercentMaxLimits[s] = Math.max(...inpercentMaxLimits[s]);\n    });\n    this.totals = totals;\n  },\n\n  _updateLimits() {\n    const _this = this;\n    const axisX = this.model.marker.axis_x;\n    let domain;\n    if (this.ui.chart.inpercent) {\n      domain = [0, Math.max(...this.sideKeys.map(s => _this.inpercentMaxLimits[s]))];\n    } else {\n      domain = (axisX.domainMin != null && axisX.domainMax != null) ? [+axisX.domainMin, +axisX.domainMax] : [0, Math.max(...this.sideKeys.map(s => _this.maxLimits[s]))];\n    }\n    this.xScale.domain(domain);\n    if (this.xScaleLeft) this.xScaleLeft.domain(this.xScale.domain());\n  },\n\n\n  _interpolateBetweenTotals(timeSteps, totals, time) {\n    const nextStep = d3.bisectLeft(timeSteps, time);\n    const fraction = (time - timeSteps[nextStep - 1]) / (timeSteps[nextStep] - timeSteps[nextStep - 1]);\n    const total = {};\n    utils.forEach(this.sideKeys, side => {\n      total[side] = totals[timeSteps[nextStep]][side] * fraction + totals[timeSteps[nextStep - 1]][side] * (1 - fraction);\n  });\n    return total;\n  },\n  \n  /**\n   * Updates entities\n   */\n  _updateEntities(reorder) {\n\n    const _this = this;\n    const time = this.model.time;\n    const sideDim = this.SIDEDIM;\n    const prefixedSideDim = this.PREFIXEDSIDEDIM;\n    const ageDim = this.AGEDIM;\n    const stackDim = this.STACKDIM;\n    const prefixedStackDim = this.PREFIXEDSTACKDIM;\n    const timeDim = this.TIMEDIM;\n    const duration = (time.playing) ? time.delayAnimations : 0;\n    let total;\n\n    const groupBy = this.groupBy;\n    //var group_offset = this.model.marker.group_offset ? Math.abs(this.model.marker.group_offset % groupBy) : 0;\n\n    if (this.ui.chart.inpercent) {\n      this.total = this.totals[time.value] ? this.totals[time.value] : this._interpolateBetweenTotals(this.timeSteps, this.totals, time.value);\n    }\n\n    const domain = this.yScale.domain();\n\n    //this.model.age.setVisible(markers);\n\n    const nextStep = d3.bisectLeft(this.timeSteps, time.value);\n\n    const shiftedAgeDim = this.SHIFTEDAGEDIM;\n\n    const markers = this.markers.map(data => {\n        const o = {};\n    o[ageDim] = o[shiftedAgeDim] = +data[ageDim];\n    o[ageDim] -= nextStep * groupBy;\n    return o;\n  });\n\n    const ageData = markers.slice(0);\n\n    const outAge = {};\n    outAge[shiftedAgeDim] = markers.length * groupBy;\n    outAge[ageDim] = outAge[shiftedAgeDim] - nextStep * groupBy;\n\n    this.ageShift = nextStep * groupBy;\n\n    if (nextStep) ageData.push(outAge);\n\n    const stacks = _this.stacked ? _this.stackKeys : [_this.geoDomainDefaultValue];\n    const geoDomainDefaultValue = this.geoDomainDefaultValue;\n    const geoDomainDimension = this.geoDomainDimension;\n\n    for(let i = 0, j = ageData.length; i < j; i++) {\n      const d = ageData[i];\n      d[\"side\"] = _this.sideKeys.map(m => {\n        const r = {};\n        r[ageDim] = d[ageDim];\n        r[shiftedAgeDim] = d[shiftedAgeDim];\n        r[prefixedSideDim] = m;\n        r[sideDim] = m;\n        r[\"stack\"] = stacks.map(m => {\n          const s = {};\n          s[geoDomainDimension] = geoDomainDefaultValue;\n          s[ageDim] = r[ageDim];\n          s[shiftedAgeDim] = r[shiftedAgeDim];\n          s[sideDim] = r[sideDim];\n          s[stackDim] = m;\n          s[prefixedSideDim] = r[prefixedSideDim];\n          s[prefixedStackDim] = m;\n          return s;\n        });\n        return r;\n      });\n    }\n\n    this.barsData = ageData;\n\n    let ageBars = this.bars.selectAll(\".vzb-bc-bar\")\n      .data(ageData, d => d[ageDim]);\n    //exit selection\n    ageBars.exit().remove();\n\n    const oneBarHeight = this.oneBarHeight;\n    const barHeight = this.barHeight;\n    const firstBarOffsetY = this.firstBarOffsetY;\n\n    //enter selection -- init bars\n    ageBars = ageBars.enter().append(\"g\")\n      .attr(\"class\", d => \"vzb-bc-bar \" + \"vzb-bc-bar-\" + d[ageDim])\n      .attr(\"transform\", (d, i) => \"translate(0,\" + (firstBarOffsetY - (d[shiftedAgeDim] - domain[0] - groupBy) * oneBarHeight) + \")\")\n      .merge(ageBars);\n\n    // this.ageBars.attr(\"class\", function(d) {\n    //     return \"vzb-bc-bar \" + \"vzb-bc-bar-\" + d[ageDim];\n    //   })\n\n\n    let sideBars = ageBars.selectAll(\".vzb-bc-side\").data(d => d.side, d => d[prefixedSideDim]);\n\n    sideBars.exit().remove();\n    sideBars = sideBars.enter().append(\"g\")\n      .attr(\"class\", (d, i) => \"vzb-bc-side \" + \"vzb-bc-side-\" + (!i != !_this.twoSided ? \"right\" : \"left\"))\n      .attr(\"transform\", (d, i) => i ? (\"scale(-1,1) translate(\" + _this.activeProfile.centerWidth + \",0)\") : \"\")\n      .merge(sideBars);\n\n    if (reorder) {\n      sideBars\n        .attr(\"class\", (d, i) => \"vzb-bc-side \" + \"vzb-bc-side-\" + (!i != !_this.twoSided ? \"right\" : \"left\"))\n        .attr(\"transform\", (d, i) => i ? (\"scale(-1,1) translate(\" + _this.activeProfile.centerWidth + \",0)\") : \"\");\n    }\n\n    const _attributeUpdaters = this._attributeUpdaters;\n\n    let stackBars = sideBars.selectAll(\".vzb-bc-stack\").data(d => d.stack, d => d[prefixedStackDim]);\n\n    stackBars.exit().remove();\n    stackBars = stackBars.enter().append(\"rect\")\n      .attr(\"class\", (d, i) => \"vzb-bc-stack \" + \"vzb-bc-stack-\" + i + (_this.highlighted ? \" vzb-dimmed\" : \"\"))\n      .attr(\"y\", 0)\n      .attr(\"height\", barHeight)\n      .attr(\"fill\", d => _this.cScale(_this.frameAllColor[d[prefixedStackDim]] || d[prefixedStackDim]))\n      .attr(\"width\", _attributeUpdaters._newWidth)\n      .attr(\"x\", _attributeUpdaters._newX)\n      .on(\"mouseover\", _this.interaction.mouseover)\n      .on(\"mouseout\", _this.interaction.mouseout)\n      .on(\"click\", _this.interaction.click)\n      .onTap(_this.interaction.tap)\n      .merge(stackBars);\n\n\n    if (reorder) stackBars\n      .attr(\"class\", (d, i) => \"vzb-bc-stack \" + \"vzb-bc-stack-\" + i + (_this.highlighted ? \" vzb-dimmed\" : \"\"))\n      .attr(\"fill\", d => _this.cScale(_this.frameAllColor[d[prefixedStackDim]] || d[prefixedStackDim]))\n      .order();\n\n    const stepShift = (ageData[0][shiftedAgeDim] - ageData[0][ageDim]) - this.shiftScale(time.value) * groupBy;\n\n    if (duration) {\n      const transition = d3.transition()\n        .duration(duration)\n        .ease(d3.easeLinear);\n\n      ageBars\n        .transition(transition)\n        .attr(\"transform\", (d, i) => \"translate(0,\" + (firstBarOffsetY - (d[shiftedAgeDim] - domain[0] - stepShift) * oneBarHeight) + \")\");\n      stackBars\n        .transition(transition)\n        .attr(\"width\", _attributeUpdaters._newWidth)\n        .attr(\"x\", _attributeUpdaters._newX);\n    } else {\n      ageBars.interrupt()\n        .attr(\"transform\", (d, i) => \"translate(0,\" + (firstBarOffsetY - (d[shiftedAgeDim] - domain[0] - stepShift) * oneBarHeight) + \")\");\n      stackBars.interrupt()\n        .attr(\"width\", _attributeUpdaters._newWidth)\n        .attr(\"x\", _attributeUpdaters._newX);\n    }\n\n    this.ageBars = ageBars;\n    this.sideBars = sideBars;\n    this.stackBars = stackBars;\n\n    this.entityLabels = this.labels.selectAll(\".vzb-bc-label text\")\n      .data(markers);\n    //exit selection\n    this.entityLabels.exit().remove();\n\n    this.entityLabels = this.entityLabels.enter().append(\"g\")\n      .attr(\"class\", \"vzb-bc-label\")\n      .attr(\"id\", d => \"vzb-bc-label-\" + d[shiftedAgeDim] + \"-\" + _this._id)\n      .append(\"text\")\n      .attr(\"class\", \"vzb-bc-age\")\n      .merge(this.entityLabels)\n      .each((d, i) => {\n        const yearOlds = _this.translator(\"popbyage/yearOlds\");\n\n        let age = parseInt(d[shiftedAgeDim], 10);\n\n        if (groupBy > 1) {\n          age = age + \"-to-\" + (age + groupBy - 1);\n        }\n\n        d[\"text\"] = age + yearOlds;\n      })\n      .attr(\"y\", (d, i) => firstBarOffsetY - (d[shiftedAgeDim] - domain[0]) * oneBarHeight - 10);\n    // .style(\"fill\", function(d) {\n    //   var color = _this.cScale(values.color[d[ageDim]]);\n    //   return d3.rgb(color).darker(2);\n    // });\n\n    if (duration) {\n      this.year.transition().duration(duration).ease(d3.easeLinear)\n        .on(\"end\", this._setYear(time.value));\n    } else {\n      this.year.interrupt().text(time.formatDate(time.value)).transition();\n    }\n  },\n\n  _makeOutlines(frame) {\n    const _this = this;\n\n    const KEYS = utils.unique(this.model.marker._getAllDimensions({ exceptType: \"time\" }))\n    KEYS.forEach((key, i) => {\n        if (key === _this.AGEDIM) KEYS[i] = _this.SHIFTEDAGEDIM;\n        //if (_this.geoLess)\n      });\n \n    const barHeight = this.barHeight;\n    const firstBarOffsetY = this.firstBarOffsetY + barHeight;\n\n    const line = d3.line().curve(d3.curveStepBefore)\n      .x(d => d.x)//_ + d.width_)\n      .y((d, i) => firstBarOffsetY - barHeight * i)\n\n    const stackIndex = [0, 0];\n\n    const pathsData = this.sideKeys.map((s, i) => {\n      if (_this.stackSkip) {\n        _this.barsData[0].side[i].stack.forEach((d, j) => {\n          if (d[_this.PREFIXEDSIDEDIM] === d[_this.PREFIXEDSTACKDIM]) {\n            stackIndex[i] = j;\n          }\n        });\n      }\n      const data = {};\n      data.d = _this.barsData.map(age => {\n        const r = {};\n        const x = utils.getValueMD(age.side[i].stack[stackIndex[i]], frame, KEYS);\n        r.x = x ? _this.xScale(x) : 0;\n          if (_this.ui.chart.inpercent) {\n            r.x /= _this.total[age.side[i].stack[stackIndex[i]][_this.PREFIXEDSIDEDIM]];\n          }\n        return r;\n      });\n      return data;\n    });\n\n    const data = this.bars.selectAll(\".vzb-bc-side-left\").selectAll(\".vzb-bc-stack-0\").data();\n    const color = _this.cScale(data[0][this.PREFIXEDSTACKDIM])\n    const colorShade = this.model.marker.color.getColorShade({\n      colorID: _this.frameAllColor[data[0][this.PREFIXEDSTACKDIM]] || data[0][this.PREFIXEDSTACKDIM],\n      shadeID: \"shade\"\n    }) || \"#000\";//d3.hsl(color).darker(2);\n\n    const paths = this.lockedPaths.selectAll(\"path\").data(pathsData);\n    paths.exit().remove();\n    paths.enter()\n      .append(\"path\")\n      .merge(paths)\n      .attr(\"d\", d => line(d.d))\n      .attr(\"stroke\", \"#000\")//colorShade)\n      .attr(\"transform\", (d, i) => i ? (\"scale(-1,1) translate(\" + _this.activeProfile.centerWidth + \",0)\") : \"\");\n  },\n\n  _setYear(timeValue) {\n    const formattedTime = this.model.time.formatDate(timeValue);\n    return function() { d3.select(this).text(formattedTime); };\n  },\n\n  _interaction() {\n    const _this = this;\n    return {\n      mouseover(d, i) {\n        if (utils.isTouchDevice()) return;\n        _this.model.marker.highlightMarker(d);\n        _this._showLabel(d);\n      },\n      mouseout(d, i) {\n        if (utils.isTouchDevice()) return;\n        _this.model.marker.clearHighlighted();\n      },\n      click(d, i) {\n        if (utils.isTouchDevice()) return;\n        _this.model.marker.selectMarker(d);\n      },\n      tap(d) {\n        d3.event.stopPropagation();\n        _this.model.marker.selectMarker(d);\n      }\n    };\n  },\n\n  _highlightBars(d) {\n    const _this = this;\n\n    _this.someHighlighted = (_this.model.marker.highlight.length > 0);\n\n    _this.updateBarsOpacity();\n\n    if (!_this.someHighlighted) {\n      //hide labels\n      _this.labels.selectAll(\".vzb-hovered\").classed(\"vzb-hovered\", false);\n    }\n  },\n\n  _showLabel(d) {\n    const _this = this;\n    const formatter = _this.ui.chart.inpercent ? d3.format(\".1%\") : _this.model.marker.axis_x.getTickFormatter();\n    const sideDim = _this.SIDEDIM;\n    const ageDim = _this.AGEDIM;\n    const stackDim = _this.STACKDIM;\n    const shiftedAgeDim = \"s_age\";\n\n    const left = _this.sideKeys.indexOf(d[sideDim]) > 0;\n    const label = _this.labels.select(\"#vzb-bc-label-\" + d[shiftedAgeDim] + \"-\" + _this._id);\n    label.selectAll(\".vzb-bc-age\")\n      .text(textData => {\n      //var total = _this.ui.chart.inpercent ? _this.totalValues[d[sideDim]] : 1;\n      let text = _this.stackKeys.length > 1 ? _this.stackItems[d[stackDim]] : textData.text;\n    text = _this.twoSided ? text : textData.text + \" \" + _this.stackItems[d[stackDim]];\n    const value = _this.xScale.invert(d[\"width_\"]);\n    return text + \": \" + formatter(value);\n  })\n  .attr(\"x\", (left ? -1 : 1) * (_this.activeProfile.centerWidth * 0.5 + 7))\n      .classed(\"vzb-text-left\", left);\n\n    label.classed(\"vzb-hovered\", true);\n  },\n\n  /**\n   * Executes everytime the container or vizabi is resized\n   * Ideally,it contains only operations related to size\n   */\n\n\n  presentationProfileChanges: {\n    medium: {\n      margin: { right: 80, bottom: 80 },\n      infoElHeight: 32\n    },\n    large: {\n      margin: { top: 100, right: 100, left: 100, bottom: 80 },\n      infoElHeight: 32\n    }\n  },\n\n  profiles: {\n    \"small\": {\n      margin: {\n        top: 70,\n        right: 20,\n        left: 40,\n        bottom: 40\n      },\n      infoElHeight: 16,\n      centerWidth: 2,\n      titlesSpacing: 5\n    },\n    \"medium\": {\n      margin: {\n        top: 80,\n        right: 60,\n        left: 60,\n        bottom: 40\n      },\n      infoElHeight: 20,\n      centerWidth: 2,\n      titlesSpacing: 10\n    },\n    \"large\": {\n      margin: {\n        top: 100,\n        right: 60,\n        left: 60,\n        bottom: 40\n      },\n      infoElHeight: 22,\n      centerWidth: 2,\n      titlesSpacing: 20\n    }\n  },\n\n  resize() {\n\n    const _this = this;\n\n    this.activeProfile = this.getActiveProfile(this.profiles, this.presentationProfileChanges);\n\n    //this.activeProfile = this.profiles[this.getLayoutProfile()];\n    const margin = this.activeProfile.margin;\n    const infoElHeight = this.activeProfile.infoElHeight;\n\n    //stage\n    this.height = (parseInt(this.element.style(\"height\"), 10) - margin.top - margin.bottom) || 0;\n    this.width = (parseInt(this.element.style(\"width\"), 10) - margin.left - margin.right) || 0;\n\n    if (this.height <= 0 || this.width <= 0) return utils.warn(\"Pop by age resize() abort: vizabi container is too little or has display:none\");\n\n    this.graph\n      .attr(\"transform\", \"translate(\" + margin.left + \",\" + margin.top + \")\");\n\n    this.barsCrop\n      .attr(\"width\", this.width)\n      .attr(\"height\", Math.max(0, this.height));\n\n    this.lockedCrop\n      .attr(\"width\", this.width)\n      .attr(\"height\", Math.max(0, this.height));\n\n    this.labelsCrop\n      .attr(\"width\", this.width)\n      .attr(\"height\", Math.max(0, this.height));\n\n    const groupBy = this.groupBy;\n\n    const domain = this.yScale.domain();\n    this.oneBarHeight = this.height / (domain[1] - domain[0]);\n    const barHeight = this.barHeight = this.oneBarHeight * groupBy; // height per bar is total domain height divided by the number of possible markers in the domain\n    this.firstBarOffsetY = this.height - this.barHeight;\n\n    if (this.stackBars) this.stackBars.attr(\"height\", barHeight);\n\n    if (this.sideBars) this.sideBars\n      .attr(\"transform\", (d, i) => i ? (\"scale(-1,1) translate(\" + _this.activeProfile.centerWidth + \",0)\") : \"\");\n\n\n    //update scales to the new range\n    this.yScale.range([this.height, 0]);\n\n    const maxRange = this.twoSided ? ((this.width - this.activeProfile.centerWidth) * 0.5) : this.width;\n\n    this.xScale.range([0, maxRange]);\n\n    //apply scales to axes and redraw\n    this.yAxis.scale(this.yScale)\n      .tickSizeInner(-this.width)\n      .tickSizeOuter(0)\n      .tickPadding(6)\n      .tickSizeMinor(-this.width, 0)\n      .labelerOptions({\n        scaleType: this.model.marker.axis_y.scaleType,\n        toolMargin: margin,\n        limitMaxTickNumber: 19\n      });\n\n    const format = this.ui.chart.inpercent ? d3.format((groupBy > 3 ? \"\" : \".1\") + \"%\") : this.model.marker.axis_x.getTickFormatter();\n\n    this.xAxis.scale(this.xScale)\n      .tickFormat(format)\n      .tickSizeInner(-this.height)\n      .tickSizeOuter(0)\n      .tickPadding(6)\n      .tickSizeMinor(-this.height, 0)\n      .labelerOptions({\n        scaleType: this.model.marker.axis_x.scaleType,\n        toolMargin: margin,\n        limitMaxTickNumber: 6\n      });\n\n    const translateX = this.twoSided ? ((this.width + _this.activeProfile.centerWidth) * 0.5) : 0;\n\n    this.xAxisEl.attr(\"transform\", \"translate(\" + translateX + \",\" + this.height + \")\")\n      .call(this.xAxis);\n\n    this.yAxisEl.attr(\"transform\", \"translate(\" + 0 + \",0)\")\n      .call(this.yAxis);\n    //this.xAxisEl.call(this.xAxis);\n    this.xAxisLeftEl.classed(\"vzb-hidden\", !this.twoSided);\n    if (this.twoSided) {\n      if (this.model.marker.axis_x.scaleType !== \"ordinal\") {\n        this.xScaleLeft.range([(this.width - this.activeProfile.centerWidth) * 0.5, 0]);\n      } else {\n        this.xScaleLeft.rangePoints([(this.width - this.activeProfile.centerWidth) * 0.5, 0]).range();\n      }\n\n      this.xAxisLeft.scale(this.xScaleLeft)\n        .tickFormat(format)\n        .tickSizeInner(-this.height)\n        .tickSizeOuter(0)\n        .tickPadding(6)\n        .tickSizeMinor(-this.height, 0)\n        .labelerOptions({\n          scaleType: this.model.marker.axis_x.scaleType,\n          toolMargin: margin,\n          limitMaxTickNumber: 6\n        });\n\n      this.xAxisLeftEl.attr(\"transform\", \"translate(0,\" + this.height + \")\")\n        .call(this.xAxisLeft);\n      const zeroTickEl = this.xAxisEl.select(\".tick text\");\n      if (!zeroTickEl.empty()) {\n        const zeroTickWidth = zeroTickEl.node().getBBox().width;\n        zeroTickEl.attr(\"dx\", -(this.activeProfile.centerWidth + zeroTickWidth) * 0.5);\n      }\n      this.xAxisEl.select(\".tick line\").classed(\"vzb-hidden\", true);\n   \n      //hide left axis zero tick\n      const tickNodes = this.xAxisLeftEl.selectAll(\".tick\").nodes();\n      d3.select(tickNodes[tickNodes.length - 1]).classed(\"vzb-hidden\", true);\n    }\n\n    const isRTL = this.model.locale.isRTL();\n\n    this.bars.attr(\"transform\", \"translate(\" + translateX + \",0)\");\n    this.lockedPaths.attr(\"transform\", \"translate(\" + translateX + \",0)\");\n    this.labels.attr(\"transform\", \"translate(\" + translateX + \",0)\");\n\n    this.title\n      .attr(\"x\", margin.left + (this.twoSided ? translateX - this.activeProfile.titlesSpacing : 0))\n      .style(\"text-anchor\", this.twoSided ? \"end\" : \"\")\n      .attr(\"y\", margin.top * 0.7);\n    this.titleRight\n      .attr(\"x\", margin.left + translateX + this.activeProfile.titlesSpacing)\n      .attr(\"y\", margin.top * 0.7);\n\n    this.xTitleEl\n      .style(\"font-size\", infoElHeight + \"px\")\n      .attr(\"transform\", \"translate(\" + (isRTL ? this.width : margin.left * 0.4) + \",\" + (margin.top * 0.4) + \")\");\n    this.xTitleEl.select(\"text\").text(this.model.marker.axis_x.getConceptprops().name);\n\n    if (this.xInfoEl.select(\"svg\").node()) {\n      const titleBBox = this.xTitleEl.node().getBBox();\n      const t = utils.transform(this.xTitleEl.node());\n      const hTranslate = isRTL ? (titleBBox.x + t.translateX - infoElHeight * 1.4) : (titleBBox.x + t.translateX + titleBBox.width + infoElHeight * 0.4);\n\n      this.xInfoEl.select(\"svg\")\n        .attr(\"width\", infoElHeight + \"px\")\n        .attr(\"height\", infoElHeight + \"px\");\n      this.xInfoEl.attr(\"transform\", \"translate(\"\n        + hTranslate + \",\"\n        + (t.translateY - infoElHeight * 0.8) + \")\");\n    }\n\n\n    this.year.attr(\"x\", this.width + margin.left).attr(\"y\", margin.top * 0.4);\n    this.yearLocked.attr(\"x\", this.width + margin.left).attr(\"y\", margin.top);\n\n  },\n\n  updateBarsOpacity(duration) {\n    const _this = this;\n\n    const OPACITY_HIGHLT = 1.0;\n    const OPACITY_HIGHLT_DIM = this.model.marker.opacityHighlightDim;\n    const OPACITY_SELECT = this.model.marker.opacityRegular;\n    const OPACITY_REGULAR = this.model.marker.opacityRegular;\n    const OPACITY_SELECT_DIM = this.model.marker.opacitySelectDim;\n\n    const nonSelectedOpacityZero = _this.model.marker.opacitySelectDim < 0.01;\n    const nonSelectedOpacityZeroFlag = nonSelectedOpacityZero != this.nonSelectedOpacityZero;\n    const someSelected = this.someSelected;\n    const someHighlighted = this.someHighlighted;\n\n    this.stackBars.each(function(d) {\n      const isSelected =  someSelected ? _this.model.marker.isSelected(d) : false;\n      const isHighlighted = someHighlighted ? _this.model.marker.isHighlighted(d): false;\n      const bar = d3.select(this);\n\n      bar.style(\"opacity\", isHighlighted ? OPACITY_HIGHLT \n        : \n        someSelected ? (isSelected ? OPACITY_SELECT : OPACITY_SELECT_DIM)\n          : \n          someHighlighted ? OPACITY_HIGHLT_DIM : OPACITY_REGULAR)\n        .style(\"stroke\", isSelected ? \"#333\" : null);\n      \n      if(nonSelectedOpacityZeroFlag) {\n        bar.style(\"pointer-events\", !someSelected || !nonSelectedOpacityZero || isSelected ? \"visible\" : \"none\");\n      }\n    });\n\n    this.nonSelectedOpacityZero = _this.model.marker.opacitySelectDim < 0.01;\n  }\n\n});\n\nexport default PopByAge;\n\n\n\n// WEBPACK FOOTER //\n// ./src/component.js","module.exports = \"<!-- PopByAge Component -->\\n<svg class=\\\"vzb-popbyage\\\">\\n    <g class=\\\"vzb-bc-header\\\">\\n        <g class=\\\"vzb-bc-axis-x-title\\\"></g>\\n        <g class=\\\"vzb-bc-axis-x-info vzb-noexport\\\"></g>\\n        <text class=\\\"vzb-bc-title\\\"></text>\\n        <text class=\\\"vzb-bc-title vzb-bc-title-right\\\"></text>\\n        <text class=\\\"vzb-bc-year vzb-bc-year-now\\\"></text>\\n        <text class=\\\"vzb-bc-year vzb-bc-year-locked\\\"></text>\\n    </g>\\n    <g class=\\\"vzb-bc-graph\\\">\\n\\n        <g class=\\\"vzb-bc-axis-y-title\\\"></g>\\n\\n        <g class=\\\"vzb-bc-axis-y\\\"></g>\\n\\n        <svg class=\\\"vzb-bc-bars-crop\\\">\\n            <g class=\\\"vzb-bc-bars\\\"></g>\\n        </svg>\\n        \\n        <svg class=\\\"vzb-bc-locked-crop\\\">\\n            <g class=\\\"vzb-bc-paths\\\"></g>\\n        </svg>\\n\\n        <g class=\\\"vzb-bc-axis-x\\\"></g>\\n        <g class=\\\"vzb-bc-axis-x vzb-bc-axis-x-left\\\"></g>\\n\\n        <svg class=\\\"vzb-bc-labels-crop\\\">\\n            <g class=\\\"vzb-bc-labels\\\"></g>\\n        </svg>\\n\\n        <g class=\\\"vzb-bc-axis-labels\\\">\\n            <!-- <text class=\\\"vzb-x_label\\\">Lifespan</text>\\n                  <text class=\\\"vzb-y_label\\\">Lifespan</text> -->\\n        </g>\\n    </g>\\n</svg>\\n\";\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./src/template.html\n// module id = 3\n// module chunks = 0"],"sourceRoot":""}