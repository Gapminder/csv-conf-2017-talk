!function(e){function t(s){if(i[s])return i[s].exports;var a=i[s]={i:s,l:!1,exports:{}};return e[s].call(a.exports,a,a.exports,t),a.l=!0,a.exports}var i={};t.m=e,t.c=i,t.i=function(e){return e},t.d=function(e,i,s){t.o(e,i)||Object.defineProperty(e,i,{configurable:!1,enumerable:!0,get:s})},t.n=function(e){var i=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(i,"a",i),i},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=4)}([function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),i(2);var s=i(1),a=function(e){return e&&e.__esModule?e:{default:e}}(s),n={version:"1.1.5",build:1493429522620},r=Vizabi.Tool.extend("PopByAge",{init:function(e,t){this.name="popbyage",this.components=[{component:a.default,placeholder:".vzb-tool-viz",model:["state.time","state.marker","state.marker_allpossible","state.entities","state.entities_side","state.entities_allpossible","state.entities_geodomain","locale","ui"]},{component:Vizabi.Component.get("timeslider"),placeholder:".vzb-tool-timeslider",model:["state.time","state.entities","state.marker","ui"]},{component:Vizabi.Component.get("dialogs"),placeholder:".vzb-tool-dialogs",model:["state","ui","locale"]},{component:Vizabi.Component.get("buttonlist"),placeholder:".vzb-tool-buttonlist",model:["state","ui","locale"]},{component:Vizabi.Component.get("treemenu"),placeholder:".vzb-tool-treemenu",model:["state.marker","state.marker_tags","state.time","locale"]},{component:Vizabi.Component.get("datanotes"),placeholder:".vzb-tool-datanotes",model:["state.marker","locale"]},{component:Vizabi.Component.get("steppedspeedslider"),placeholder:".vzb-tool-stepped-speed-slider",model:["state.time","locale"]}],this._super(e,t)},validate:function(e){if(e=this.model||e,this._super(e),!this.model){var t=e.state.entities,i=e.state.entities_allpossible.dim;if(Object.keys(t.show).length>0){var s={};t.show[t.dim]&&t.show[t.dim].$in&&(s[t.dim]={},s[t.dim].$in=t.show[t.dim].$in),t.dim!==i&&(s["is--"+i]=!0),t.show[t.dim]&&1==Object.keys(t.show).length||(t.show=s)}var a=e.state.entities_geodomain;a.skipFilter=e.state.entities.dim===a.dim||e.state.entities_side.dim===a.dim}},default_model:{state:{marker_tags:{}},ui:{chart:{stacked:!0,inpercent:!1,flipSides:!0,lockActive:!0,lockNonSelected:0},buttons:["colors","inpercent","side","lock","moreoptions","fullscreen"],dialogs:{popup:["timedisplay","colors","side","moreoptions"],sidebar:["timedisplay","colors","show"],moreoptions:["opacity","speed","colors","side","presentation","about"]},presentation:!1},locale:{}},versionInfo:n});t.default=r},function(e,t,i){"use strict";function s(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}Object.defineProperty(t,"__esModule",{value:!0});var a=Vizabi,n=a.utils,r=a.Component,o=a.helpers["d3.axisWithLabelPicker"],l=a.iconset.question,h=r.extend("popbyage",{init:function(e,t){this.name="popbyage",this.template=i(3),this.model_expects=[{name:"time",type:"time"},{name:"marker",type:"model"},{name:"marker_allpossible",type:"model"},{name:"entities",type:"entities"},{name:"entities_side",type:"entities"},{name:"entities_allpossible",type:"entities"},{name:"entities_geodomain",type:"entities"},{name:"locale",type:"locale"},{name:"ui",type:"ui"}];var s=this;this.model_binds={"change:time.value":function(e){if(s._readyOnce){if(1!=s.model.time.step&&!s.snapped&&!s.model.time.playing&&!s.model.time.dragging){var t=d3.bisectLeft(s.timeSteps,s.model.time.value);if(0!=t&&s.timeSteps[t]-s.model.time.value){s.snapped=!0;var i=s.model.time.value,a=s.timeSteps[t-1];t=s.timeSteps[t];var n=i-a<t-i?a:t;s.model.time.value=new Date(n)}}if(!s.snapped)if(s.timeSteps.filter(function(e){return e-s.model.time.value==0}).length)s.model.marker.getFrame(s.model.time.value,function(e){s.frame=e,s.frameAxisX=e.axis_x,s._updateEntities(),s.updateBarsOpacity()});else{var r=d3.bisectLeft(s.timeSteps,s.model.time.value),o=s.timeSteps[r-1],l=s.timeSteps[r],h=(s.model.time.value-o)/(l-o);s.model.marker.getFrame(l,function(e){s.model.marker.getFrame(o,function(t){s.frameAxisX=s.interpolateDiagonal(t.axis_x,e.axis_x,h),s._updateEntities(),s.updateBarsOpacity()})})}s.snapped=!1}},"change:marker.select":function(e){s.someSelected=s.model.marker.select.length>0,s.nonSelectedOpacityZero=!1,s.updateBarsOpacity()},"change:marker.highlight":function(e,t){s._readyOnce&&s._highlightBars()},"change:marker.opacitySelectDim":function(){s.updateBarsOpacity()},"change:marker.opacityRegular":function(){s.updateBarsOpacity()},"change:marker.color.palette":function(e){s._readyOnce&&s._updateEntities(!0)},"change:marker.color.scaleType":function(e){s._readyOnce&&s._updateEntities()},"change:marker.color.which":function(e){if(s._readyOnce){var t=void 0,i={},a={};if("constant"==s.model.marker.color.use)t=null;else{var n=s.model.marker.color.getConceptprops();if("entity_set"==n.concept_type){t=n.domain;var r=s.model.marker.side.getConceptprops();"entity_set"==r.concept_type&&t==r.domain&&s.model.marker.side.which!==s.model.marker.color.which&&s.model.marker.side.setWhich({concept:s.model.marker.color.which})}else t=s.model.marker.color.which}s.STACKDIM!==t&&(a.show=i),a.dim=t;var o=s.SIDEDIM!==s.geoDomainDimension||s.model.marker.color.which===s.model.marker.side.which;if(!o){var l={};l["is--"+s.model.marker.side.which]=!0,s.model.entities_side.set("show",l)}s.model.entities_side.skipFilter=o,s.model.entities_geodomain.skipFilter=t===s.geoDomainDimension||s.SIDEDIM===s.geoDomainDimension,s.model.entities.set(a),s.model.entities_allpossible.set("dim",t),s.model.marker_allpossible.color.set("which",s.model.marker.color.which)}},"change:marker.side.which":function(e){if(s._readyOnce){var t=void 0,i={},a={};if("constant"==s.model.marker.side.use)t=null;else{var n=s.model.marker.side.getConceptprops();if("entity_set"==n.concept_type){t=n.domain;var r=s.model.marker.color.getConceptprops();"entity_set"==r.concept_type&&t==r.domain&&s.model.marker.color.which!==s.model.marker.side.which&&s.model.marker.color.setWhich({concept:s.model.marker.side.which})}else t=s.model.marker.side.which}s.model.entities_geodomain.skipFilter=t===s.geoDomainDimension||s.STACKDIM===s.geoDomainDimension,s.model.marker.side.clearSideState();var o=t!==s.geoDomainDimension||s.model.marker.color.which===s.model.marker.side.which;o||(i["is--"+s.model.marker.side.which]=!0),s.model.entities_side.skipFilter=o,a.show=i,a.dim=t,s.model.entities_side.set(a)}},"change:entities.show":function(e){s._readyOnce&&(s.model.entities.dim!==s.model.entities_side.dim||n.isEmpty(s.model.entities.show)||!s.model.entities.show[s.model.entities.dim]||n.isEmpty(s.model.entities_side.show)||n.forEach(s.model.entities_side.getFilteredEntities(),function(e){s.model.entities.isShown(e)||(s.model.marker.side.clearSideState(),s.model.entities_side.showEntity(e))}))},"change:entities_side.show":function(e){if(s._readyOnce){var t=!1,i=null;n.forEach(s.model.marker.side._space,function(e){e.dim===s.model.entities_side.dim&&e._name!==s.model.entities_side._name&&e._name!==s.model.entities_geodomain._name&&(i=e)}),i&&!n.isEmpty(i.show)&&i.show[i.dim]&&n.forEach(s.model.entities_side.getFilteredEntities(),function(e){i.isShown(e)||(i.showEntity(e),t=!0)}),t||(s._updateIndicators(),s.model._ready&&s.frame&&(s._updateLimits(),s.resize(),s._updateEntities(!0),s._redrawLocked()))}},"change:ui.chart.inpercent":function(e){s._readyOnce&&(s._updateLimits(),s.resize(),s._updateEntities(),s._redrawLocked())},"change:ui.chart.flipSides":function(e){s._readyOnce&&(s.model.marker.side.switchSideState(),s._updateIndicators(),s.resize(),s._updateEntities(!0),s._redrawLocked())},"change:ui.chart.lockNonSelected":function(e){if(s.lock=s.model.ui.chart.lockNonSelected,s.lock){if(!(s.stackKeys.length<=1||s.stackSkip))return void(s.model.ui.chart.lockNonSelected=0);s.yearLocked.text(s.translator("popbyage/locked")+" "+s.lock),s._makeOutlines(s.frameAxisX)}else s.yearLocked.text(""),s.lockedPaths.html("")}},this._super(e,t),this.xScale=null,this.yScale=null,this.cScale=null,this.xAxis=o("bottom"),this.xAxisLeft=o("bottom"),this.yAxis=o("left"),this.xScales=[],this.SHIFTEDAGEDIM="s_age"},checkDimensions:function(){var e=this.model.entities.dim,t=this.model.entities_side.dim;this.colorUseConstant="constant"==this.model.marker.color.use,this.stackSkip=this.colorUseConstant||e==t,this.geoLess=e!==this.geoDomainDimension&&t!==this.geoDomainDimension,this.sideSkip="constant"==this.model.marker.side.use},readyOnce:function(){var e=this;this.el=this.el?this.el:d3.select(this.element),this.element=this.el,this.interaction=this._interaction(),this.graph=this.element.select(".vzb-bc-graph"),this.yAxisEl=this.graph.select(".vzb-bc-axis-y"),this.xAxisEl=this.graph.select(".vzb-bc-axis-x"),this.xAxisLeftEl=this.graph.select(".vzb-bc-axis-x-left"),this.xTitleEl=this.element.select(".vzb-bc-axis-x-title"),this.xInfoEl=this.element.select(".vzb-bc-axis-x-info"),this.yTitleEl=this.graph.select(".vzb-bc-axis-y-title"),this.barsCrop=this.graph.select(".vzb-bc-bars-crop"),this.lockedCrop=this.graph.select(".vzb-bc-locked-crop"),this.labelsCrop=this.graph.select(".vzb-bc-labels-crop"),this.bars=this.barsCrop.select(".vzb-bc-bars"),this.lockedPaths=this.lockedCrop.select(".vzb-bc-paths"),this.labels=this.labelsCrop.select(".vzb-bc-labels"),this.title=this.element.select(".vzb-bc-title"),this.titleRight=this.element.select(".vzb-bc-title-right"),this.year=this.element.select(".vzb-bc-year-now"),this.yearLocked=this.element.select(".vzb-bc-year-locked"),this.geoDomainDimension=this.model.entities_geodomain.getDimension(),this.geoDomainDefaultValue=this.model.entities_geodomain.show[this.geoDomainDimension].$in[0],this.someSelected=this.model.marker.select.length>0,this.nonSelectedOpacityZero=!1,this.on("resize",function(){e._updateEntities(),e._redrawLocked()}),this._attributeUpdaters={_newWidth:function(t,i){t.x_=0;var s=void 0;return s=e.geoLess&&e.stackSkip&&e.sideSkip?(e.frameAxisX[t[e.AGEDIM]+e.ageShift]||{})[e.geoDomainDefaultValue]:e.geoLess&&e.stackSkip?e.colorUseConstant||t[e.PREFIXEDSIDEDIM]==t[e.PREFIXEDSTACKDIM]?(e.frameAxisX[t[e.PREFIXEDSIDEDIM]][t[e.AGEDIM]+e.ageShift]||{})[e.geoDomainDefaultValue]:0:e.geoLess&&e.sideSkip?(e.frameAxisX[t[e.PREFIXEDSTACKDIM]][t[e.AGEDIM]+e.ageShift]||{})[e.geoDomainDefaultValue]:e.stackSkip?e.colorUseConstant||t[e.PREFIXEDSIDEDIM]==t[e.PREFIXEDSTACKDIM]?e.frameAxisX[t[e.PREFIXEDSIDEDIM]][t[e.AGEDIM]+e.ageShift]:0:e.sideSkip?e.frameAxisX[t[e.PREFIXEDSTACKDIM]][t[e.AGEDIM]+e.ageShift]:e.frameAxisX[t[e.PREFIXEDSTACKDIM]][t[e.PREFIXEDSIDEDIM]][t[e.AGEDIM]+e.ageShift],t.width_=s?e.xScale(s):0,e.ui.chart.inpercent&&(t.width_/=e.total[t[e.PREFIXEDSIDEDIM]]),t.width_},_newX:function(e,t){var i=this.previousSibling;if(i){var s=d3.select(i).datum();e.x_=s.x_+s.width_}else e.x_=0;return e.x_}}},ready:function(){var e=this;if(this.model.marker._ready){var t=this;this.lock=t.model.ui.chart.lockNonSelected,this.timeSteps=this.model.time.getAllSteps(),this.shiftScale=d3.scale.linear().domain([this.timeSteps[0],this.timeSteps[this.timeSteps.length-1]]).range([0,this.timeSteps.length-1]),this.side=this.model.marker.label_side.getEntity(),this.SIDEDIM=this.side.getDimension(),this.PREFIXEDSIDEDIM="side_"+this.SIDEDIM,this.stack=this.model.marker.label_stack.getEntity(),this.STACKDIM=this.stack.getDimension(),this.PREFIXEDSTACKDIM="stack_"+this.STACKDIM,this.age=this.model.marker.axis_y.getEntity(),this.AGEDIM=this.age.getDimension(),this.TIMEDIM=this.model.time.getDimension(),this.groupBy=this.age.grouping||1,this.checkDimensions(),this.updateUIStrings(),this._updateIndicators(),this.lock&&(this.stackKeys.length<=1||this.stackSkip)?this.yearLocked.text(this.translator("popbyage/locked")+" "+this.lock):t.model.ui.chart.lockNonSelected=0,this.frame=null,this.frameAllColor={},this.model.marker.getFrame(t.model.time.value,function(i){t.frame=i,t.frameAxisX=i.axis_x,t._createLimits(),t._updateLimits(),t.resize(),e.model.marker_allpossible.getFrame(t.model.time.value,function(e){t.frameAllColor=e.color||{},t._updateEntities(!0),t.updateBarsOpacity(),t._redrawLocked()})})}},_redrawLocked:function(){var e=this;this.lock&&this.model.marker.getFrame(this.model.time.parse(""+this.lock),function(t){t&&(e.lockedPaths.html(""),e._makeOutlines(t.axis_x))})},interpolateDiagonal:function(e,t,i){var s=this,a={},r=void 0,o=void 0,l=void 0,h=void 0,c=this.groupBy;return this.geoLess&&this.stackSkip&&this.sideSkip?(r=a,n.forEach(s.ageKeys,function(a){h=+a+c,o=e[a][s.geoDomainDefaultValue],l=(t[h]||{})[s.geoDomainDefaultValue]||0,r[h]={},r[h][s.geoDomainDefaultValue]=null==o||null==l?null:o+(l-o)*i}),r[0]={},r[0][s.geoDomainDefaultValue]=t[0][s.geoDomainDefaultValue]||0):this.stackSkip&&this.geoLess?n.forEach(s.sideKeys,function(d){r=a[d]={},n.forEach(s.ageKeys,function(a){h=+a+c,o=e[d][a][s.geoDomainDefaultValue],l=(t[d][h]||{})[s.geoDomainDefaultValue]||0,r[h]={},r[h][s.geoDomainDefaultValue]=null==o||null==l?null:o+(l-o)*i}),r[0]={},r[0][s.geoDomainDefaultValue]=t[d][0][s.geoDomainDefaultValue]||0}):this.stackSkip?n.forEach(s.sideKeys,function(d){r=a[d]={},n.forEach(s.ageKeys,function(s){h=+s+c,o=e[d][s],l=t[d][h]||0,r[h]=null==o||null==l?null:o+(l-o)*i}),r[0]=t[d][0]||0}):this.sideSkip&&this.geoLess?n.forEach(s.stackKeys,function(d){r=a[d]={},n.forEach(s.ageKeys,function(a){h=+a+c,o=e[d][a][s.geoDomainDefaultValue],l=(t[d][h]||{})[s.geoDomainDefaultValue]||0,r[h]={},r[h][s.geoDomainDefaultValue]=null==o||null==l?null:o+(l-o)*i}),r[0]={},r[0][s.geoDomainDefaultValue]=t[d][0][s.geoDomainDefaultValue]||0}):this.sideSkip?n.forEach(s.stackKeys,function(d){r=a[d]={},n.forEach(s.ageKeys,function(s){h=+s+c,o=e[d][s],l=t[d][h]||0,r[h]=null==o||null==l?null:o+(l-o)*i}),r[0]=t[d][0]||0}):n.forEach(s.stackKeys,function(d){a[d]={},n.forEach(s.sideKeys,function(m){r=a[d][m]={},n.forEach(s.ageKeys,function(s){h=+s+c,o=e[d][m][s],l=t[d][m][h]||0,r[h]=null==o||null==l?null:o+(l-o)*i}),r[0]=t[d][m][0]||0})}),a},updateUIStrings:function(){var e=this;this.translator=this.model.locale.getTFunction();var t=this.xTitleEl.selectAll("text").data([0]);t.enter().append("text"),t.on("click",function(){e.parent.findChildByName("gapminder-treemenu").markerID("axis_x").alignX(e.model.locale.isRTL()?"right":"left").alignY("top").updateView().toggle()}),n.setIcon(this.xInfoEl,l).select("svg").attr("width","0px").attr("height","0px"),this.xInfoEl.on("click",function(){e.parent.findChildByName("gapminder-datanotes").pin()}),this.xInfoEl.on("mouseover",function(){if(!e.model.time.dragging){var t=this.getBBox(),i=n.makeAbsoluteContext(this,this.farthestViewportElement)(t.x-10,t.y+t.height+10),s=e.root.element.getBoundingClientRect(),a=e.element.node().getBoundingClientRect();e.parent.findChildByName("gapminder-datanotes").setHook("axis_x").show().setPos(i.x+a.left-s.left,i.y)}}),this.xInfoEl.on("mouseout",function(){e.model.time.dragging||e.parent.findChildByName("gapminder-datanotes").hide()})},_updateIndicators:function(){var e=this,t=this;this.duration=this.model.time.delayAnimations,this.yScale=this.model.marker.axis_y.getScale(),this.xScale=this.model.marker.axis_x.getScale(),this.yAxis.tickFormat(t.model.marker.axis_y.getTickFormatter()),this.xAxis.tickFormat(t.model.marker.axis_x.getTickFormatter()),this.xAxisLeft.tickFormat(t.model.marker.axis_x.getTickFormatter());var i=this.SIDEDIM,s=this.STACKDIM,a=this.AGEDIM,r=this.groupBy,o=this.model.marker.getKeys(a),l=[];l=o.map(function(e){return e[a]}),this.ageKeys=l,this.shiftedAgeKeys=this.timeSteps.map(function(e,t){return-t*r}).slice(1).reverse().concat(l);var h=this.model.marker.label_side.getItems(),c=[];if(!n.isEmpty(h)){var d=!!this.model.marker.side.getEntity().show[i];if(c=this.model.marker.getKeys(i).filter(function(t){return!d||e.model.marker.side.getEntity().isShown(t)}).map(function(e){return e[i]}),c.length>2&&(c.length=2),c.length>1){var m=this.ui.chart.flipSides?d3.ascending:d3.descending;c.sort(m)}}c.length||c.push("undefined"),this.sideKeys=c;var u=this.model.marker.getKeys(s),p=u.map(function(e){return e[s]}),f=n.keys(this.model.marker.color.getPalette()).reduce(function(e,t){return-1!=p.indexOf(t)&&e.push(t),e},[]);if(f.length!=p.length&&(f=p.reduce(function(e,t){return-1==e.indexOf(t)&&e.push(t),e},f)),this.stackKeys=f,this.stackItems=this.model.marker.label_stack.getItems(),this.stacked=this.ui.chart.stacked&&"constant"!=this.model.marker.color.use&&this.stack.getDimension(),this.twoSided=this.sideKeys.length>1,this.titleRight.classed("vzb-hidden",!this.twoSided),this.twoSided)this.xScaleLeft=this.xScale.copy(),this.title.text(h[this.sideKeys[1]]),this.titleRight.text(h[this.sideKeys[0]]);else{var g=this.sideKeys.length&&h[this.sideKeys[0]]?h[this.sideKeys[0]]:"";this.title.text(g)}this.cScale=this.model.marker.color.getScale();this.SHIFTEDAGEDIM;this.markers=this.model.marker.getKeys(a)},_createLimits:function(){var e=this,t=this.model.marker.axis_x,i=Object.keys(this.model.marker.side.getNestedItems([this.SIDEDIM]));i.length||i.push("undefined");var a=this.stackSkip&&this.sideSkip?[]:this.sideSkip?[this.STACKDIM]:this.stackSkip?[this.SIDEDIM]:[this.STACKDIM,this.SIDEDIM],r=t.getLimitsByDimensions(a.concat([this.AGEDIM,this.TIMEDIM])),o=t.getUnique(),l={},h={},c={};i.forEach(function(e){c[e]=[],h[e]=[]}),e.stackSkip&&e.sideSkip?n.forEach(o,function(t){l[t]={};var s=0,a=[];n.forEach(e.ageKeys,function(e){var i=0;r[e]&&r[e][t]&&(i+=r[e][t].max,s+=i),a.push(i)}),l[t][i[0]]=s;var o=Math.max.apply(Math,a);h[i[0]].push(o/s),c[i[0]].push(o)}):e.sideSkip?n.forEach(o,function(t){l[t]={};var s=0,a=[];n.forEach(e.ageKeys,function(i){var o=0;n.forEach(e.stackKeys,function(e){r[e]&&r[e][i]&&r[e][i][t]&&(o+=r[e][i][t].max,s+=o)}),a.push(o)}),l[t][i[0]]=s;var o=Math.max.apply(Math,a);h[i[0]].push(o/s),c[i[0]].push(o)}):e.stackSkip?n.forEach(o,function(t){l[t]={},n.forEach(i,function(i){var s=0,a=[];n.forEach(e.ageKeys,function(e){var n=0;r[i]&&r[i][e]&&r[i][e][t]&&(n+=r[i][e][t].max,s+=n),a.push(n)}),l[t][i]=s;var o=Math.max.apply(Math,a);h[i].push(o/s),c[i].push(o)})}):n.forEach(o,function(t){l[t]={},n.forEach(i,function(i){var s=0,a=[];n.forEach(e.ageKeys,function(o){var l=0;n.forEach(e.stackKeys,function(e){r[e][i]&&r[e][i][o]&&r[e][i][o][t]&&(l+=r[e][i][o][t].max,s+=l)}),a.push(l)}),l[t][i]=s;var o=Math.max.apply(Math,a);h[i].push(o/s),c[i].push(o)})}),this.maxLimits={},this.inpercentMaxLimits={},i.forEach(function(t){e.maxLimits[t]=Math.max.apply(Math,s(c[t])),e.inpercentMaxLimits[t]=Math.max.apply(Math,s(h[t]))}),this.totals=l},_updateLimits:function(){var e=this,t=this.model.marker.axis_x,i=void 0;i=this.ui.chart.inpercent?[0,Math.max.apply(Math,s(this.sideKeys.map(function(t){return e.inpercentMaxLimits[t]})))]:null!=t.domainMin&&null!=t.domainMax?[+t.domainMin,+t.domainMax]:[0,Math.max.apply(Math,s(this.sideKeys.map(function(t){return e.maxLimits[t]})))],this.xScale.domain(i),this.xScaleLeft&&this.xScaleLeft.domain(this.xScale.domain())},_interpolateBetweenTotals:function(e,t,i){var s=d3.bisectLeft(e,i),a=(i-e[s-1])/(e[s]-e[s-1]),r={};return n.forEach(this.sideKeys,function(i){r[i]=t[e[s]][i]*a+t[e[s-1]][i]*(1-a)}),r},_updateEntities:function(e){var t=this,i=this.model.time,s=this.SIDEDIM,a=this.PREFIXEDSIDEDIM,n=this.AGEDIM,r=this.STACKDIM,o=this.PREFIXEDSTACKDIM,l=(this.TIMEDIM,i.playing?i.delayAnimations:0),h=this.groupBy;this.ui.chart.inpercent&&(this.total=this.totals[i.value]?this.totals[i.value]:this._interpolateBetweenTotals(this.timeSteps,this.totals,i.value));var c=this.yScale.domain(),d=d3.bisectLeft(this.timeSteps,i.value),m=this.SHIFTEDAGEDIM,u=this.markers.map(function(e){var t={};return t[n]=t[m]=+e[n],t[n]-=d*h,t}),p=u.slice(0),f={};f[m]=u.length*h,f[n]=f[m]-d*h,this.ageShift=d*h,d&&p.push(f);for(var g=t.stacked?t.stackKeys:[t.geoDomainDefaultValue],k=this.geoDomainDefaultValue,v=this.geoDomainDimension,b=0,x=p.length;b<x;b++)!function(e,i){var l=p[e];l.side=t.sideKeys.map(function(e){var t={};return t[n]=l[n],t[m]=l[m],t[a]=e,t[s]=e,t.stack=g.map(function(e){var i={};return i[v]=k,i[n]=t[n],i[m]=t[m],i[s]=t[s],i[r]=e,i[a]=t[a],i[o]=e,i}),t})}(b);this.barsData=p;var y=this.bars.selectAll(".vzb-bc-bar").data(p,function(e){return e[n]});y.exit().remove();var D=this.oneBarHeight,S=this.barHeight,E=this.firstBarOffsetY;y=y.enter().append("g").attr("class",function(e){return"vzb-bc-bar vzb-bc-bar-"+e[n]}).attr("transform",function(e,t){return"translate(0,"+(E-(e[m]-c[0]-h)*D)+")"}).merge(y);var _=y.selectAll(".vzb-bc-side").data(function(e){return e.side},function(e){return e[a]});_.exit().remove(),_=_.enter().append("g").attr("class",function(e,i){return"vzb-bc-side vzb-bc-side-"+(!i!=!t.twoSided?"right":"left")}).attr("transform",function(e,i){return i?"scale(-1,1) translate("+t.activeProfile.centerWidth+",0)":""}).merge(_),e&&_.attr("class",function(e,i){return"vzb-bc-side vzb-bc-side-"+(!i!=!t.twoSided?"right":"left")}).attr("transform",function(e,i){return i?"scale(-1,1) translate("+t.activeProfile.centerWidth+",0)":""});var I=this._attributeUpdaters,w=_.selectAll(".vzb-bc-stack").data(function(e){return e.stack},function(e){return e[o]});w.exit().remove(),w=w.enter().append("rect").attr("class",function(e,i){return"vzb-bc-stack vzb-bc-stack-"+i+(t.highlighted?" vzb-dimmed":"")}).attr("y",0).attr("height",S).attr("fill",function(e){return t.cScale(t.frameAllColor[e[o]]||e[o])}).attr("width",I._newWidth).attr("x",I._newX).on("mouseover",t.interaction.mouseover).on("mouseout",t.interaction.mouseout).on("click",t.interaction.click).onTap(t.interaction.tap).merge(w),e&&w.attr("class",function(e,i){return"vzb-bc-stack vzb-bc-stack-"+i+(t.highlighted?" vzb-dimmed":"")}).attr("fill",function(e){return t.cScale(t.frameAllColor[e[o]]||e[o])}).order();var z=p[0][m]-p[0][n]-this.shiftScale(i.value)*h;if(l){var M=d3.transition().duration(l).ease(d3.easeLinear);y.transition(M).attr("transform",function(e,t){return"translate(0,"+(E-(e[m]-c[0]-z)*D)+")"}),w.transition(M).attr("width",I._newWidth).attr("x",I._newX)}else y.interrupt().attr("transform",function(e,t){return"translate(0,"+(E-(e[m]-c[0]-z)*D)+")"}),w.interrupt().attr("width",I._newWidth).attr("x",I._newX);this.ageBars=y,this.sideBars=_,this.stackBars=w,this.entityLabels=this.labels.selectAll(".vzb-bc-label text").data(u),this.entityLabels.exit().remove(),this.entityLabels=this.entityLabels.enter().append("g").attr("class","vzb-bc-label").attr("id",function(e){return"vzb-bc-label-"+e[m]+"-"+t._id}).append("text").attr("class","vzb-bc-age").merge(this.entityLabels).each(function(e,i){var s=t.translator("popbyage/yearOlds"),a=parseInt(e[m],10);h>1&&(a=a+"-to-"+(a+h-1)),e.text=a+s}).attr("y",function(e,t){return E-(e[m]-c[0])*D-10}),l?this.year.transition().duration(l).ease(d3.easeLinear).on("end",this._setYear(i.value)):this.year.interrupt().text(i.formatDate(i.value)).transition()},_makeOutlines:function(e){var t=this,i=n.unique(this.model.marker._getAllDimensions({exceptType:"time"}));i.forEach(function(e,s){e===t.AGEDIM&&(i[s]=t.SHIFTEDAGEDIM)});var s=this.barHeight,a=this.firstBarOffsetY+s,r=d3.line().curve(d3.curveStepBefore).x(function(e){return e.x}).y(function(e,t){return a-s*t}),o=[0,0],l=this.sideKeys.map(function(s,a){t.stackSkip&&t.barsData[0].side[a].stack.forEach(function(e,i){e[t.PREFIXEDSIDEDIM]===e[t.PREFIXEDSTACKDIM]&&(o[a]=i)});var r={};return r.d=t.barsData.map(function(s){var r={},l=n.getValueMD(s.side[a].stack[o[a]],e,i);return r.x=l?t.xScale(l):0,t.ui.chart.inpercent&&(r.x/=t.total[s.side[a].stack[o[a]][t.PREFIXEDSIDEDIM]]),r}),r}),h=this.bars.selectAll(".vzb-bc-side-left").selectAll(".vzb-bc-stack-0").data(),c=(t.cScale(h[0][this.PREFIXEDSTACKDIM]),this.model.marker.color.getColorShade({colorID:t.frameAllColor[h[0][this.PREFIXEDSTACKDIM]]||h[0][this.PREFIXEDSTACKDIM],shadeID:"shade"}),this.lockedPaths.selectAll("path").data(l));c.exit().remove(),c.enter().append("path").merge(c).attr("d",function(e){return r(e.d)}).attr("stroke","#000").attr("transform",function(e,i){return i?"scale(-1,1) translate("+t.activeProfile.centerWidth+",0)":""})},_setYear:function(e){var t=this.model.time.formatDate(e);return function(){d3.select(this).text(t)}},_interaction:function(){var e=this;return{mouseover:function(t,i){n.isTouchDevice()||(e.model.marker.highlightMarker(t),e._showLabel(t))},mouseout:function(t,i){n.isTouchDevice()||e.model.marker.clearHighlighted()},click:function(t,i){n.isTouchDevice()||e.model.marker.selectMarker(t)},tap:function(t){d3.event.stopPropagation(),e.model.marker.selectMarker(t)}}},_highlightBars:function(e){var t=this;t.someHighlighted=t.model.marker.highlight.length>0,t.updateBarsOpacity(),t.someHighlighted||t.labels.selectAll(".vzb-hovered").classed("vzb-hovered",!1)},_showLabel:function(e){var t=this,i=t.ui.chart.inpercent?d3.format(".1%"):t.model.marker.axis_x.getTickFormatter(),s=t.SIDEDIM,a=(t.AGEDIM,t.STACKDIM),n=t.sideKeys.indexOf(e[s])>0,r=t.labels.select("#vzb-bc-label-"+e.s_age+"-"+t._id);r.selectAll(".vzb-bc-age").text(function(s){var n=t.stackKeys.length>1?t.stackItems[e[a]]:s.text;n=t.twoSided?n:s.text+" "+t.stackItems[e[a]];var r=t.xScale.invert(e.width_);return n+": "+i(r)}).attr("x",(n?-1:1)*(.5*t.activeProfile.centerWidth+7)).classed("vzb-text-left",n),r.classed("vzb-hovered",!0)},presentationProfileChanges:{medium:{margin:{right:80,bottom:80},infoElHeight:32},large:{margin:{top:100,right:100,left:100,bottom:80},infoElHeight:32}},profiles:{small:{margin:{top:70,right:20,left:40,bottom:40},infoElHeight:16,centerWidth:2,titlesSpacing:5},medium:{margin:{top:80,right:60,left:60,bottom:40},infoElHeight:20,centerWidth:2,titlesSpacing:10},large:{margin:{top:100,right:60,left:60,bottom:40},infoElHeight:22,centerWidth:2,titlesSpacing:20}},resize:function(){var e=this;this.activeProfile=this.getActiveProfile(this.profiles,this.presentationProfileChanges);var t=this.activeProfile.margin,i=this.activeProfile.infoElHeight;if(this.height=parseInt(this.element.style("height"),10)-t.top-t.bottom||0,this.width=parseInt(this.element.style("width"),10)-t.left-t.right||0,this.height<=0||this.width<=0)return n.warn("Pop by age resize() abort: vizabi container is too little or has display:none");this.graph.attr("transform","translate("+t.left+","+t.top+")"),this.barsCrop.attr("width",this.width).attr("height",Math.max(0,this.height)),this.lockedCrop.attr("width",this.width).attr("height",Math.max(0,this.height)),this.labelsCrop.attr("width",this.width).attr("height",Math.max(0,this.height));var s=this.groupBy,a=this.yScale.domain();this.oneBarHeight=this.height/(a[1]-a[0]);var r=this.barHeight=this.oneBarHeight*s;this.firstBarOffsetY=this.height-this.barHeight,this.stackBars&&this.stackBars.attr("height",r),this.sideBars&&this.sideBars.attr("transform",function(t,i){return i?"scale(-1,1) translate("+e.activeProfile.centerWidth+",0)":""}),this.yScale.range([this.height,0]);var o=this.twoSided?.5*(this.width-this.activeProfile.centerWidth):this.width;this.xScale.range([0,o]),this.yAxis.scale(this.yScale).tickSizeInner(-this.width).tickSizeOuter(0).tickPadding(6).tickSizeMinor(-this.width,0).labelerOptions({scaleType:this.model.marker.axis_y.scaleType,toolMargin:t,limitMaxTickNumber:19});var l=this.ui.chart.inpercent?d3.format((s>3?"":".1")+"%"):this.model.marker.axis_x.getTickFormatter();this.xAxis.scale(this.xScale).tickFormat(l).tickSizeInner(-this.height).tickSizeOuter(0).tickPadding(6).tickSizeMinor(-this.height,0).labelerOptions({scaleType:this.model.marker.axis_x.scaleType,toolMargin:t,limitMaxTickNumber:6});var h=this.twoSided?.5*(this.width+e.activeProfile.centerWidth):0;if(this.xAxisEl.attr("transform","translate("+h+","+this.height+")").call(this.xAxis),this.yAxisEl.attr("transform","translate(0,0)").call(this.yAxis),this.xAxisLeftEl.classed("vzb-hidden",!this.twoSided),this.twoSided){"ordinal"!==this.model.marker.axis_x.scaleType?this.xScaleLeft.range([.5*(this.width-this.activeProfile.centerWidth),0]):this.xScaleLeft.rangePoints([.5*(this.width-this.activeProfile.centerWidth),0]).range(),this.xAxisLeft.scale(this.xScaleLeft).tickFormat(l).tickSizeInner(-this.height).tickSizeOuter(0).tickPadding(6).tickSizeMinor(-this.height,0).labelerOptions({scaleType:this.model.marker.axis_x.scaleType,toolMargin:t,limitMaxTickNumber:6}),this.xAxisLeftEl.attr("transform","translate(0,"+this.height+")").call(this.xAxisLeft);var c=this.xAxisEl.select(".tick text");if(!c.empty()){var d=c.node().getBBox().width;c.attr("dx",.5*-(this.activeProfile.centerWidth+d))}this.xAxisEl.select(".tick line").classed("vzb-hidden",!0);var m=this.xAxisLeftEl.selectAll(".tick").nodes();d3.select(m[m.length-1]).classed("vzb-hidden",!0)}var u=this.model.locale.isRTL();if(this.bars.attr("transform","translate("+h+",0)"),this.lockedPaths.attr("transform","translate("+h+",0)"),this.labels.attr("transform","translate("+h+",0)"),this.title.attr("x",t.left+(this.twoSided?h-this.activeProfile.titlesSpacing:0)).style("text-anchor",this.twoSided?"end":"").attr("y",.7*t.top),this.titleRight.attr("x",t.left+h+this.activeProfile.titlesSpacing).attr("y",.7*t.top),this.xTitleEl.style("font-size",i+"px").attr("transform","translate("+(u?this.width:.4*t.left)+","+.4*t.top+")"),this.xTitleEl.select("text").text(this.model.marker.axis_x.getConceptprops().name),this.xInfoEl.select("svg").node()){var p=this.xTitleEl.node().getBBox(),f=n.transform(this.xTitleEl.node()),g=u?p.x+f.translateX-1.4*i:p.x+f.translateX+p.width+.4*i;this.xInfoEl.select("svg").attr("width",i+"px").attr("height",i+"px"),this.xInfoEl.attr("transform","translate("+g+","+(f.translateY-.8*i)+")")}this.year.attr("x",this.width+t.left).attr("y",.4*t.top),this.yearLocked.attr("x",this.width+t.left).attr("y",t.top)},updateBarsOpacity:function(e){var t=this,i=this.model.marker.opacityHighlightDim,s=this.model.marker.opacityRegular,a=this.model.marker.opacityRegular,n=this.model.marker.opacitySelectDim,r=t.model.marker.opacitySelectDim<.01,o=r!=this.nonSelectedOpacityZero,l=this.someSelected,h=this.someHighlighted;this.stackBars.each(function(e){var c=!!l&&t.model.marker.isSelected(e),d=!!h&&t.model.marker.isHighlighted(e),m=d3.select(this);m.style("opacity",d?1:l?c?s:n:h?i:a).style("stroke",c?"#333":null),o&&m.style("pointer-events",l&&r&&!c?"none":"visible")}),this.nonSelectedOpacityZero=t.model.marker.opacitySelectDim<.01}});t.default=h},function(e,t){},function(e,t){e.exports='\x3c!-- PopByAge Component --\x3e\n<svg class="vzb-popbyage">\n    <g class="vzb-bc-header">\n        <g class="vzb-bc-axis-x-title"></g>\n        <g class="vzb-bc-axis-x-info vzb-noexport"></g>\n        <text class="vzb-bc-title"></text>\n        <text class="vzb-bc-title vzb-bc-title-right"></text>\n        <text class="vzb-bc-year vzb-bc-year-now"></text>\n        <text class="vzb-bc-year vzb-bc-year-locked"></text>\n    </g>\n    <g class="vzb-bc-graph">\n\n        <g class="vzb-bc-axis-y-title"></g>\n\n        <g class="vzb-bc-axis-y"></g>\n\n        <svg class="vzb-bc-bars-crop">\n            <g class="vzb-bc-bars"></g>\n        </svg>\n        \n        <svg class="vzb-bc-locked-crop">\n            <g class="vzb-bc-paths"></g>\n        </svg>\n\n        <g class="vzb-bc-axis-x"></g>\n        <g class="vzb-bc-axis-x vzb-bc-axis-x-left"></g>\n\n        <svg class="vzb-bc-labels-crop">\n            <g class="vzb-bc-labels"></g>\n        </svg>\n\n        <g class="vzb-bc-axis-labels">\n            \x3c!-- <text class="vzb-x_label">Lifespan</text>\n                  <text class="vzb-y_label">Lifespan</text> --\x3e\n        </g>\n    </g>\n</svg>\n'},function(e,t,i){e.exports=i(0)}]);
//# sourceMappingURL=popbyage.js.map